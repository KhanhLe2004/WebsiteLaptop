@startuml

hide footbox
skinparam defaultFontName Helvetica
skinparam defaultFontSize 12
skinparam maxMessageSize 500
skinparam ParticipantPadding 100

skinparam backgroundColor white
skinparam shadowing false
skinparam ActorBackgroundColor transparent
skinparam ParticipantBackgroundColor transparent
skinparam SequenceGroupBackgroundColor transparent
skinparam SequenceBoxBackgroundColor transparent
skinparam NoteBackgroundColor transparent

skinparam SequenceActivationBorderColor black
skinparam ActorBorderColor black
skinparam ParticipantBorderColor black
skinparam ArrowColor black
skinparam roundcorner 0

actor "Chủ cửa hàng" as OWNER
participant "Frontend (Admin Web)" as FE
participant "ManageCustomerAPIController" as API
participant "Address API" as ADDR_API
database "Database" as DB

' 1) Mở màn quản lý
OWNER -> FE : Chọn "Quản lý khách hàng"
FE -> API : GET /api/admin/customers
API -> DB : SELECT customers (filter, pagination)
DB --> API : customerList
API --> FE : 200 OK + list
FE --> OWNER : Hiển thị danh sách

' 2) Thao tác: Thêm / Sửa / Xóa(ẩn)
alt Thêm khách hàng
  OWNER -> FE : Nhập thông tin\nNhấn "Lưu"
  FE -> API : POST /api/admin/customers
  API -> API : Validate + Check username/email exists
  alt Hợp lệ
    API -> API : GenerateCustomerId()
    opt Có ProvinceCode
      API -> ADDR_API : GET /provinces (lấy tên tỉnh)
      ADDR_API --> API : provinceName
    end
    opt Có CommuneCode
      API -> ADDR_API : GET /provinces/{code}/communes (lấy tên phường)
      ADDR_API --> API : communeName
    end
    opt Có ảnh
      API -> API : SaveImageAsync(AvatarFile)  (lưu file)
    end
    API -> API : BuildFullAddress + SerializeAddress
    API -> DB : INSERT Customers
    API -> API : LogHistory("Thêm khách hàng")
    API --> FE : 201 Created + CustomerDTO
    FE --> OWNER : Thông báo "Thành công"\nReload
  else Không hợp lệ
    API --> FE : 400 + errors
    FE --> OWNER : "Vui lòng nhập lại"
  end

else Cập nhật khách hàng
  OWNER -> FE : Chọn khách hàng\nSửa\nNhấn "Lưu"
  FE -> API : PUT /api/admin/customers/{id}
  API -> DB : SELECT customer WHERE id
  API -> API : Validate + Check username/email exists
  alt Hợp lệ
    opt Có ảnh mới
      API -> API : DeleteImage(oldAvatar)
      API -> API : SaveImageAsync(newAvatarFile)
    end
    opt Xóa ảnh
      API -> API : DeleteImage(avatar)
    end
    opt Có ProvinceCode
      API -> ADDR_API : GET /provinces (lấy tên tỉnh)
      ADDR_API --> API : provinceName
    end
    opt Có CommuneCode
      API -> ADDR_API : GET /provinces/{code}/communes (lấy tên phường)
      ADDR_API --> API : communeName
    end
    API -> API : BuildFullAddress + SerializeAddress
    API -> DB : UPDATE Customers
    API -> API : LogHistory("Sửa khách hàng")
    API --> FE : 200 OK
    FE --> OWNER : "Thành công"\nReload
  else Không hợp lệ
    API --> FE : 400 + errors
    FE --> OWNER : "Vui lòng nhập lại"
  end

else Xóa khách hàng (Ẩn)
  OWNER -> FE : Chọn Delete
  FE -> API : DELETE /api/admin/customers/{id}
  activate API
  API -> DB : SELECT customer by id
  API -> DB : UPDATE Customers SET Active=0
  API -> API : LogHistory("Hide")
  API --> FE : 200 OK
  deactivate API
end

FE --> OWNER : Hiển thị danh sách

@enduml

