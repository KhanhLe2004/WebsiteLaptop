@startuml

hide footbox
skinparam defaultFontName Helvetica
skinparam defaultFontSize 12
skinparam maxMessageSize 500
skinparam ParticipantPadding 100

skinparam backgroundColor white
skinparam shadowing false
skinparam ActorBackgroundColor transparent
skinparam ParticipantBackgroundColor transparent
skinparam SequenceGroupBackgroundColor transparent
skinparam SequenceBoxBackgroundColor transparent
skinparam NoteBackgroundColor transparent

skinparam SequenceActivationBorderColor black
skinparam ActorBorderColor black
skinparam ParticipantBorderColor black
skinparam ArrowColor black
skinparam roundcorner 0

actor "Khách hàng" as CUSTOMER
participant "Frontend (User Web)" as FE
participant "CheckoutAPIController" as API
participant "CartAPIController" as CART_API
participant "VNPay Service" as VNPAY
participant "EmailService" as EMAIL
database "Database" as DB

' 1) Kiểm tra số lượng tồn kho
CUSTOMER -> FE : Chọn sản phẩm để thanh toán\nNhấn "Thanh toán"
FE -> CART_API : POST /api/Cart/check-stock
CART_API -> DB : SELECT cart WHERE CustomerId (Include CartDetails.Product)
CART_API -> API : Check stock for each selected CartDetail
alt Có sản phẩm không đủ số lượng
  CART_API --> FE : 400 Bad Request + outOfStockItems
  FE --> CUSTOMER : "Sản phẩm không đủ số lượng"
else Tất cả đều đủ số lượng
  CART_API --> FE : 200 OK ("Tất cả sản phẩm đều đủ số lượng")
  FE --> CUSTOMER : Redirect to Checkout page
end

' 2) Lấy danh sách khuyến mại
CUSTOMER -> FE : Mở trang Checkout
FE -> API : GET /api/Checkout/promotions?customerId&selectedCartDetailIds
API -> API : Validate customerId not empty
API -> DB : SELECT cart WHERE CustomerId (Include CartDetails.Product)
API -> API : Filter selectedCartDetailIds
API -> DB : SELECT promotions WHERE ProductId IN (selectedProductIds)
API -> API : Classify promotions (discount vs freeship)
API -> API : ExtractDiscountPercent from ContentDetail
API --> FE : 200 OK + (discountPromotions, freeshipPromotions)
FE --> CUSTOMER : Hiển thị danh sách khuyến mại

' 3) Áp dụng khuyến mại
opt Áp dụng khuyến mại
  CUSTOMER -> FE : Chọn khuyến mại\nNhấn "Áp dụng"
  FE -> API : POST /api/Checkout/apply-promotion
  API -> API : Validate (CustomerId, selectedPromotions not empty)
  API -> DB : SELECT cart WHERE CustomerId (Include CartDetails.Product)
  API -> DB : SELECT promotions WHERE PromotionId IN (selectedPromotions)
  loop For each CartDetail
    API -> API : Calculate originalSubtotal (price * quantity)
    opt Có discountPromotion cho sản phẩm
      API -> API : ExtractDiscountPercent
      API -> API : Calculate discountedPrice = price * (1 - discountPercent/100)
      API -> API : Calculate discountAmount
      API -> API : Add to discountedSubtotal
    else Không có discountPromotion
      API -> API : Add to discountedSubtotal (no discount)
    end
    opt Có freeshipPromotion cho sản phẩm
      API -> API : Set hasFreeship = true, finalDeliveryFee = 0
    end
  end
  API -> API : Calculate discount = originalSubtotal - discountedSubtotal
  API -> API : Calculate shippingDiscount = deliveryFee - finalDeliveryFee
  API -> API : Calculate finalTotal = discountedSubtotal + finalDeliveryFee
  API --> FE : 200 OK + (discount, shippingDiscount, finalTotal, promotionDetails)
  FE --> CUSTOMER : Hiển thị tổng tiền sau khuyến mại
end

' 4) Tạo đơn hàng
CUSTOMER -> FE : Nhập thông tin giao hàng\nChọn phương thức thanh toán\nNhấn "Đặt hàng"
FE -> API : POST /api/Checkout/create
API -> API : Validate (CustomerId, FullName, Phone, Email, DeliveryAddress not empty)
API -> API : Validate Email format (regex)
API -> API : Validate Phone format (regex, 9-15 digits)
API -> DB : SELECT customer WHERE CustomerId
API -> DB : SELECT cart WHERE CustomerId (Include CartDetails.Product)
API -> API : Filter selectedCartDetailIds
loop For each CartDetail
  API -> API : Calculate originalSubtotal (price * quantity)
  opt Có discountPromotion
    API -> API : ExtractDiscountPercent, Calculate discountedPrice
    API -> API : Add to finalSubtotal
  else Không có discountPromotion
    API -> API : Add to finalSubtotal
  end
end
API -> API : Calculate deliveryFee (apply freeship if selected)
API -> API : Calculate totalAmount = finalSubtotal + deliveryFee

alt PaymentMethod = "Chuyển khoản ngân hàng" (VNPay)
  API -> API : Generate tempOrderId (from DateTime.Ticks)
  API -> API : Generate txnRef = "{tempOrderId}_{customerId}"
  API -> API : Create PendingOrderWithTxnRef
  API -> API : Save to Session ("PendingOrder_{txnRef}")
  API -> VNPAY : CreatePaymentUrl (VnPaymentRequestModel, txnRef)
  VNPAY --> API : paymentUrl
  API --> FE : 200 OK + (paymentUrl, requiresPayment=true)
  FE --> CUSTOMER : Redirect to VNPay payment page
  CUSTOMER -> VNPAY : Thanh toán trên VNPay
  VNPAY -> API : GET /api/Checkout/vnpay-callback (query params)
  API -> VNPAY : PaymentExecute (validate signature)
  VNPAY --> API : VnPayResponse
  alt Payment thành công (ResponseCode="00")
    API -> API : Get pendingOrder from Session (by txnRef)
    API -> DB : SELECT cart WHERE CustomerId (Include CartDetails.Product)
    API -> API : CreateSaleInvoiceFromPendingOrder
    API -> API : GenerateSaleInvoiceId() (format SI001, SI002...)
    API -> DB : INSERT SaleInvoices (SaleInvoiceId, CustomerId, PaymentMethod, DeliveryAddress, DeliveryFee, TotalAmount, Discount, Status="Chờ xử lý", TimeCreate=Now, Phone)
    API -> API : CreateSaleInvoiceDetails
    loop For each CartDetail
      API -> API : Parse Specifications (format "CPU / RAM / ROM / Card")
      API -> API : GenerateSaleInvoiceDetailId() (format SID001, SID002...)
      API -> DB : INSERT SaleInvoiceDetails (SaleInvoiceDetailId, SaleInvoiceId, ProductId, Quantity, UnitPrice, Specifications)
    end
    API -> DB : SaveChanges
    API -> DB : DELETE CartDetails (selected items)
    API -> DB : DELETE Carts (if no remaining CartDetails)
    API -> API : Remove from Session
    API -> EMAIL : SendOrderConfirmationEmailAsync (async, non-blocking)
    EMAIL -> EMAIL : Send email
    API --> FE : Redirect to Account page (success)
    FE --> CUSTOMER : "Đặt hàng thành công!"
  else Payment thất bại
    API -> API : GetVnPayErrorMessage(errorCode)
    API --> FE : Redirect to Checkout page (error)
    FE --> CUSTOMER : "Thanh toán thất bại"
  end

else PaymentMethod = "Thanh toán khi nhận hàng" (COD)
  API -> API : CreateSaleInvoiceFromCart
  API -> API : GenerateSaleInvoiceId() (format SI001, SI002...)
  API -> DB : INSERT SaleInvoices (SaleInvoiceId, CustomerId, PaymentMethod="Thanh toán khi nhận hàng", DeliveryAddress, DeliveryFee, TotalAmount, Discount, Status="Chờ xử lý", TimeCreate=Now, Phone)
  API -> API : CreateSaleInvoiceDetails
  loop For each CartDetail
    API -> API : Parse Specifications (format "CPU / RAM / ROM / Card")
    API -> API : GenerateSaleInvoiceDetailId() (format SID001, SID002...)
    API -> DB : INSERT SaleInvoiceDetails (SaleInvoiceDetailId, SaleInvoiceId, ProductId, Quantity, UnitPrice, Specifications)
  end
  API -> DB : SaveChanges
  API -> DB : DELETE CartDetails (selected items)
  API -> DB : DELETE Carts (if no remaining CartDetails)
  API -> EMAIL : SendOrderConfirmationEmailAsync (async, non-blocking)
  EMAIL -> EMAIL : Send email
  API --> FE : 200 OK + (orderId, totalAmount, requiresPayment=false)
  FE --> CUSTOMER : "Đặt hàng thành công!"\nRedirect to Account
end

FE --> CUSTOMER : Hiển thị kết quả

@enduml

