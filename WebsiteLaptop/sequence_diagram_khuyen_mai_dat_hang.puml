@startuml

hide footbox
skinparam defaultFontName Helvetica
skinparam defaultFontSize 12
skinparam maxMessageSize 500
skinparam ParticipantPadding 100

skinparam backgroundColor white
skinparam shadowing false
skinparam ActorBackgroundColor transparent
skinparam ParticipantBackgroundColor transparent
skinparam SequenceGroupBackgroundColor transparent
skinparam SequenceBoxBackgroundColor transparent
skinparam NoteBackgroundColor transparent

skinparam SequenceActivationBorderColor black
skinparam ActorBorderColor black
skinparam ParticipantBorderColor black
skinparam ArrowColor black
skinparam roundcorner 0

actor "Khách hàng" as CUSTOMER
participant "Frontend (User Web)" as FE
participant "CheckoutAPIController" as API
database "Database" as DB

CUSTOMER -> FE : Mở trang Checkout
FE -> API : GET /api/Checkout/promotions?customerId&selectedCartDetailIds
API -> API : Validate customerId not empty
API -> DB : SELECT cart WHERE CustomerId (Include CartDetails.Product)
API -> API : Filter selectedCartDetailIds
API -> DB : SELECT promotions WHERE ProductId IN (selectedProductIds)
API -> API : Classify promotions (discount vs freeship)
API -> API : ExtractDiscountPercent from ContentDetail
API --> FE : 200 OK + (discountPromotions, freeshipPromotions)
FE --> CUSTOMER : Hiển thị danh sách khuyến mại

opt Áp dụng khuyến mại
  CUSTOMER -> FE : Chọn khuyến mại\nNhấn "Áp dụng"
  FE -> API : POST /api/Checkout/apply-promotion
  API -> API : Validate (CustomerId, selectedPromotions not empty)
  API -> DB : SELECT cart WHERE CustomerId (Include CartDetails.Product)
  API -> DB : SELECT promotions WHERE PromotionId IN (selectedPromotions)
  loop For each CartDetail
    API -> API : Calculate originalSubtotal (price * quantity)
    opt Có discountPromotion cho sản phẩm
      API -> API : ExtractDiscountPercent
      API -> API : Calculate discountedPrice = price * (1 - discountPercent/100)
      API -> API : Calculate discountAmount
      API -> API : Add to discountedSubtotal
    else Không có discountPromotion
      API -> API : Add to discountedSubtotal (no discount)
    end
    opt Có freeshipPromotion cho sản phẩm
      API -> API : Set hasFreeship = true, finalDeliveryFee = 0
    end
  end
  API -> API : Calculate discount = originalSubtotal - discountedSubtotal
  API -> API : Calculate shippingDiscount = deliveryFee - finalDeliveryFee
  API -> API : Calculate finalTotal = discountedSubtotal + finalDeliveryFee
  API --> FE : 200 OK + (discount, shippingDiscount, finalTotal, promotionDetails)
  FE --> CUSTOMER : Hiển thị tổng tiền sau khuyến mại
end

FE --> CUSTOMER : Hiển thị thông tin khuyến mại

@enduml

