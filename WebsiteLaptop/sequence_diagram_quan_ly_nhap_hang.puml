@startuml

hide footbox
skinparam defaultFontName Helvetica
skinparam defaultFontSize 12
skinparam maxMessageSize 500
skinparam ParticipantPadding 100

skinparam backgroundColor white
skinparam shadowing false
skinparam ActorBackgroundColor transparent
skinparam ParticipantBackgroundColor transparent
skinparam SequenceGroupBackgroundColor transparent
skinparam SequenceBoxBackgroundColor transparent
skinparam NoteBackgroundColor transparent

skinparam SequenceActivationBorderColor black
skinparam ActorBorderColor black
skinparam ParticipantBorderColor black
skinparam ArrowColor black
skinparam roundcorner 0

actor "Chủ cửa hàng" as OWNER
participant "Frontend (Admin Web)" as FE
participant "ManageStockImportAPIController" as API
database "Database" as DB

' 1) Mở màn quản lý
OWNER -> FE : Chọn "Quản lý nhập hàng"
FE -> API : GET /api/admin/stock-imports
API -> DB : SELECT stockImports (Include Supplier, Employee, filter, pagination)
DB --> API : stockImportList
API --> FE : 200 OK + list
FE --> OWNER : Hiển thị danh sách

' 2) Thao tác: Thêm / Sửa
alt Thêm phiếu nhập hàng
  OWNER -> FE : Nhập thông tin\nNhấn "Lưu"
  FE -> API : POST /api/admin/stock-imports
  API -> API : Validate + GenerateStockImportId()
  alt Hợp lệ
    API -> API : CalculateTotalAmount(details)
    API -> DB : INSERT StockImports
    loop For each detail
      API -> DB : INSERT StockImportDetails
      API -> API : ParseSpecifications + Find ProductConfiguration
      API -> DB : UPDATE ProductConfigurations SET Quantity += importQuantity
      API -> API : CreateProductSerials (for each unit)
      API -> DB : INSERT ProductSerials (quantity times)
    end
    API -> API : LogHistory("Thêm phiếu nhập hàng")
    API --> FE : 201 Created + StockImportDTO
    FE --> OWNER : Thông báo "Thành công"\nReload
  else Không hợp lệ
    API --> FE : 400 + errors
    FE --> OWNER : "Vui lòng nhập lại"
  end

else Cập nhật phiếu nhập hàng
  OWNER -> FE : Chọn phiếu nhập\nSửa\nNhấn "Lưu"
  FE -> API : PUT /api/admin/stock-imports/{id}
  API -> DB : SELECT stockImport WHERE id (Include Details)
  API -> API : Validate
  alt Hợp lệ
    loop For each old detail
      API -> API : DeleteProductSerials (by ProductId, Specifications, ImportDate)
      API -> DB : DELETE ProductSerials (in stock only)
      API -> API : ParseSpecifications + Find ProductConfiguration
      API -> DB : UPDATE ProductConfigurations SET Quantity -= oldQuantity
    end
    API -> DB : DELETE StockImportDetails (old)
    API -> API : CalculateTotalAmount(newDetails)
    loop For each new detail
      API -> DB : INSERT StockImportDetails
      API -> API : ParseSpecifications + Find ProductConfiguration
      API -> DB : UPDATE ProductConfigurations SET Quantity += newQuantity
      API -> API : CreateProductSerials (for each unit)
      API -> DB : INSERT ProductSerials (quantity times)
    end
    API -> DB : UPDATE StockImports
    API -> API : LogHistory("Cập nhật phiếu nhập hàng")
    API --> FE : 200 OK
    FE --> OWNER : "Thành công"\nReload
  else Không hợp lệ
    API --> FE : 400 + errors
    FE --> OWNER : "Vui lòng nhập lại"
  end
end

FE --> OWNER : Hiển thị danh sách

@enduml

