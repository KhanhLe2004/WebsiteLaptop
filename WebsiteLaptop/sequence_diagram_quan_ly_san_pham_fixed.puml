@startuml
hide footbox
skinparam defaultFontName Helvetica
skinparam defaultFontSize 12
skinparam maxMessageSize 500
skinparam ParticipantPadding 100

skinparam backgroundColor white
skinparam shadowing false
skinparam ActorBackgroundColor transparent
skinparam ParticipantBackgroundColor transparent
skinparam SequenceGroupBackgroundColor transparent
skinparam SequenceBoxBackgroundColor transparent
skinparam NoteBackgroundColor transparent

skinparam SequenceActivationBorderColor black
skinparam ActorBorderColor black
skinparam ParticipantBorderColor black
skinparam ArrowColor black
skinparam roundcorner 0


actor "Chủ cửa hàng" as OWNER
participant "Frontend (Admin Web)" as FE
participant "ManageProductAPIController" as API
database "Database" as DB

' 1) Mở màn quản lý
OWNER -> FE : Chọn "Quản lý sản phẩm"
FE -> API : GET /api/admin/products
API -> DB : SELECT products 
DB --> API : productList
API --> FE : 200 OK + list
FE --> OWNER : Hiển thị danh sách

' 2) Thao tác: Thêm / Sửa / Xóa(ẩn)
alt Thêm sản phẩm
  OWNER -> FE : Nhập thông tin\nNhấn "Lưu"
  FE -> API : POST /api/admin/products
  API -> API : Validate + GenerateNextProductId()
  alt Hợp lệ
    API -> DB : INSERT Products
    opt Có cấu hình
      API -> DB : UPSERT ProductConfigurations
    end
    opt Có ảnh
      API -> API : SaveImageAsync(...)  (lưu file)
      API -> DB : INSERT ProductImages
    end
    API -> API : LogHistory("Thêm sản phẩm")
    API --> FE : 201 Created + ProductDTO
    FE --> OWNER : Thông báo "Thành công"\nReload
  else Không hợp lệ
    API --> FE : 400 + errors
    FE --> OWNER : "Vui lòng nhập lại"
  end

else Cập nhật sản phẩm
  OWNER -> FE : Chọn sản phẩm\nSửa\nNhấn "Lưu"
  FE -> API : PUT /api/admin/products/{id}
  API -> DB : SELECT product WHERE id
  API -> API : Validate(updateData)
  alt Hợp lệ
    API -> DB : UPDATE Products
    opt Xóa cấu hình
      API -> DB : DELETE ProductConfigurations (ids)
    end
    opt Thêm/Cập nhật cấu hình
      API -> DB : UPSERT ProductConfigurations
    end
    opt Xóa ảnh
      API -> API : DeleteImage(ids)
      API -> DB : DELETE ProductImages (ids)
    end
    opt Thêm ảnh mới
      API -> API : SaveImageAsync(...)  (ADD mới)
      API -> DB : INSERT ProductImages
    end
    API -> API : LogHistory("Sửa sản phẩm")
    API --> FE : 200 OK
    FE --> OWNER : "Thành công"\nReload
  else Không hợp lệ
    API --> FE : 400 + errors
    FE --> OWNER : "Vui lòng nhập lại"
  end

else Xóa sản phẩm (Ẩn)
  OWNER -> FE : Chọn Delete
  FE -> API : DELETE /api/admin/products/{id}
  activate API
  API -> DB : SELECT product by id
  API -> DB : UPDATE Products SET Active=0
  API -> API : LogHistory("Hide")
  API --> FE : 200 OK
  deactivate API
end

FE --> OWNER : Hiển thị danh sách
@enduml
