@startuml

hide footbox
skinparam defaultFontName Helvetica
skinparam defaultFontSize 12
skinparam maxMessageSize 500
skinparam ParticipantPadding 100

skinparam backgroundColor white
skinparam shadowing false
skinparam ActorBackgroundColor transparent
skinparam ParticipantBackgroundColor transparent
skinparam SequenceGroupBackgroundColor transparent
skinparam SequenceBoxBackgroundColor transparent
skinparam NoteBackgroundColor transparent

skinparam SequenceActivationBorderColor black
skinparam ActorBorderColor black
skinparam ParticipantBorderColor black
skinparam ArrowColor black
skinparam roundcorner 0

actor "Chủ cửa hàng" as OWNER
participant "Frontend (Admin Web)" as FE
participant "ChatAPIController" as API
participant "SignalR Hub" as HUB
database "Database" as DB

' 1) Mở màn quản lý
OWNER -> FE : Chọn "Tư vấn hỗ trợ"
FE -> API : GET /api/Chat/GetConversations/Employee?employeeId
API -> DB : SELECT chats (get assigned + unassigned customerIds)
API -> DB : SELECT chats (get lastMessage, unreadCount for each customer)
DB --> API : conversationsList
API --> FE : 200 OK + list
FE --> OWNER : Hiển thị danh sách khách hàng

' 2) Chọn khách hàng để chat
OWNER -> FE : Chọn khách hàng
FE -> API : GET /api/Chat/GetMessages?customerId&employeeId
API -> DB : SELECT chats WHERE customerId AND (employeeId=null OR employeeId=employeeId) (Include Customer, Employee)
DB --> API : messagesList
API --> FE : 200 OK + messages
FE --> OWNER : Hiển thị tin nhắn

' 3) Gửi tin nhắn
OWNER -> FE : Nhập tin nhắn\nNhấn "Gửi"
FE -> HUB : SendMessage(customerId, employeeId, content)
HUB -> DB : INSERT Chats (SenderType="employee", Status="sent")
HUB -> HUB : Broadcast to customer (SignalR)
HUB --> FE : Message sent
FE --> OWNER : Hiển thị tin nhắn đã gửi

' 4) Đánh dấu đã đọc
OWNER -> FE : Mở cuộc trò chuyện
FE -> API : POST /api/Chat/MarkAsRead (customerId, employeeId)
API -> DB : UPDATE Chats SET Status="read" WHERE customerId AND Status="sent" AND SenderType="customer"
API --> FE : 200 OK
FE --> OWNER : Cập nhật unreadCount

FE --> OWNER : Hiển thị danh sách

@enduml

