@startuml

hide footbox
skinparam defaultFontName Helvetica
skinparam defaultFontSize 12
skinparam maxMessageSize 500
skinparam ParticipantPadding 100

skinparam backgroundColor white
skinparam shadowing false
skinparam ActorBackgroundColor transparent
skinparam ParticipantBackgroundColor transparent
skinparam SequenceGroupBackgroundColor transparent
skinparam SequenceBoxBackgroundColor transparent
skinparam NoteBackgroundColor transparent

skinparam SequenceActivationBorderColor black
skinparam ActorBorderColor black
skinparam ParticipantBorderColor black
skinparam ArrowColor black
skinparam roundcorner 0

actor "Khách hàng" as CUSTOMER
participant "Frontend (User Web)" as FE
participant "CartAPIController" as API
database "Database" as DB

CUSTOMER -> FE : Chọn sản phẩm để thanh toán\nNhấn "Thanh toán"
FE -> API : POST /api/Cart/check-stock
API -> API : Validate (CustomerId, CartDetailIds not empty)
API -> DB : SELECT cart WHERE CustomerId (Include CartDetails.Product)
loop For each selected CartDetail
  API -> API : Find ProductConfiguration (from Specifications)
  opt Có configuration
    API -> DB : SELECT saleInvoices WHERE Status IN ("Chờ xử lý", "Đang xử lý")
    API -> DB : SELECT saleInvoiceDetails WHERE ProductId AND Specifications match
    API -> API : Calculate orderedQuantity
    API -> API : Calculate availableQuantity = stockQuantity - orderedQuantity
    API -> API : Check cartQuantity <= availableQuantity
    alt Vượt quá số lượng có sẵn
      API -> API : Add to outOfStockItems
    end
  end
end
alt Có sản phẩm không đủ số lượng
  API --> FE : 400 Bad Request + outOfStockItems
  FE --> CUSTOMER : "Sản phẩm không đủ số lượng"
else Tất cả đều đủ số lượng
  API --> FE : 200 OK ("Tất cả sản phẩm đều đủ số lượng")
  FE --> CUSTOMER : Redirect to Checkout page
end

FE --> CUSTOMER : Hiển thị kết quả

@enduml

