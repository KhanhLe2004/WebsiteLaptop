@startuml

hide footbox
skinparam defaultFontName Helvetica
skinparam defaultFontSize 12
skinparam maxMessageSize 500
skinparam ParticipantPadding 100

skinparam backgroundColor white
skinparam shadowing false
skinparam ActorBackgroundColor transparent
skinparam ParticipantBackgroundColor transparent
skinparam SequenceGroupBackgroundColor transparent
skinparam SequenceBoxBackgroundColor transparent
skinparam NoteBackgroundColor transparent

skinparam SequenceActivationBorderColor black
skinparam ActorBorderColor black
skinparam ParticipantBorderColor black
skinparam ArrowColor black
skinparam roundcorner 0

actor "Khách hàng" as CUSTOMER
participant "Frontend (User Web)" as FE
participant "ListProductAPIController" as LIST_API
participant "ProductsController" as PROD_API
database "Database" as DB

' Tìm kiếm đơn giản
alt Tìm kiếm bằng keyword
  CUSTOMER -> FE : Nhập keyword\nNhấn "Tìm kiếm"
  FE -> LIST_API : GET /api/ListProductAPI/search?keyword&limit
  LIST_API -> LIST_API : Validate keyword not empty
  alt Keyword rỗng
    LIST_API --> FE : 200 OK + empty list
    FE --> CUSTOMER : Hiển thị "Không có kết quả"
  else Keyword hợp lệ
    LIST_API -> LIST_API : Trim + LowerCase keyword
    LIST_API -> DB : SELECT products WHERE Active=true AND (ProductName LIKE keyword OR ProductModel LIKE keyword OR BrandName LIKE keyword) (Include Brand, ProductConfigurations)
    LIST_API -> DB : ORDER BY ProductName, TAKE limit
    DB --> LIST_API : productsList
    LIST_API -> LIST_API : Extract Ram, Storage from ProductConfigurations (first value + unique options)
    LIST_API --> FE : 200 OK + products (with RamOptions, StorageOptions)
    FE --> CUSTOMER : Hiển thị danh sách sản phẩm
  end

else Tìm kiếm nâng cao với filters
  CUSTOMER -> FE : Chọn filters\n(Brand, Price, RAM, Storage)\nNhấn "Tìm kiếm"
  FE -> PROD_API : GET /api/products/shop/search?brandIds&productName&priceRanges&ramOptions&storageOptions&sortBy&page&pageSize
  PROD_API -> PROD_API : Parse filters (brandIds, productName, priceRanges, ramOptions, storageOptions)
  ' Build base query (Brand + ProductName + Price)
  PROD_API -> DB : SELECT products WHERE Active=true
  opt Có brandIds filter
    PROD_API -> DB : WHERE BrandId IN (brandIds)
  end
  opt Có productName filter
    PROD_API -> DB : WHERE ProductName LIKE productName
  end
  opt Có priceRanges filter
    PROD_API -> DB : SELECT products WHERE SellingPrice IN ranges
    PROD_API -> PROD_API : Get productIds matching price ranges
    PROD_API -> DB : WHERE ProductId IN (matchingIds)
  end
  PROD_API -> DB : Get productIdsFromProducts
  ' Build config query (RAM + Storage)
  opt Có ramOptions hoặc storageOptions filter
    PROD_API -> DB : SELECT productConfigurations
    opt Có ramOptions filter
      PROD_API -> DB : WHERE Ram IN (ramOptions) (normalize)
    end
    opt Có storageOptions filter
      PROD_API -> DB : WHERE Rom LIKE storageOptions (normalize, contains)
      PROD_API -> PROD_API : Get productIds matching storage
    end
    PROD_API -> DB : Get productIdsFromConfigs
  end
  ' Intersect productIds
  PROD_API -> PROD_API : finalProductIds = Intersect(productIdsFromProducts, productIdsFromConfigs)
  alt Không có filters nào
    PROD_API -> DB : SELECT all active products
  end
  ' Get final products
  PROD_API -> DB : SELECT products WHERE ProductId IN (finalProductIds) (Include Brand)
  PROD_API -> DB : SELECT productConfigurations WHERE ProductId IN (finalProductIds) (GROUP BY ProductId, MIN Price)
  PROD_API -> PROD_API : Calculate MinConfigPrice for each product
  PROD_API -> PROD_API : Sort by (price, price_desc, name)
  PROD_API -> PROD_API : Pagination (Skip, Take)
  PROD_API --> FE : 200 OK + (products, totalCount, page, pageSize, totalPages)
  FE --> CUSTOMER : Hiển thị danh sách sản phẩm (có phân trang)

else Lấy filters để hiển thị
  CUSTOMER -> FE : Mở trang Shop
  FE -> PROD_API : GET /api/products/shop/filters
  PROD_API -> DB : SELECT brands (ORDER BY BrandName)
  PROD_API -> DB : SELECT products WHERE Active=true (MIN, MAX SellingPrice)
  PROD_API -> DB : SELECT productConfigurations (DISTINCT Ram, ORDER BY capacity)
  PROD_API -> DB : SELECT productConfigurations (DISTINCT Rom, ORDER BY capacity)
  PROD_API -> PROD_API : ParseCapacityToGb (for sorting)
  PROD_API --> FE : 200 OK + (brands, priceRange, ramOptions, storageOptions)
  FE --> CUSTOMER : Hiển thị filters
end

@enduml

