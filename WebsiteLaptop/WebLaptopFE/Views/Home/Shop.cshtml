@{
    ViewData["Title"] = "Shop";
    Layout = "~/Views/Shared/_LayoutShop.cshtml";
}

<!-- Fruits Shop Start-->
<div class="container-fluid fruite py-5">
    <div class="container py-5">
        <h1 class="mb-4">Cửa hàng Laptop</h1>

        <div class="row g-4">
            <div class="col-6"></div>
            <div class="col-xl-3">
                <div class="bg-light ps-3 py-3 rounded d-flex justify-content-between mb-4">
                    <label for="sortSelect">Sắp xếp theo:</label>
                    <select id="sortSelect" name="sortSelect" class="border-0 form-select-sm bg-light me-3">
                        <option value="price">Giá tăng dần</option>
                        <option value="price_desc">Giá giảm dần</option>
                        <option value="name">Tên A-Z</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- SIDEBAR -->
            <div class="col-lg-3">
                <!-- shop-sidebar: sticky + internal scroll -->
                <div class="shop-sidebar bg-white p-3 rounded shadow-sm">
                    <div class="row g-4">
                        <!-- Brand Filter -->
                        <div class="col-lg-12">
                            <div class="mb-3">
                                <h4>Hãng</h4>
                                <ul class="list-unstyled fruite-categorie" id="brandFilter">
                                    <!-- Brands will be loaded here -->
                                </ul>
                            </div>
                        </div>

                        <!-- Price Filter -->
                        <div class="col-lg-12">
                            <div class="mb-3">
                                <h4 class="mb-2">Mức giá</h4>
                                <ul class="list-unstyled fruite-categorie" id="priceFilter">
                                    <li>
                                        <div class="d-flex align-items-center mb-2">
                                            <input type="checkbox" class="form-check-input me-2 price-checkbox" id="price-under-10" value="under-10">
                                            <label for="price-under-10" class="mb-0">Dưới 10 triệu</label>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="d-flex align-items-center mb-2">
                                            <input type="checkbox" class="form-check-input me-2 price-checkbox" id="price-10-15" value="10-15">
                                            <label for="price-10-15" class="mb-0">Từ 10 - 15 triệu</label>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="d-flex align-items-center mb-2">
                                            <input type="checkbox" class="form-check-input me-2 price-checkbox" id="price-15-20" value="15-20">
                                            <label for="price-15-20" class="mb-0">Từ 15 - 20 triệu</label>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="d-flex align-items-center mb-2">
                                            <input type="checkbox" class="form-check-input me-2 price-checkbox" id="price-20-25" value="20-25">
                                            <label for="price-20-25" class="mb-0">Từ 20 - 25 triệu</label>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="d-flex align-items-center mb-2">
                                            <input type="checkbox" class="form-check-input me-2 price-checkbox" id="price-25-30" value="25-30">
                                            <label for="price-25-30" class="mb-0">Từ 25 - 30 triệu</label>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="d-flex align-items-center mb-2">
                                            <input type="checkbox" class="form-check-input me-2 price-checkbox" id="price-over-30" value="over-30">
                                            <label for="price-over-30" class="mb-0">Trên 30 triệu</label>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <!-- RAM Filter -->
                        <div class="col-lg-12">
                            <div class="mb-3">
                                <h4>RAM</h4>
                                <ul class="list-unstyled fruite-categorie" id="ramFilter">
                                    <!-- RAM options will be loaded here -->
                                </ul>
                            </div>
                        </div>

                        <!-- Storage Filter -->
                        <div class="col-lg-12">
                            <div class="mb-3">
                                <h4>Ổ cứng</h4>
                                <ul class="list-unstyled fruite-categorie" id="storageFilter">
                                    <!-- Storage options will be loaded here -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- .shop-sidebar end -->
            </div>

            <!-- PRODUCTS -->
            <div class="col-lg-9">
                <div class="row g-4 justify-content-center" id="productsContainer">
                    <!-- Products will be loaded here -->
                </div>

                <!-- Pagination (hidden by default - you said you don't want pagination; kept for fallback) -->
                <div class="pagination d-flex justify-content-center mt-5" id="paginationContainer" style="display:none;">
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Fruits Shop End-->

<!-- Inline CSS: do NOT create a Styles section (layout doesn't render it). -->
<style>
    /* Keep Bootstrap grid untouched. Only style the sidebar to be sticky and scrollable internally. */

    /* Make sidebar sticky and scrollable without changing grid widths */
    .shop-sidebar {
        position: sticky;
        top: 100px; /* adjust if header height differs */
        max-height: calc(100vh - 120px); /* viewport minus header margin */
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding-right: 8px;
        background: transparent;
    }

    /* Give inner container (the white rounded box) scrollable look */
    .shop-sidebar > .row {
        margin: 0;
    }

    /* Ensure product cards keep standard bootstrap widths */
    #productsContainer .fruite-item {
        height: 100%;
    }

    /* Make sure images inside product cards don't overflow */
    .fruite-img img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        display: block;
    }

    /* Small spacing for filters inside sidebar */
    .shop-sidebar h4 {
        font-size: 16px;
        margin-bottom: 12px;
    }

    /* Responsive: on small screens sidebar becomes normal stacked block */
    @@media (max-width: 991.98px) {
        .shop-sidebar {
            position: static;
            max-height: none;
            overflow: visible;
            margin-bottom: 18px;
            top: auto;
        }
    }

    /* Optional: subtle shadow / background for the inner filter card */
    .shop-sidebar {
        background: none;
    }
    .shop-sidebar .mb-3 > ul > li { margin-bottom: 6px; }
</style>

@section Scripts {
                <script>
                    // API base
                    const apiBase = "http://localhost:5068/";
                    const defaultProductImage = "/image/default-laptop.jpg";
                    const backendImageBase = apiBase + "image/";

                    function buildImageUrl(fileName) {
                        if (!fileName || typeof fileName !== "string" || !fileName.trim()) {
                            return defaultProductImage;
                        }
                        return backendImageBase + encodeURIComponent(fileName.trim());
                    }

                    function normalizeForApi(value) {
                        if (!value) return '';
                        return value.toString().trim().replace(/\s+/g, '').replace(/\//g, '').toUpperCase();
                    }

                    // filter state
                    let filters = {
                        brands: [],
                        priceRanges: [], // Array of {min, max} objects
                        ram: [],
                        storage: [],
                        sortBy: 'price',
                        page: 1,
                        // Set large pageSize so server returns all matched items (no client-side pagination)
                        pageSize: 100000
                    };

                    let priceRange = { min: 0, max: 0 };
                    let allBrands = [];
                    let allRamOptions = [];
                    let allStorageOptions = [];

                    // Initialize
                    $(document).ready(function() {
                        // Always prioritize sessionStorage (has most recent filters)
                        // Only use URL if sessionStorage is empty
                        restoreFiltersFromSessionStorage();
                        if (filters.brands.length === 0 && filters.priceRanges.length === 0 && 
                            filters.ram.length === 0 && filters.storage.length === 0) {
                            restoreFiltersFromURL();
                        }
                        
                        loadFilters();
                        
                        // Handle browser back/forward navigation
                        window.addEventListener('popstate', function(event) {
                            // Always prioritize sessionStorage (has most recent filters)
                            restoreFiltersFromSessionStorage();
                            if (filters.brands.length === 0 && filters.priceRanges.length === 0 && 
                                filters.ram.length === 0 && filters.storage.length === 0) {
                                restoreFiltersFromURL();
                            }
                            
                            restoreCheckboxStates();
                            loadProducts();
                        });
                        
                        // Save filters to sessionStorage before navigating away
                        window.addEventListener('beforeunload', function() {
                            saveFiltersToSessionStorage();
                        });
                        
                        // Attach price checkbox handler (delegated to handle dynamic inputs)
                        $(document).on('change', '.price-checkbox', function() {
                            updatePriceFromCheckboxes();
                            filters.page = 1;
                            saveFiltersToSessionStorage(); // Save filters when changed
                            loadProducts();
                        });

                        // sort change
                        $('#sortSelect').on('change', function() {
                            filters.sortBy = $(this).val();
                            filters.page = 1;
                            saveFiltersToSessionStorage(); // Save filters when changed
                            loadProducts();
                        });

                        // Delegated handlers for brand/ram/storage -- filter change triggers loadProducts
                        $(document).on('change', '.brand-checkbox', function() {
                            updateBrandFilters();
                        });
                        $(document).on('change', '.ram-checkbox', function() {
                            updateRamFilters();
                        });
                        $(document).on('change', '.storage-checkbox', function() {
                            updateStorageFilters();
                        });
                    });

                    // Load filter options from API
                    function loadFilters() {
                        $.ajax({
                            type: 'GET',
                            url: apiBase + "api/products/shop/filters",
                            dataType: 'json',
                            success: function(data) {
                                allBrands = data.brands || [];
                                priceRange = data.priceRange || { min: 0, max: 0 };
                                allRamOptions = data.ramOptions || [];
                                allStorageOptions = data.storageOptions || [];

                                renderBrandFilters();
                                renderRamFilters();
                                renderStorageFilters();

                                // Restore checkbox states from URL parameters
                                restoreCheckboxStates();

                                // load products with restored filters
                                loadProducts();
                            },
                            error: function(xhr, status, error) {
                                console.error('Error loading filters:', error);
                                // Restore checkbox states even if API fails
                                restoreCheckboxStates();
                                // fallback: still try loadProducts (will request all)
                                loadProducts();
                            }
                        });
                    }

                    // Render brand list
                    function renderBrandFilters() {
                        let html = '';
                        allBrands.forEach(function(brand) {
                            html += '<li>';
                            html += '  <div class="d-flex align-items-center mb-2">';
                            html += '    <input type="checkbox" class="form-check-input me-2 brand-checkbox" id="brand-' + brand.brandId + '" value="' + brand.brandId + '">';
                            html += '    <label for="brand-' + brand.brandId + '" class="mb-0">' + (brand.brandName || brand.brandId) + '</label>';
                            html += '  </div>';
                            html += '</li>';
                        });
                        $('#brandFilter').html(html);
                    }

                    // Render ram list
                    function renderRamFilters() {
                        let html = '';
                        allRamOptions.forEach(function(ram) {
                            let id = 'ram-' + ram.replace(/\s/g, '-');
                            html += '<li>';
                            html += '  <div class="d-flex align-items-center mb-2">';
                            html += '    <input type="checkbox" class="form-check-input me-2 ram-checkbox" id="' + id + '" value="' + ram + '">';
                            html += '    <label for="' + id + '" class="mb-0">' + ram + '</label>';
                            html += '  </div>';
                            html += '</li>';
                        });
                        $('#ramFilter').html(html);
                    }

                    // Render storage list
                    function renderStorageFilters() {
                        let html = '';
                        allStorageOptions.forEach(function(storage) {
                            let id = 'storage-' + storage.replace(/\s/g, '-').replace(/\//g, '-');
                            html += '<li>';
                            html += '  <div class="d-flex align-items-center mb-2">';
                            html += '    <input type="checkbox" class="form-check-input me-2 storage-checkbox" id="' + id + '" value="' + storage + '">';
                            html += '    <label for="' + id + '" class="mb-0">' + storage + '</label>';
                            html += '  </div>';
                            html += '</li>';
                        });
                        $('#storageFilter').html(html);
                    }

                    // Update brand filters
                    function updateBrandFilters() {
                        filters.brands = [];
                        $('.brand-checkbox:checked').each(function() {
                            filters.brands.push($(this).val());
                        });
                        filters.page = 1;
                        saveFiltersToSessionStorage(); // Save filters when changed
                        loadProducts();
                    }

                    // Update ram filters
                    function updateRamFilters() {
                        filters.ram = [];
                        $('.ram-checkbox:checked').each(function() {
                            filters.ram.push($(this).val());
                        });
                        filters.page = 1;
                        saveFiltersToSessionStorage(); // Save filters when changed
                        loadProducts();
                    }

                    // Update storage filters
                    function updateStorageFilters() {
                        filters.storage = [];
                        $('.storage-checkbox:checked').each(function() {
                            // CHANGED: store normalized value to match server-side normalization logic
                            filters.storage.push(normalizeForApi($(this).val()));
                        });
                        filters.page = 1;
                        saveFiltersToSessionStorage(); // Save filters when changed
                        loadProducts();
                    }

                    // Update price ranges from checked boxes
                    function updatePriceFromCheckboxes() {
                        filters.priceRanges = [];

                        $('.price-checkbox:checked').each(function() {
                            let v = $(this).val();
                            if (v === 'under-10') {
                                filters.priceRanges.push({ min: 0, max: 10000000 });
                            } else if (v === '10-15') {
                                filters.priceRanges.push({ min: 10000000, max: 15000000 });
                            } else if (v === '15-20') {
                                filters.priceRanges.push({ min: 15000000, max: 20000000 });
                            } else if (v === '20-25') {
                                filters.priceRanges.push({ min: 20000000, max: 25000000 });
                            } else if (v === '25-30') {
                                filters.priceRanges.push({ min: 25000000, max: 30000000 });
                            } else if (v === 'over-30') {
                                filters.priceRanges.push({ min: 30000000, max: 1000000000 }); // Use large number for max
                            }
                        });
                    }

                    // Save filters to sessionStorage
                    function saveFiltersToSessionStorage() {
                        try {
                            sessionStorage.setItem('shopFilters', JSON.stringify(filters));
                        } catch (e) {
                            console.error('Error saving filters to sessionStorage:', e);
                        }
                    }

                    // Restore filters from sessionStorage
                    function restoreFiltersFromSessionStorage() {
                        try {
                            const savedFilters = sessionStorage.getItem('shopFilters');
                            if (savedFilters) {
                                const parsed = JSON.parse(savedFilters);
                                if (parsed) {
                                    // Reset filters first
                                    filters.brands = [];
                                    filters.priceRanges = [];
                                    filters.ram = [];
                                    filters.storage = [];
                                    filters.sortBy = 'price';
                                    
                                    // Restore from sessionStorage
                                    filters.brands = parsed.brands || [];
                                    filters.priceRanges = parsed.priceRanges || [];
                                    filters.ram = parsed.ram || [];
                                    filters.storage = parsed.storage || [];
                                    filters.sortBy = parsed.sortBy || 'price';
                                }
                            }
                        } catch (e) {
                            console.error('Error restoring filters from sessionStorage:', e);
                        }
                    }

                    // Save filters to URL parameters (not used for filter changes, only for ProductDetail links)
                    function saveFiltersToURL() {
                        const urlParams = new URLSearchParams();
                        
                        if (filters.brands.length > 0) {
                            urlParams.set('brands', filters.brands.join(','));
                        }
                        
                        if (filters.priceRanges.length > 0) {
                            const priceRangesStr = filters.priceRanges.map(r => {
                                const min = r.min || 0;
                                const max = (r.max === null || r.max === undefined) ? 1000000000 : r.max;
                                return min + '-' + max;
                            }).join(',');
                            urlParams.set('priceRanges', priceRangesStr);
                        }
                        
                        if (filters.ram.length > 0) {
                            urlParams.set('ram', filters.ram.join(','));
                        }
                        
                        if (filters.storage.length > 0) {
                            urlParams.set('storage', filters.storage.join(','));
                        }
                        
                        if (filters.sortBy && filters.sortBy !== 'price') {
                            urlParams.set('sortBy', filters.sortBy);
                        }
                        
                        const newUrl = window.location.pathname + (urlParams.toString() ? ('?' + urlParams.toString()) : '');
                        window.history.replaceState({ filters: filters }, '', newUrl);
                    }

                    // Restore filters from URL parameters
                    function restoreFiltersFromURL() {
                        const urlParams = new URLSearchParams(window.location.search);
                        
                        // Reset filters first
                        filters.brands = [];
                        filters.priceRanges = [];
                        filters.ram = [];
                        filters.storage = [];
                        filters.sortBy = 'price';
                        
                        // Restore brands
                        const brandsParam = urlParams.get('brands');
                        if (brandsParam) {
                            filters.brands = brandsParam.split(',').filter(b => b);
                        }
                        
                        // Restore price ranges
                        const priceRangesParam = urlParams.get('priceRanges');
                        if (priceRangesParam) {
                            filters.priceRanges = [];
                            priceRangesParam.split(',').forEach(rangeStr => {
                                const parts = rangeStr.split('-');
                                if (parts.length === 2) {
                                    const min = parseInt(parts[0]);
                                    let max = parts[1] === '' ? 1000000000 : parseInt(parts[1]);
                                    if (isNaN(max)) max = 1000000000; // Default to large number if max is invalid
                                    if (!isNaN(min)) {
                                        filters.priceRanges.push({ min: min, max: max });
                                    }
                                }
                            });
                        }
                        
                        // Restore RAM
                        const ramParam = urlParams.get('ram');
                        if (ramParam) {
                            filters.ram = ramParam.split(',').filter(r => r);
                        }
                        
                        // Restore storage
                        const storageParam = urlParams.get('storage');
                        if (storageParam) {
                            filters.storage = storageParam.split(',').filter(s => s);
                        }
                        
                        // Restore sort
                        const sortByParam = urlParams.get('sortBy');
                        if (sortByParam) {
                            filters.sortBy = sortByParam;
                        }
                    }

                    // Restore checkbox states from filters
                    function restoreCheckboxStates() {
                        // Uncheck all brand checkboxes first
                        $('.brand-checkbox').prop('checked', false);
                        // Restore brand checkboxes
                        filters.brands.forEach(brandId => {
                            $('#brand-' + brandId).prop('checked', true);
                        });
                        
                        // Uncheck all price checkboxes first
                        $('.price-checkbox').prop('checked', false);
                        // Restore price checkboxes
                        filters.priceRanges.forEach(range => {
                            if (range.min === 0 && range.max === 10000000) {
                                $('#price-under-10').prop('checked', true);
                            } else if (range.min === 10000000 && range.max === 15000000) {
                                $('#price-10-15').prop('checked', true);
                            } else if (range.min === 15000000 && range.max === 20000000) {
                                $('#price-15-20').prop('checked', true);
                            } else if (range.min === 20000000 && range.max === 25000000) {
                                $('#price-20-25').prop('checked', true);
                            } else if (range.min === 25000000 && range.max === 30000000) {
                                $('#price-25-30').prop('checked', true);
                            } else if (range.min === 30000000 && (range.max === null || range.max === 1000000000 || range.max >= 1000000000)) {
                                $('#price-over-30').prop('checked', true);
                            }
                        });
                        
                        // Uncheck all RAM checkboxes first
                        $('.ram-checkbox').prop('checked', false);
                        // Restore RAM checkboxes
                        filters.ram.forEach(ram => {
                            const ramId = 'ram-' + ram.replace(/\s/g, '-');
                            $('#' + ramId).prop('checked', true);
                        });
                        
                        // Uncheck all storage checkboxes first
                        $('.storage-checkbox').prop('checked', false);
                        // Restore storage checkboxes
                        filters.storage.forEach(storage => {
                            // Need to find matching checkbox by comparing normalized values
                            $('.storage-checkbox').each(function() {
                                if (normalizeForApi($(this).val()) === storage) {
                                    $(this).prop('checked', true);
                                }
                            });
                        });
                        
                        // Restore sort select
                        if (filters.sortBy) {
                            $('#sortSelect').val(filters.sortBy);
                        }
                    }

                    // Build params and call API to load products
                    function loadProducts() {
                        let params = {
                            page: filters.page || 1,
                            pageSize: filters.pageSize || 100000,
                            sortBy: filters.sortBy || 'price'
                        };

                        if (filters.brands.length > 0) params.brandIds = filters.brands.join(',');
                        
                        // Build priceRanges parameter
                        if (filters.priceRanges.length > 0) {
                            const priceRangesStr = filters.priceRanges.map(r => {
                                // Ensure both min and max are valid numbers
                                const min = r.min || 0;
                                const max = (r.max === null || r.max === undefined) ? 1000000000 : r.max;
                                return min + '-' + max;
                            }).join(',');
                            params.priceRanges = priceRangesStr;
                        }

                        if (filters.ram.length > 0) {
                            const normalizedRam = filters.ram.map(normalizeForApi).filter(Boolean);
                            if (normalizedRam.length > 0) params.ramOptions = normalizedRam.join(',');
                        }

                        if (filters.storage.length > 0) {
                            const normalizedStorage = filters.storage.map(normalizeForApi).filter(Boolean);
                            if (normalizedStorage.length > 0) params.storageOptions = normalizedStorage.join(',');
                        }

                        $.ajax({
                            type: 'GET',
                            url: apiBase + "api/products/shop/search",
                            data: params,
                            dataType: 'json',
                            success: function(data) {
                                if (data && data.products) {
                                    renderProducts(data.products || []);
                                } else {
                                    console.error('Invalid response format:', data);
                                    $('#productsContainer').html('<div class="col-12"><p class="text-center">Không có sản phẩm nào.</p></div>');
                                }
                            },
                            error: function(xhr, status, error) {
                                console.error('Error loading products:', error);
                                console.error('Status:', status);
                                console.error('Response:', xhr.responseText);
                                // Show a friendly message inside products area (keeps sidebar visible)
                                let errText = 'Không thể tải sản phẩm. Vui lòng thử lại sau.';
                                try {
                                    if (xhr.responseJSON && xhr.responseJSON.message) {
                                        errText += ' — ' + xhr.responseJSON.message;
                                    }
                                } catch (e) {}
                                $('#productsContainer').html('<div class="col-12"><p class="text-center text-danger">' + errText + '</p></div>');
                            }
                        });
                    }

                    // Render product cards
                    function renderProducts(products) {
                        if (!products || products.length === 0) {
                            $('#productsContainer').html('<div class="col-12"><p class="text-center">Không có sản phẩm nào.</p></div>');
                            return;
                        }

                        let html = '';
                        products.forEach(function(product) {
                            const pid = product.productId || product.ProductId || '';
                            const pname = product.productName || product.ProductName || 'Chưa có tên';
                            const pmodel = product.productModel || product.ProductModel || '';
                            const avatar = buildImageUrl(product.avatar || product.Avatar);
                            const brandObj = product.brand || product.Brand || {};
                            const brandName = brandObj.brandName || brandObj.BrandName || 'Laptop';

                            // Prefer MinConfigPrice when available, otherwise use SellingPrice
                            let displayPrice = product.sellingPrice || product.SellingPrice || 0;

                            let price = 'Liên hệ';
                            let originalPrice = '';

                            if (displayPrice > 0) {
                                try {
                                    price = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(displayPrice);
                                } catch (e) {
                                    price = displayPrice.toString() + ' VND';
                                }
                            }

                            const originalVal = product.originalSellingPrice ?? product.OriginalSellingPrice;
                            if (originalVal && originalVal > displayPrice) {
                                try {
                                    originalPrice = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(originalVal);
                                    originalPrice = '<span class="text-muted text-decoration-line-through me-2" style="font-size: 0.9em;">' + originalPrice + '</span>';
                                } catch (e) {
                                    originalPrice = '<span class="text-muted text-decoration-line-through me-2" style="font-size: 0.9em;">' + originalVal + ' VND</span>';
                                }
                            }

                            // Save current filters to sessionStorage before navigating
                            saveFiltersToSessionStorage();
                            
                            // Build product detail URL with filter parameters
                            const urlParams = new URLSearchParams();
                            urlParams.set('id', pid);
                            
                            // Add filter parameters to preserve state when navigating back
                            if (filters.brands.length > 0) {
                                urlParams.set('brands', filters.brands.join(','));
                            }
                            if (filters.priceRanges.length > 0) {
                                const priceRangesStr = filters.priceRanges.map(r => {
                                    const min = r.min || 0;
                                    const max = (r.max === null || r.max === undefined) ? 1000000000 : r.max;
                                    return min + '-' + max;
                                }).join(',');
                                urlParams.set('priceRanges', priceRangesStr);
                            }
                            if (filters.ram.length > 0) {
                                urlParams.set('ram', filters.ram.join(','));
                            }
                            if (filters.storage.length > 0) {
                                urlParams.set('storage', filters.storage.join(','));
                            }
                            if (filters.sortBy && filters.sortBy !== 'price') {
                                urlParams.set('sortBy', filters.sortBy);
                            }
                            
                            const productDetailUrl = '/Home/ProductDetail?' + urlParams.toString();

                            html += '<div class="col-md-6 col-lg-6 col-xl-4">';
                            html += '  <div class="rounded position-relative fruite-item">';
                            html += '    <div class="fruite-img" style="cursor: pointer;" onclick="window.location.href=\'' + productDetailUrl + '\'">';
                            html += '      <img src="' + avatar + '" class="img-fluid w-100 rounded-top" alt="' + pname + '">';
                            html += '    </div>';
                            html += '    <div class="text-white bg-secondary px-3 py-1 rounded position-absolute" style="top: 10px; left: 10px;">' + brandName + '</div>';
                            html += '    <div class="p-4 border border-secondary border-top-0 rounded-bottom">';
                            html += '      <h4><a href="' + productDetailUrl + '" class="text-dark text-decoration-none">' + pname + '</a></h4>';
                            html += '      <p>' + pmodel + '</p>';
                            html += '      <div class="d-flex align-items-center flex-wrap gap-2 mb-3">';
                            html += '        ' + originalPrice;
                            html += '        <span class="text-dark fs-5 fw-bold mb-0">' + price + '</span>';
                            html += '      </div>';
                            html += '      <div class="d-flex gap-2">';
                            html += '        <a href="' + productDetailUrl + '" class="btn border border-secondary rounded-pill px-3 text-primary">';
                            html += '          <i class="fa fa-eye me-2 text-primary"></i> Xem chi tiết';
                            html += '        </a>';
                            html += '        <a href="#" class="btn border border-secondary rounded-pill px-3 text-primary" onclick="event.preventDefault(); toggleFavorite(\'' + pid + '\'); return false;" title="Thêm vào yêu thích">';
                            html += '          <i class="far fa-heart" id="heart-' + pid + '"></i>';
                            html += '        </a>';
                            html += '      </div>';
                            html += '    </div>';
                            html += '  </div>';
                            html += '</div>';
                        });

                        $('#productsContainer').html(html);
                    }

                    // Optional toggle favorite
                    function toggleFavorite(productId) {
                        if (!productId) return;
                        let heartIcon = $('#heart-' + productId);
                        if (heartIcon.hasClass('fas')) {
                            heartIcon.removeClass('fas text-danger').addClass('far');
                        } else {
                            heartIcon.removeClass('far').addClass('fas text-danger');
                        }
                    }
                </script>
}