@{
    ViewData["Title"] = "Shop";
    Layout = "~/Views/Shared/_LayoutShop.cshtml";
}

<!-- Fruits Shop Start-->
<div class="container-fluid fruite py-5">
    <div class="container py-5">
        <h1 class="mb-4">Cửa hàng Laptop</h1>

        <div class="row g-4">
            <div class="col-6"></div>
            <div class="col-xl-3">
                <div class="bg-light ps-3 py-3 rounded d-flex justify-content-between mb-4">
                    <label for="sortSelect">Sắp xếp theo:</label>
                    <select id="sortSelect" name="sortSelect" class="border-0 form-select-sm bg-light me-3">
                        <option value="price">Giá tăng dần</option>
                        <option value="price_desc">Giá giảm dần</option>
                        <option value="name">Tên A-Z</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- SIDEBAR -->
            <div class="col-lg-3">
                <!-- shop-sidebar: sticky + internal scroll -->
                <div class="shop-sidebar bg-white p-3 rounded shadow-sm">
                    <div class="row g-4">
                        <!-- Brand Filter -->
                        <div class="col-lg-12">
                            <div class="mb-3">
                                <h4>Hãng</h4>
                                <ul class="list-unstyled fruite-categorie" id="brandFilter">
                                    <!-- Brands will be loaded here -->
                                </ul>
                            </div>
                        </div>

                        <!-- Price Filter -->
                        <div class="col-lg-12">
                            <div class="mb-3">
                                <h4 class="mb-2">Mức giá</h4>
                                <ul class="list-unstyled fruite-categorie" id="priceFilter">
                                    <li>
                                        <div class="d-flex align-items-center mb-2">
                                            <input type="checkbox" class="form-check-input me-2 price-checkbox" id="price-all" value="all" checked>
                                            <label for="price-all" class="mb-0">Tất cả</label>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="d-flex align-items-center mb-2">
                                            <input type="checkbox" class="form-check-input me-2 price-checkbox" id="price-under-10" value="under-10">
                                            <label for="price-under-10" class="mb-0">Dưới 10 triệu</label>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="d-flex align-items-center mb-2">
                                            <input type="checkbox" class="form-check-input me-2 price-checkbox" id="price-10-15" value="10-15">
                                            <label for="price-10-15" class="mb-0">Từ 10 - 15 triệu</label>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="d-flex align-items-center mb-2">
                                            <input type="checkbox" class="form-check-input me-2 price-checkbox" id="price-15-20" value="15-20">
                                            <label for="price-15-20" class="mb-0">Từ 15 - 20 triệu</label>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="d-flex align-items-center mb-2">
                                            <input type="checkbox" class="form-check-input me-2 price-checkbox" id="price-20-25" value="20-25">
                                            <label for="price-20-25" class="mb-0">Từ 20 - 25 triệu</label>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="d-flex align-items-center mb-2">
                                            <input type="checkbox" class="form-check-input me-2 price-checkbox" id="price-25-30" value="25-30">
                                            <label for="price-25-30" class="mb-0">Từ 25 - 30 triệu</label>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="d-flex align-items-center mb-2">
                                            <input type="checkbox" class="form-check-input me-2 price-checkbox" id="price-over-30" value="over-30">
                                            <label for="price-over-30" class="mb-0">Trên 30 triệu</label>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <!-- RAM Filter -->
                        <div class="col-lg-12">
                            <div class="mb-3">
                                <h4>RAM</h4>
                                <ul class="list-unstyled fruite-categorie" id="ramFilter">
                                    <!-- RAM options will be loaded here -->
                                </ul>
                            </div>
                        </div>

                        <!-- Storage Filter -->
                        <div class="col-lg-12">
                            <div class="mb-3">
                                <h4>Ổ cứng</h4>
                                <ul class="list-unstyled fruite-categorie" id="storageFilter">
                                    <!-- Storage options will be loaded here -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- .shop-sidebar end -->
            </div>

            <!-- PRODUCTS -->
            <div class="col-lg-9">
                <div class="row g-4 justify-content-center" id="productsContainer">
                    <!-- Products will be loaded here -->
                </div>

                <!-- Pagination (hidden by default - you said you don't want pagination; kept for fallback) -->
                <div class="pagination d-flex justify-content-center mt-5" id="paginationContainer" style="display:none;">
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Fruits Shop End-->

<!-- Inline CSS: do NOT create a Styles section (layout doesn't render it). -->
<style>
    /* Keep Bootstrap grid untouched. Only style the sidebar to be sticky and scrollable internally */

    /* Make sidebar sticky and scrollable without changing grid widths */
    .shop-sidebar {
        position: sticky;
        top: 100px; /* adjust if header height differs */
        max-height: calc(100vh - 120px); /* viewport minus header margin */
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding-right: 8px;
        background: transparent;
    }

    /* Give inner container (the white rounded box) scrollable look */
    .shop-sidebar > .row {
        margin: 0;
    }

    /* Ensure product cards keep standard bootstrap widths */
    #productsContainer .fruite-item {
        height: 100%;
    }

    /* Make sure images inside product cards don't overflow */
    .fruite-img img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        display: block;
    }

    /* Small spacing for filters inside sidebar */
    .shop-sidebar h4 {
        font-size: 16px;
        margin-bottom: 12px;
    }

    /* Responsive: on small screens sidebar becomes normal stacked block */
    @@media (max-width: 991.98px) {
        .shop-sidebar {
            position: static;
            max-height: none;
            overflow: visible;
            margin-bottom: 18px;
            top: auto;
        }
    }

    /* Optional: subtle shadow / background for the inner filter card */
    .shop-sidebar {
        background: none;
    }
    .shop-sidebar .mb-3 > ul > li { margin-bottom: 6px; }
</style>

@section Scripts {
        <script>
            // API base
            let apiBase = "http://localhost:5068/";
            // filter state
            let filters = {
                brands: [],
                minPrice: null,
                maxPrice: null,
                ram: [],
                storage: [],
                sortBy: 'price',
                page: 1,
                pageSize: 12
            };

            let priceRange = { min: 0, max: 0 };
            let allBrands = [];
            let allRamOptions = [];
            let allStorageOptions = [];

            // normalize helper (remove spaces, uppercase)
            function normalizeForApi(s) {
                if (!s) return '';
                return s.toString().trim().replace(/\s+/g, '').replace(/\//g, '').toUpperCase();
            }

            // Initialize
            $(document).ready(function() {
                loadFilters();

                // price checkbox handler (delegated)
                $(document).on('change', '.price-checkbox', function() {
                    if ($(this).val() === 'all') {
                        if ($(this).is(':checked')) {
                            $('.price-checkbox').not(this).prop('checked', false);
                            filters.minPrice = null;
                            filters.maxPrice = null;
                        }
                    } else {
                        $('#price-all').prop('checked', false);
                        updatePriceFromCheckboxes();
                    }
                    filters.page = 1;
                    loadProducts();
                });

                // sort change
                $('#sortSelect').on('change', function() {
                    filters.sortBy = $(this).val();
                    filters.page = 1;
                    loadProducts();
                });

                // Delegated handlers for brand/ram/storage
                $(document).on('change', '.brand-checkbox', function() {
                    updateBrandFilters();
                });
                $(document).on('change', '.ram-checkbox', function() {
                    updateRamFilters();
                });
                $(document).on('change', '.storage-checkbox', function() {
                    updateStorageFilters();
                });
            });

            // Load filter options from API
            function loadFilters() {
                $.ajax({
                    type: 'GET',
                    url: apiBase + "api/products/shop/filters",
                    dataType: 'json',
                    success: function(data) {
                        allBrands = data.brands || [];
                        priceRange = data.priceRange || { min: 0, max: 0 };
                        allRamOptions = data.ramOptions || [];
                        allStorageOptions = data.storageOptions || [];

                        renderBrandFilters();
                        renderRamFilters();
                        renderStorageFilters();

                        // load initial products (no filters)
                        loadProducts();
                    },
                    error: function(xhr, status, error) {
                        console.error('Error loading filters:', error);
                        // fallback: still try loadProducts (will request all)
                        loadProducts();
                    }
                });
            }

            // Render brand list
            function renderBrandFilters() {
                let html = '';
                allBrands.forEach(function(brand) {
                    html += '<li>';
                    html += '  <div class="d-flex align-items-center mb-2">';
                    html += '    <input type="checkbox" class="form-check-input me-2 brand-checkbox" id="brand-' + brand.brandId + '" value="' + brand.brandId + '">';
                    html += '    <label for="brand-' + brand.brandId + '" class="mb-0">' + (brand.brandName || brand.brandId) + '</label>';
                    html += '  </div>';
                    html += '</li>';
                });
                $('#brandFilter').html(html);
            }

            // Render ram list
            function renderRamFilters() {
                let html = '';
                allRamOptions.forEach(function(ram) {
                    let id = 'ram-' + ram.replace(/\s/g, '-');
                    html += '<li>';
                    html += '  <div class="d-flex align-items-center mb-2">';
                    html += '    <input type="checkbox" class="form-check-input me-2 ram-checkbox" id="' + id + '" value="' + ram + '">';
                    html += '    <label for="' + id + '" class="mb-0">' + ram + '</label>';
                    html += '  </div>';
                    html += '</li>';
                });
                $('#ramFilter').html(html);
            }

            // Render storage list
            function renderStorageFilters() {
                let html = '';
                allStorageOptions.forEach(function(storage) {
                    let id = 'storage-' + storage.replace(/\s/g, '-').replace(/\//g, '-');
                    html += '<li>';
                    html += '  <div class="d-flex align-items-center mb-2">';
                    html += '    <input type="checkbox" class="form-check-input me-2 storage-checkbox" id="' + id + '" value="' + storage + '">';
                    html += '    <label for="' + id + '" class="mb-0">' + storage + '</label>';
                    html += '  </div>';
                    html += '</li>';
                });
                $('#storageFilter').html(html);
            }

            // Update brand filters
            function updateBrandFilters() {
                filters.brands = [];
                $('.brand-checkbox:checked').each(function() {
                    filters.brands.push($(this).val());
                });
                filters.page = 1;
                loadProducts();
            }

            // Update ram filters
            function updateRamFilters() {
                filters.ram = [];
                $('.ram-checkbox:checked').each(function() {
                    filters.ram.push($(this).val());
                });
                filters.page = 1;
                loadProducts();
            }

            // Update storage filters
            function updateStorageFilters() {
                filters.storage = [];
                $('.storage-checkbox:checked').each(function() {
                    filters.storage.push($(this).val());
                });
                filters.page = 1;
                loadProducts();
            }

            // Update min/max price from checked boxes
            function updatePriceFromCheckboxes() {
                filters.minPrice = null;
                filters.maxPrice = null;

                $('.price-checkbox:checked').each(function() {
                    let v = $(this).val();
                    if (v === 'under-10') {
                        filters.maxPrice = Math.min(filters.maxPrice || 10000000, 10000000);
                    } else if (v === '10-15') {
                        filters.minPrice = 10000000;
                        filters.maxPrice = 15000000;
                    } else if (v === '15-20') {
                        filters.minPrice = 15000000;
                        filters.maxPrice = 20000000;
                    } else if (v === '20-25') {
                        filters.minPrice = 20000000;
                        filters.maxPrice = 25000000;
                    } else if (v === '25-30') {
                        filters.minPrice = 25000000;
                        filters.maxPrice = 30000000;
                    } else if (v === 'over-30') {
                        filters.minPrice = 30000000;
                    }
                });
            }

            // Build params and call API to load products
            function loadProducts() {
                let params = {
                    page: filters.page,
                    pageSize: filters.pageSize,
                    sortBy: filters.sortBy
                };

                if (filters.brands.length > 0) params.brandIds = filters.brands.join(',');

                if (filters.minPrice) params.minPrice = filters.minPrice;
                if (filters.maxPrice) params.maxPrice = filters.maxPrice;

                // IMPORTANT: normalize ram and storage values to match server normalization
                if (filters.ram.length > 0) {
                    let normalizedRam = filters.ram.map(r => normalizeForApi(r)).filter(Boolean);
                    if (normalizedRam.length > 0) params.ramOptions = normalizedRam.join(',');
                }
                if (filters.storage.length > 0) {
                    let normalizedStorage = filters.storage.map(s => normalizeForApi(s)).filter(Boolean);
                    if (normalizedStorage.length > 0) params.storageOptions = normalizedStorage.join(',');
                }

                $.ajax({
                    type: 'GET',
                    url: apiBase + "api/products/shop/search",
                    data: params,
                    dataType: 'json',
                    success: function(data) {
                        if (data && data.products) {
                            renderProducts(data.products || []);
                        } else {
                            console.error('Invalid response format:', data);
                            $('#productsContainer').html('<div class="col-12"><p class="text-center">Không có sản phẩm nào.</p></div>');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error loading products:', error);
                        console.error('Status:', status);
                        console.error('Response:', xhr.responseText);
                        // Show a friendly message inside products area (keeps sidebar visible)
                        let errText = 'Không thể tải sản phẩm. Vui lòng thử lại sau.';
                        try {
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errText += ' — ' + xhr.responseJSON.message;
                            }
                        } catch (e) {}
                        $('#productsContainer').html('<div class="col-12"><p class="text-center text-danger">' + errText + '</p></div>');
                    }
                });
            }

            // Render product cards (robust to PascalCase/camelCase names)
            function renderProducts(products) {
                if (!products || products.length === 0) {
                    $('#productsContainer').html('<div class="col-12"><p class="text-center">Không có sản phẩm nào.</p></div>');
                    return;
                }

                let html = '';
                products.forEach(function(product) {
                    // resolve fields (handle both PascalCase and camelCase)
                    const pid = product.productId || product.ProductId || '';
                    const pname = product.productName || product.ProductName || 'Chưa có tên';
                    const pmodel = product.productModel || product.ProductModel || '';
                    const avatar = (product.avatar || product.Avatar) ? '/image/' + (product.avatar || product.Avatar) : '/image/default-laptop.jpg';
                    const brandObj = product.brand || product.Brand || {};
                    const brandName = brandObj.brandName || brandObj.BrandName || 'Laptop';

                    // price resolution: prefer SellingPrice as the primary filter value (per your request)
                    const sellingPriceVal = (product.sellingPrice ?? product.SellingPrice);
                    const minConfigVal = (product.minConfigPrice ?? product.MinConfigPrice ?? product.minConfigPrice);
                    // displayPrice: prefer sellingPrice if present (>0), otherwise minConfigVal, otherwise 0
                    let displayPriceVal = 0;
                    if (sellingPriceVal != null && sellingPriceVal > 0) displayPriceVal = sellingPriceVal;
                    else if (minConfigVal != null && minConfigVal > 0) displayPriceVal = minConfigVal;
                    else displayPriceVal = 0;

                    const originalPriceVal = (product.originalSellingPrice ?? product.OriginalSellingPrice ?? 0);

                    // format
                    function fmt(amount) {
                        if (!amount || amount <= 0) return 'Liên hệ';
                        try {
                            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
                        } catch (e) {
                            return amount.toString() + ' ₫';
                        }
                    }

                    let priceHtml = fmt(displayPriceVal);
                    let originalPriceHtml = '';
                    if (originalPriceVal && originalPriceVal > displayPriceVal) {
                        originalPriceHtml = `<span class="text-muted text-decoration-line-through me-2" style="font-size: 0.9em;">${fmt(originalPriceVal)}</span>`;
                    }

                    const productDetailUrl = '/Home/ProductDetail?id=' + encodeURIComponent(pid);

                    html += '<div class="col-md-6 col-lg-6 col-xl-4">';
                    html += '  <div class="rounded position-relative fruite-item">';
                    html += '    <div class="fruite-img" style="cursor: pointer;" onclick="window.location.href=\'' + productDetailUrl + '\'">';
                    html += '      <img src="' + avatar + '" class="img-fluid w-100 rounded-top" alt="' + pname + '">';
                    html += '    </div>';
                    html += '    <div class="text-white bg-secondary px-3 py-1 rounded position-absolute" style="top: 10px; left: 10px;">' + brandName + '</div>';
                    html += '    <div class="p-4 border border-secondary border-top-0 rounded-bottom">';
                    html += '      <h4><a href="' + productDetailUrl + '" class="text-dark text-decoration-none">' + pname + '</a></h4>';
                    html += '      <p>' + pmodel + '</p>';
                    html += '      <div class="d-flex align-items-center flex-wrap gap-2 mb-3">';
                    html += '        ' + originalPriceHtml;
                    html += '        <span class="text-dark fs-5 fw-bold mb-0">' + priceHtml + '</span>';
                    html += '      </div>';
                    html += '      <div class="d-flex gap-2">';
                    html += '        <a href="' + productDetailUrl + '" class="btn border border-secondary rounded-pill px-3 text-primary">';
                    html += '          <i class="fa fa-eye me-2 text-primary"></i> Xem chi tiết';
                    html += '        </a>';
                    html += '        <a href="#" class="btn border border-secondary rounded-pill px-3 text-primary" onclick="event.preventDefault(); toggleFavorite(\'' + pid + '\'); return false;" title="Thêm vào yêu thích">';
                    html += '          <i class="far fa-heart" id="heart-' + pid + '"></i>';
                    html += '        </a>';
                    html += '      </div>';
                    html += '    </div>';
                    html += '  </div>';
                    html += '</div>';
                });

                $('#productsContainer').html(html);
            }

            // Optional toggle favorite
            function toggleFavorite(productId) {
                if (!productId) return;
                let heartIcon = $('#heart-' + productId);
                if (heartIcon.hasClass('fas')) {
                    heartIcon.removeClass('fas text-danger').addClass('far');
                } else {
                    heartIcon.removeClass('far').addClass('fas text-danger');
                }
            }
        </script>
}
