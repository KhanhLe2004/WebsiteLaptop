@{
    ViewData["Title"] = "Home Page";
    Layout = "~/Views/Shared/_LayoutHome.cshtml";
}

<div id="displayProducts" class="row g-4">
    <!-- Sản phẩm sẽ được hiển thị ở đây -->
</div>

<!-- Pagination -->
<div id="paginationContainer" class="col-12" style="display:none;">
  <div class="pagination d-flex justify-content-center mt-5">
    <a href="#" id="pg-prev" class="rounded" aria-label="Previous">&laquo;</a>

    <!-- page links will be injected here -->
    <span id="pg-pages" class="d-flex gap-2 mx-2 align-items-center"></span>

    <a href="#" id="pg-next" class="rounded" aria-label="Next">&raquo;</a>
  </div>
</div>

@section Scripts {
        <script>
            // Base API URL (chỉnh nếu cần)
            const apiBase = "http://localhost:5068/";
            const backendImageBase = apiBase + "image/";
            const defaultProductImage = "/image/default-laptop.jpg";

            function buildImageUrl(fileName) {
                if (!fileName || typeof fileName !== "string" || !fileName.trim()) {
                    return defaultProductImage;
                }
                return backendImageBase + encodeURIComponent(fileName.trim());
            }

            let allProducts = []; // store fetched products
            let currentPage = 1;
            const productsPerPage = 8; // số sản phẩm hiển thị mỗi trang

            // Lấy query params từ URL (brandId, productName, page)
            function getQueryParams() {
                const params = new URLSearchParams(window.location.search);
                return {
                    brandId: params.get('brandId'),
                    productName: params.get('productName'),
                    page: parseInt(params.get('page')) || 1
                };
            }

            // Hàm render products thành HTML cho 1 page
            function buildProductsHtml(data, page = 1) {
                if (!data || data.length === 0) {
                    $('#displayProducts').html('<div class="col-12"><p class="text-center">Không có sản phẩm nào.</p></div>');
                    $('#paginationContainer').hide();
                    return;
                }

                // pagination calc
                const totalProducts = data.length;
                const totalPages = Math.ceil(totalProducts / productsPerPage);
                const startIndex = (page - 1) * productsPerPage;
                const endIndex = Math.min(startIndex + productsPerPage, totalProducts);
                const productsToShow = data.slice(startIndex, endIndex);

                let html = '';
                if (productsToShow.length > 0) {
                    productsToShow.forEach(function (val) {
                        // Price formatting
                        let price = 'Liên hệ';
                        if (val.sellingPrice != null && val.sellingPrice !== undefined) {
                            try {
                                price = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(val.sellingPrice);
                            } catch (e) {
                                price = val.sellingPrice.toString() + ' VND';
                            }
                        }

                        // Original price (strike-through) if applicable
                        let originalPriceHtml = '';
                        if (val.originalSellingPrice != null && val.originalSellingPrice !== undefined &&
                            val.sellingPrice != null && val.sellingPrice !== undefined &&
                            val.originalSellingPrice > val.sellingPrice) {
                            try {
                                const formattedOriginal = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(val.originalSellingPrice);
                                originalPriceHtml = `<span class="text-muted text-decoration-line-through me-2" style="font-size: 0.9em;">${formattedOriginal}</span>`;
                            } catch (e) {
                                originalPriceHtml = `<span class="text-muted text-decoration-line-through me-2" style="font-size: 0.9em;">${val.originalSellingPrice.toString()} VND</span>`;
                            }
                        }

                        const avatar = buildImageUrl(val.avatar || val.Avatar);
                        const brandName = (val.brand && val.brand.brandName) ? val.brand.brandName : 'Laptop';
                        const productDetailUrl = '/Home/ProductDetail?id=' + encodeURIComponent(val.productId || '');

                        html += `
                            <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                                <div class="rounded position-relative fruite-item">
                                    <div class="fruite-img" style="cursor: pointer;" data-href="${productDetailUrl}">
                                        <img src="${avatar}" class="img-fluid w-100 rounded-top" alt="${val.productName || ''}" style="height: 200px; object-fit: cover;">
                                    </div>
                                    <div class="text-white bg-secondary px-3 py-1 rounded position-absolute" style="top: 10px; left: 10px;">${brandName}</div>
                                    <div class="p-4 border border-secondary border-top-0 rounded-bottom">
                                        <h4><a href="${productDetailUrl}" class="text-dark text-decoration-none">${val.productName || 'Chưa có tên'}</a></h4>
                                        <p>${val.productModel || ''}</p>
                                        <div class="d-flex flex-column align-items-center">
                                            <div class="d-flex align-items-center flex-wrap gap-2 mb-3">
                                                ${originalPriceHtml}
                                                <span class="text-dark fs-5 fw-bold mb-0">${price}</span>
                                            </div>
                                            <div class="d-flex gap-2">
                                                <a href="${productDetailUrl}" class="btn border border-secondary rounded-pill px-3 text-primary">
                                                    <i class="fa fa-eye me-2 text-primary"></i> Xem chi tiết
                                                </a>
                                                <a href="#" class="btn border border-secondary rounded-pill px-3 text-primary toggle-fav" data-id="${val.productId || ''}" title="Thêm vào yêu thích">
                                                    <i class="far fa-heart" id="heart-${val.productId || ''}"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    $('#displayProducts').html(html);

                    // Make images clickable (delegation)
                    $('#displayProducts .fruite-img').off('click').on('click', function () {
                        const href = $(this).data('href');
                        if (href) window.location.href = href;
                    });

                    // Favorite buttons (delegation)
                    $('#displayProducts .toggle-fav').off('click').on('click', function (e) {
                        e.preventDefault();
                        const pid = $(this).data('id');
                        toggleFavorite(pid);
                    });

                    // Build pagination (client-side)
                    buildPagination(totalPages, page);
                } else {
                    $('#displayProducts').html('<div class="col-12"><p class="text-center">Không có sản phẩm nào.</p></div>');
                    $('#paginationContainer').hide();
                }
            }

            /**
             * buildPagination: render controls into #pg-pages
             * - uses #pg-prev and #pg-next for prev/next
             * - creates <a class="rounded">...</a> like your template
             */
            function buildPagination(totalPages, current) {
                const container = document.getElementById('paginationContainer');
                const pagesWrap = document.getElementById('pg-pages');
                const prevBtn = document.getElementById('pg-prev');
                const nextBtn = document.getElementById('pg-next');

                if (!pagesWrap || !prevBtn || !nextBtn) return;

                // Hide when only one page
                if (totalPages <= 1) {
                    container.style.display = 'none';
                    return;
                }
                container.style.display = '';

                pagesWrap.innerHTML = '';

                // Create page anchor element
                function makePageLink(pageNum, isActive) {
                    const a = document.createElement('a');
                    a.href = '#';
                    a.className = 'rounded';
                    a.textContent = pageNum;
                    a.dataset.page = pageNum;
                    if (isActive) a.classList.add('active');
                    a.addEventListener('click', function (e) {
                        e.preventDefault();
                        const p = Number(this.dataset.page);
                        if (p === currentPage) return;
                        goToPage(p);
                    });
                    return a;
                }

                // Determine visible window
                const maxVisible = 20;
                let start = Math.max(1, current - 2);
                let end = Math.min(totalPages, current + 2);

                if (end - start + 1 < maxVisible) {
                    const need = maxVisible - (end - start + 1);
                    start = Math.max(1, start - Math.ceil(need / 2));
                    end = Math.min(totalPages, end + Math.floor(need / 2));
                }
                start = Math.max(1, start);
                end = Math.min(totalPages, end);

                // First page + dots
                if (start > 1) {
                    pagesWrap.appendChild(makePageLink(1, false));
                    if (start > 2) {
                        const dots = document.createElement('span');
                        dots.className = 'mx-1 text-muted';
                        dots.textContent = '...';
                        pagesWrap.appendChild(dots);
                    }
                }

                // Page numbers
                for (let p = start; p <= end; p++) {
                    pagesWrap.appendChild(makePageLink(p, p === current));
                }

                // Last page + dots
                if (end < totalPages) {
                    if (end < totalPages - 1) {
                        const dots = document.createElement('span');
                        dots.className = 'mx-1 text-muted';
                        dots.textContent = '...';
                        pagesWrap.appendChild(dots);
                    }
                    pagesWrap.appendChild(makePageLink(totalPages, false));
                }

                // Prev / Next handlers
                prevBtn.onclick = function (e) {
                    e.preventDefault();
                    if (currentPage > 1) goToPage(currentPage - 1);
                };
                nextBtn.onclick = function (e) {
                    e.preventDefault();
                    if (currentPage < totalPages) goToPage(currentPage + 1);
                };

                // Disabled visuals
                if (currentPage <= 1) {
                    prevBtn.classList.add('disabled');
                    prevBtn.setAttribute('aria-disabled', 'true');
                } else {
                    prevBtn.classList.remove('disabled');
                    prevBtn.removeAttribute('aria-disabled');
                }
                if (currentPage >= totalPages) {
                    nextBtn.classList.add('disabled');
                    nextBtn.setAttribute('aria-disabled', 'true');
                } else {
                    nextBtn.classList.remove('disabled');
                    nextBtn.removeAttribute('aria-disabled');
                }
            }

            /**
             * goToPage: transition to page WITHOUT reload
             * - updates history (pushState)
             * - renders products client-side
             */
            function goToPage(page) {
                page = parseInt(page) || 1;
                if (page < 1) page = 1;
                currentPage = page;

                // update URL params (preserve brandId & productName)
                const urlParams = new URLSearchParams(window.location.search);
                urlParams.set('page', page);
                const newUrl = window.location.pathname + (urlParams.toString() ? ('?' + urlParams.toString()) : '');
                window.history.pushState({ page: page }, '', newUrl);

                // re-render products
                buildProductsHtml(allProducts, page);

                // scroll to products
                document.querySelector('#displayProducts')?.scrollIntoView({ behavior: 'smooth' });
            }

            // handle back/forward navigation
            window.addEventListener('popstate', function (event) {
                const params = new URLSearchParams(window.location.search);
                const p = parseInt(params.get('page')) || 1;
                currentPage = p;
                buildProductsHtml(allProducts, currentPage);
            });

            // Fetch products (all or by category)
            function showProductByCategory() {
                const { brandId, productName, page } = getQueryParams();
                currentPage = page;
                let requestUrl;
                if (brandId) {
                    requestUrl = apiBase + "api/products/category/" + encodeURIComponent(brandId) + (productName ? ("?productName=" + encodeURIComponent(productName)) : "");
                } else {
                    requestUrl = apiBase + "api/ListProductAPI/all";
                }

                $.ajax({
                    type: 'GET',
                    url: requestUrl,
                    dataType: 'json',
                    success: function (data) {
                        // Expect data = array of products
                        console.log('Dữ liệu sản phẩm:', data);
                        allProducts = Array.isArray(data) ? data : (data || []);
                        buildProductsHtml(allProducts, currentPage);
                    },
                    error: function (xhr, status, error) {
                        console.error('Lỗi khi tải sản phẩm:', error);
                        console.error('Chi tiết:', xhr.responseText);
                        $('#displayProducts').html('<div class="col-12"><p class="text-center text-danger">Không thể tải sản phẩm. Vui lòng thử lại sau.</p></div>');
                        $('#paginationContainer').hide();
                    }
                });
            }

            // Toggle favorite (UI only stub)
            function toggleFavorite(productId) {
                if (!productId) return;
                const heartIcon = $('#heart-' + productId);
                if (!heartIcon.length) return;

                if (heartIcon.hasClass('fas')) {
                    // remove favorite
                    heartIcon.removeClass('fas text-danger').addClass('far');
                    console.log('Bỏ yêu thích sản phẩm:', productId);
                    // TODO: call API to remove favorite
                } else {
                    heartIcon.removeClass('far').addClass('fas text-danger');
                    console.log('Thêm yêu thích sản phẩm:', productId);
                    // TODO: call API to add favorite
                }
            }

            // Init on document ready
            $(document).ready(function () {
                // Load products initially (reads page from query param)
                showProductByCategory();
            });
        </script>
}