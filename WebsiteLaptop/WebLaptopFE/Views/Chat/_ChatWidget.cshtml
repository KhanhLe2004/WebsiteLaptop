
<div id="chatWidget" class="chat-widget-container">
    <!-- Chat Button (Floating) -->
    <div id="chatWidgetButton" class="chat-widget-button">
        <i class="bi bi-chat-dots-fill"></i>
        <span class="chat-badge" id="chatBadge" style="display: none;">0</span>
    </div>
    
    <!-- Chat Box -->
    <div id="chatBox" class="chat-box" style="display: none;">
        <div class="chat-box-header">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0 text-white">
                    <i class="bi bi-chat-dots me-2"></i>Trò chuyện với nhân viên
                </h6>
                <div>
                    <span id="chatConnectionStatus" class="badge bg-light text-dark me-2" style="display: none;">
                        <i class="bi bi-circle-fill text-secondary"></i>
                    </span>
                    <button type="button" class="btn-close btn-close-white" id="chatCloseButton" aria-label="Close"></button>
                </div>
            </div>
        </div>
        
        <div class="chat-box-body" id="chatMessagesArea">
            <div id="chatMessagesList" class="chat-messages-list">
                <!-- Messages will be loaded here -->
            </div>
        </div>
        
        <div class="chat-box-footer">
            <div class="input-group">
                <input type="text" id="chatMessageInput" class="form-control" placeholder="Nhập tin nhắn..." />
                <button class="btn btn-info" type="button" id="chatSendButton">
                    <i class="bi bi-send-fill"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .chat-widget-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
    }
    
    .chat-widget-button {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
        transition: all 0.3s ease;
        position: relative;
    }
    
    .chat-widget-button:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(0, 123, 255, 0.6);
    }
    
    .chat-widget-button i {
        font-size: 24px;
    }
    
    .chat-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #dc3545;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
    }
    
    .chat-box {
        position: absolute;
        bottom: 0; /* Ngang với bottom của icon */
        right: 70px; /* Xuất hiện bên trái icon (icon width 60px + 10px margin) */
        width: 380px;
        height: 450px;
        max-height: 80vh;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .chat-box-header {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        padding: 15px;
        border-radius: 12px 12px 0 0;
    }
    
    .chat-box-body {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        background-color: #f8f9fa;
    }
    
    .chat-messages-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .chat-message {
        max-width: 75%;
        padding: 10px 15px;
        border-radius: 18px;
        word-wrap: break-word;
        animation: fadeIn 0.3s ease;
    }
    
    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .chat-message.sent {
        background-color: #007bff;
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
    }
    
    .chat-message.received {
        background-color: #e9ecef;
        color: #333;
        align-self: flex-start;
        border-bottom-left-radius: 4px;
    }
    
    .chat-message-time {
        font-size: 0.7rem;
        opacity: 0.7;
        margin-top: 5px;
    }
    
    .date-separator {
        text-align: center;
        margin: 15px 0;
        position: relative;
    }
    
    .date-separator::before,
    .date-separator::after {
        content: '';
        position: absolute;
        top: 50%;
        width: 40%;
        height: 1px;
        background-color: #dee2e6;
    }
    
    .date-separator::before {
        left: 0;
    }
    
    .date-separator::after {
        right: 0;
    }
    
    .date-separator span {
        background-color: #f8f9fa;
        padding: 5px 12px;
        border-radius: 12px;
        font-size: 0.75rem;
        color: #6c757d;
        position: relative;
        z-index: 1;
    }
    
    .chat-box-footer {
        padding: 15px;
        background: white;
        border-top: 1px solid #e9ecef;
    }
    
    .chat-box-footer .input-group {
        margin: 0;
    }
    
    .chat-box-footer .form-control {
        border-radius: 20px 0 0 20px;
        border-right: none;
    }
    
    .chat-box-footer .btn {
        border-radius: 0 20px 20px 0;
        border-left: none;
    }
    
    /* Scrollbar styling */
    .chat-box-body::-webkit-scrollbar {
        width: 6px;
    }
    
    .chat-box-body::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    
    .chat-box-body::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
    }
    
    .chat-box-body::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    
    /* Responsive */
    @@media (max-width: 768px) {
        .chat-box {
            width: calc(100vw - 40px);
            height: calc(100vh - 120px);
            bottom: 80px;
            right: 20px;
        }
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>
<script>
    // Prevent multiple initializations
    if (window.chatWidgetInitialized) {
        console.log('Chat widget already initialized, skipping...');
    } else {
        window.chatWidgetInitialized = true;
        
        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeChatWidget);
        } else {
            // DOM is already ready
            initializeChatWidget();
        }
    }
    
    function initializeChatWidget() {
        const apiBase = "http://localhost:5068/api/";
        const hubUrl = "http://localhost:5068/chathub";
        
        let chatConnection;
        let currentCustomerId = null;
        let lastSentMessage = null;
        let isChatBoxOpen = false;
        let badgeUpdateInterval = null;
        
        // Get DOM elements
        const chatWidgetButton = document.getElementById("chatWidgetButton");
        const chatBox = document.getElementById("chatBox");
        const chatCloseButton = document.getElementById("chatCloseButton");
        const chatSendButton = document.getElementById("chatSendButton");
        const chatMessageInput = document.getElementById("chatMessageInput");
        
        // Check if elements exist
        if (!chatWidgetButton || !chatBox) {
            console.error('Chat widget elements not found');
            return;
        }
        
        // Get customer info from sessionStorage
        function getCustomerInfo() {
            const customerStr = sessionStorage.getItem('customer');
            if (customerStr) {
                try {
                    const customer = JSON.parse(customerStr);
                    return customer.customerId || customer.CustomerId || customer.customer?.customerId;
                } catch (e) {
                    console.error('Error parsing customer info:', e);
                }
            }
            return null;
        }
        
        // Initialize SignalR connection
        function startChatConnection() {
            // If already connected, return
            if (chatConnection && chatConnection.state === signalR.HubConnectionState.Connected) {
                return Promise.resolve();
            }
            
            // If connection exists but is not connected, stop it first
            if (chatConnection) {
                chatConnection.stop().catch(err => console.error("Error stopping connection:", err));
            }
            
            chatConnection = new signalR.HubConnectionBuilder()
                .withUrl(hubUrl, {
                    skipNegotiation: false,
                    transport: signalR.HttpTransportType.WebSockets | signalR.HttpTransportType.LongPolling,
                    accessTokenFactory: null
                })
                .configureLogging(signalR.LogLevel.Information)
                .withAutomaticReconnect({
                    nextRetryDelayInMilliseconds: retryContext => {
                        if (retryContext.elapsedMilliseconds < 60000) {
                            return Math.min(1000 * Math.pow(2, retryContext.previousRetryCount), 30000);
                        }
                        return null; // Stop retrying after 60 seconds
                    }
                })
                .build();
            
            chatConnection.on("ReceiveMessage", function (message) {
                // Check if this is the message we just sent (to avoid duplicate)
                if (lastSentMessage && 
                    message.contentDetail === lastSentMessage.contentDetail && 
                    message.senderType === "customer" &&
                    Math.abs(new Date(message.time) - lastSentMessage.time) < 2000) {
                    lastSentMessage = null;
                    return;
                }
                
                // Only display if chat box is open
                if (isChatBoxOpen) {
                    displayChatMessage(message, false);
                    // If chat box is open, mark as read immediately
                    if (message.senderType === "employee") {
                        markChatAsRead();
                    }
                }
                
                // Update unread badge if message is from employee
                // Always update badge when receiving message from employee
                if (message.senderType === "employee") {
                    // Delay slightly to ensure message is saved in database
                    setTimeout(() => {
                        updateUnreadBadgeFromAPI();
                    }, 500);
                }
            });
            
            chatConnection.on("Error", function (error) {
                console.error("Chat connection error:", error);
                updateChatConnectionStatus(false);
            });
            
            chatConnection.onreconnecting(function() {
                console.log("Chat reconnecting...");
                updateChatConnectionStatus(false);
            });
            
            chatConnection.onreconnected(function() {
                console.log("Chat reconnected");
                currentCustomerId = getCustomerInfo();
                if (currentCustomerId) {
                    chatConnection.invoke("JoinRoom", currentCustomerId, "customer")
                        .catch(err => console.error("Error rejoining room:", err));
                }
                updateChatConnectionStatus(true);
            });
            
            chatConnection.onclose(function (error) {
                console.log("Chat connection closed", error);
                updateChatConnectionStatus(false);
                // Only auto-reconnect if chat box is open
                if (isChatBoxOpen && currentCustomerId) {
                    setTimeout(() => {
                        if (isChatBoxOpen) {
                            startChatConnection().catch(err => console.error("Auto-reconnect failed:", err));
                        }
                    }, 3000);
                }
            });
            
            // Return promise so we can await it
            return chatConnection.start().then(function () {
                console.log("Chat connection started");
                currentCustomerId = getCustomerInfo();
                if (currentCustomerId) {
                    return chatConnection.invoke("JoinRoom", currentCustomerId, "customer")
                        .then(function() {
                            console.log("Joined chat room");
                            updateChatConnectionStatus(true);
                            if (isChatBoxOpen) {
                                loadChatMessages();
                                markChatAsRead();
                            } else {
                                // Load unread count when connection is established
                                updateUnreadBadgeFromAPI();
                            }
                            
                            // Start periodic badge update (every 30 seconds)
                            startBadgeUpdateInterval();
                        })
                        .catch(function (err) {
                            console.error("Error joining room:", err);
                            updateChatConnectionStatus(false);
                            throw err;
                        });
                } else {
                    updateChatConnectionStatus(true);
                }
            }).catch(function (err) {
                console.error("Error starting chat connection:", err);
                console.error("Error details:", {
                    message: err.message,
                    stack: err.stack,
                    hubUrl: hubUrl
                });
                updateChatConnectionStatus(false);
                
                // Provide more helpful error message
                if (err.message && err.message.includes("Failed to fetch")) {
                    console.error("CORS or network error. Check:");
                    console.error("1. Backend is running on http://localhost:5068");
                    console.error("2. CORS is configured correctly in Program.cs");
                    console.error("3. SignalR hub is mapped at /chathub");
                }
                
                throw err;
            });
        }
        
        // Toggle chat box
        chatWidgetButton.addEventListener("click", async function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            isChatBoxOpen = !isChatBoxOpen;
            
            if (isChatBoxOpen) {
                // Đóng ChatAIWidget nếu đang mở
                closeChatAIWidgetIfOpen();
                
                chatBox.style.display = "flex";
                // Stop periodic badge update when chat box is open
                stopBadgeUpdateInterval();
                
                currentCustomerId = getCustomerInfo();
                
                const messagesList = document.getElementById("chatMessagesList");
                
                if (currentCustomerId) {
                    // Show loading message
                    if (messagesList) {
                        messagesList.innerHTML = 
                            '<div class="text-center text-muted p-3">Đang kết nối...</div>';
                    }
                    
                    try {
                        // Check connection state
                        if (!chatConnection || chatConnection.state !== signalR.HubConnectionState.Connected) {
                            // Wait for connection to be established
                            await startChatConnection();
                            
                            // Wait a bit more to ensure connection is ready
                            let attempts = 0;
                            const maxAttempts = 10;
                            while (attempts < maxAttempts && 
                                   (!chatConnection || chatConnection.state !== signalR.HubConnectionState.Connected)) {
                                await new Promise(resolve => setTimeout(resolve, 200));
                                attempts++;
                            }
                        }
                        
                        // If connected, load messages
                        if (chatConnection && chatConnection.state === signalR.HubConnectionState.Connected) {
                            await loadChatMessages();
                            await markChatAsRead();
                        } else {
                            if (messagesList) {
                                messagesList.innerHTML = 
                                    '<div class="text-center text-danger p-3">Không thể kết nối đến server. Vui lòng thử lại sau.</div>';
                            }
                        }
                    } catch (error) {
                        console.error("Error opening chat:", error);
                        if (messagesList) {
                            messagesList.innerHTML = 
                                '<div class="text-center text-danger p-3">Lỗi kết nối: ' + error.message + '. Vui lòng thử lại.</div>';
                        }
                    }
                } else {
                    if (messagesList) {
                        messagesList.innerHTML = 
                            '<div class="text-center text-muted p-3">Vui lòng đăng nhập để sử dụng tính năng chat</div>';
                    }
                }
                
                // Hide badge when opening chat box
                const badge = document.getElementById("chatBadge");
                if (badge) {
                    badge.style.display = "none";
                }
            } else {
                chatBox.style.display = "none";
                // Resume periodic badge update when chat box is closed
                if (currentCustomerId) {
                    startBadgeUpdateInterval();
                }
            }
        });
        
        // Đóng ChatAIWidget nếu đang mở (được gọi từ ChatWidget)
        function closeChatAIWidgetIfOpen() {
            const chatAIWindow = document.getElementById('chatWindow');
            
            if (chatAIWindow) {
                const isOpen = chatAIWindow.style.display === 'flex' || 
                              (chatAIWindow.style.display === '' && window.getComputedStyle(chatAIWindow).display === 'flex');
                
                if (isOpen) {
                    // Gọi function từ ChatAIWidget để đóng
                    if (window.Chatbot && typeof window.Chatbot.closeChatWindow === 'function') {
                        window.Chatbot.closeChatWindow();
                    } else if (typeof window.closeChatAIWidget === 'function') {
                        window.closeChatAIWidget();
                    } else {
                        // Fallback: đóng trực tiếp
                        chatAIWindow.style.display = 'none';
                    }
                    // Dispatch event để ChatAIWidget biết đã bị đóng
                    window.dispatchEvent(new CustomEvent('chatAIWidgetClosed'));
                }
            }
        }
        
        // Listen event khi ChatWidget bị đóng từ ChatAIWidget
        window.addEventListener('chatWidgetClosed', function() {
            isChatBoxOpen = false;
            // Resume periodic badge update when chat box is closed
            if (currentCustomerId) {
                startBadgeUpdateInterval();
            }
        });
        
        // Close chat box
        if (chatCloseButton) {
            chatCloseButton.addEventListener("click", function(e) {
                e.preventDefault();
                e.stopPropagation();
                chatBox.style.display = "none";
                isChatBoxOpen = false;
            });
        }
        
        // Send message
        if (chatSendButton) {
            chatSendButton.addEventListener("click", function(e) {
                e.preventDefault();
                sendChatMessage();
            });
        }
        
        if (chatMessageInput) {
            chatMessageInput.addEventListener("keypress", function(event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    sendChatMessage();
                }
            });
        }
        
        async function sendChatMessage() {
            if (!chatMessageInput || !currentCustomerId) {
                if (!currentCustomerId) {
                    alert("Vui lòng đăng nhập để sử dụng tính năng chat");
                }
                return;
            }
            
            const message = chatMessageInput.value.trim();
            
            if (message === "") {
                return;
            }
            
            // Check and ensure connection
            if (!chatConnection || chatConnection.state !== signalR.HubConnectionState.Connected) {
                // Try to reconnect
                try {
                    const messagesList = document.getElementById("chatMessagesList");
                    if (messagesList) {
                        const loadingMsg = document.createElement("div");
                        loadingMsg.className = "text-center text-muted p-2";
                        loadingMsg.textContent = "Đang kết nối lại...";
                        messagesList.appendChild(loadingMsg);
                    }
                    
                    await startChatConnection();
                    
                    // Wait for connection
                    let attempts = 0;
                    const maxAttempts = 10;
                    while (attempts < maxAttempts && 
                           (!chatConnection || chatConnection.state !== signalR.HubConnectionState.Connected)) {
                        await new Promise(resolve => setTimeout(resolve, 200));
                        attempts++;
                    }
                    
                    if (messagesList && messagesList.lastChild && messagesList.lastChild.className.includes("text-muted")) {
                        messagesList.removeChild(messagesList.lastChild);
                    }
                    
                    if (!chatConnection || chatConnection.state !== signalR.HubConnectionState.Connected) {
                        alert("Không thể kết nối đến server. Vui lòng thử lại sau.");
                        return;
                    }
                } catch (error) {
                    console.error("Error reconnecting:", error);
                    alert("Lỗi kết nối: " + error.message);
                    return;
                }
            }
            
            // Show message immediately (optimistic update)
            const tempMessage = {
                contentDetail: message,
                time: new Date(),
                senderType: "customer"
            };
            lastSentMessage = tempMessage;
            displayChatMessage(tempMessage);
            chatMessageInput.value = "";
            
            chatConnection.invoke("SendMessage", currentCustomerId, null, message, "customer")
                .then(function() {
                    setTimeout(function() {
                        lastSentMessage = null;
                    }, 3000);
                })
                .catch(function (err) {
                    console.error("Error sending message:", err);
                    alert("Lỗi khi gửi tin nhắn: " + err.toString());
                    const messagesList = document.getElementById("chatMessagesList");
                    if (messagesList && messagesList.lastChild) {
                        messagesList.removeChild(messagesList.lastChild);
                    }
                    lastSentMessage = null;
                });
        }
        
        // Format date for display
        function formatDateHeader(date) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const messageDate = new Date(date);
            messageDate.setHours(0, 0, 0, 0);
            
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (messageDate.getTime() === today.getTime()) {
                return "Hôm nay";
            } else if (messageDate.getTime() === yesterday.getTime()) {
                return "Hôm qua";
            } else {
                return messageDate.toLocaleDateString("vi-VN", {
                    day: "2-digit",
                    month: "2-digit",
                    year: "numeric"
                });
            }
        }
        
        // Check if we need to show date separator
        function shouldShowDateSeparator(messagesList, messageDate) {
            const lastMessage = messagesList.lastElementChild;
            if (!lastMessage || lastMessage.classList.contains("date-separator")) {
                return true;
            }
            
            const lastMessageTime = lastMessage.getAttribute("data-message-date");
            if (!lastMessageTime) {
                return true;
            }
            
            const lastDate = new Date(lastMessageTime);
            lastDate.setHours(0, 0, 0, 0);
            
            const currentDate = new Date(messageDate);
            currentDate.setHours(0, 0, 0, 0);
            
            return lastDate.getTime() !== currentDate.getTime();
        }
        
        // Display date separator
        function displayDateSeparator(messagesList, date) {
            const separatorDiv = document.createElement("div");
            separatorDiv.className = "date-separator";
            separatorDiv.innerHTML = `<span>${formatDateHeader(date)}</span>`;
            messagesList.appendChild(separatorDiv);
        }
        
        // Display message
        function displayChatMessage(message, skipDateCheck = false) {
            const messagesList = document.getElementById("chatMessagesList");
            if (!messagesList) return;
            
            // Clear placeholder if exists
            if (messagesList.querySelector('.text-center.text-muted')) {
                messagesList.innerHTML = "";
            }
            
            const messageDate = new Date(message.time);
            
            // Show date separator if needed
            if (!skipDateCheck && shouldShowDateSeparator(messagesList, messageDate)) {
                displayDateSeparator(messagesList, messageDate);
            }
            
            const messageDiv = document.createElement("div");
            messageDiv.className = "chat-message " + (message.senderType === "customer" ? "sent" : "received");
            messageDiv.setAttribute("data-message-date", message.time);
            
            const time = new Date(message.time).toLocaleTimeString("vi-VN", {
                hour: "2-digit",
                minute: "2-digit"
            });
            
            messageDiv.innerHTML = `
                <div>${escapeHtml(message.contentDetail)}</div>
                <div class="chat-message-time">${time}</div>
            `;
            
            messagesList.appendChild(messageDiv);
            scrollChatToBottom();
        }
        
        // Load messages
        async function loadChatMessages() {
            if (!currentCustomerId) return;
            
            try {
                const response = await fetch(`${apiBase}Chat/GetMessages?customerId=${currentCustomerId}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const messages = await response.json();
                
                const messagesList = document.getElementById("chatMessagesList");
                if (!messagesList) return;
                
                messagesList.innerHTML = "";
                
                if (messages && messages.length > 0) {
                    messages.forEach(message => {
                        displayChatMessage(message, false);
                    });
                } else {
                    messagesList.innerHTML = '<div class="text-center text-muted p-3">Chưa có tin nhắn nào. Hãy bắt đầu trò chuyện!</div>';
                }
            } catch (error) {
                console.error("Error loading messages:", error);
                const messagesList = document.getElementById("chatMessagesList");
                if (messagesList) {
                    messagesList.innerHTML = '<div class="text-center text-danger p-3">Lỗi khi tải tin nhắn. Vui lòng thử lại.</div>';
                }
            }
        }
        
        // Mark messages as read
        async function markChatAsRead() {
            if (!currentCustomerId) return;
            
            try {
                await fetch(`${apiBase}Chat/MarkAsRead`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        customerId: currentCustomerId,
                        employeeId: null // Customer is marking their messages as read
                    })
                });
                // Refresh unread badge after marking as read
                updateUnreadBadgeFromAPI();
            } catch (error) {
                console.error("Error marking as read:", error);
            }
        }
        
        // Update unread badge from API
        async function updateUnreadBadgeFromAPI() {
            if (!currentCustomerId) return;
            
            try {
                const response = await fetch(`${apiBase}Chat/GetConversations/Customer?customerId=${currentCustomerId}`);
                if (!response.ok) {
                    console.error("Failed to fetch unread count:", response.status, response.statusText);
                    return;
                }
                const conversations = await response.json();
                
                if (conversations && conversations.length > 0) {
                    const unreadCount = conversations[0].unreadCount || 0;
                    const badge = document.getElementById("chatBadge");
                    
                    if (badge) {
                        if (unreadCount > 0 && !isChatBoxOpen) {
                            badge.textContent = unreadCount > 99 ? "99+" : unreadCount.toString();
                            badge.style.display = "flex";
                        } else {
                            badge.style.display = "none";
                        }
                    }
                } else {
                    // No conversations found, hide badge
                    const badge = document.getElementById("chatBadge");
                    if (badge) {
                        badge.style.display = "none";
                    }
                }
            } catch (error) {
                console.error("Error updating unread badge:", error);
            }
        }
        
        // Scroll to bottom
        function scrollChatToBottom() {
            const messagesArea = document.getElementById("chatMessagesArea");
            if (messagesArea) {
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }
        }
        
        // Update connection status
        function updateChatConnectionStatus(connected) {
            const statusEl = document.getElementById("chatConnectionStatus");
            if (statusEl) {
                // Hide connection status badge
                statusEl.style.display = "none";
            }
        }
        
        // Update unread badge (legacy function, now always calls API)
        function updateUnreadBadge() {
            // Always get actual unread count from API for accuracy
            updateUnreadBadgeFromAPI();
        }
        
        // Escape HTML
        function escapeHtml(text) {
            if (!text) return "";
            const div = document.createElement("div");
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Start periodic badge update
        function startBadgeUpdateInterval() {
            // Clear existing interval if any
            if (badgeUpdateInterval) {
                clearInterval(badgeUpdateInterval);
            }
            
            // Update badge every 30 seconds if chat box is closed
            badgeUpdateInterval = setInterval(() => {
                if (!isChatBoxOpen && currentCustomerId) {
                    updateUnreadBadgeFromAPI();
                }
            }, 30000); // 30 seconds
        }
        
        // Stop periodic badge update
        function stopBadgeUpdateInterval() {
            if (badgeUpdateInterval) {
                clearInterval(badgeUpdateInterval);
                badgeUpdateInterval = null;
            }
        }
        
        // Start connection when page loads
        startChatConnection();
    }
</script>

