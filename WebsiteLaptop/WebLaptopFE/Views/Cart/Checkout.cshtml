@{
    ViewData["Title"] = "Đặt hàng";
    Layout = "~/Views/Shared/_LayoutCheckout.cshtml";
}

@section Scripts {
<script>
    (function ($) {
        'use strict';

        // Cấu hình API
        const getDefaultApiBase = () => {
            if (window.CHECKOUT_API_BASE && window.CHECKOUT_API_BASE.trim()) {
                return window.CHECKOUT_API_BASE.trim();
            }
            if (window.location && window.location.origin) {
                const origin = window.location.origin;
                if (!origin.includes('localhost')) {
                    return origin;
                }
            }
            return 'http://localhost:5068';
        };

        const API_BASE = getDefaultApiBase();
        const CHECKOUT_API_BASE = `${API_BASE}/api/Checkout`;
        const CART_API_BASE = `${API_BASE}/api/Cart`;
        const ADDRESS_API_BASE = window.ADDRESS_API_BASE || `${API_BASE}/api/Address`;
        const backendImageBase = `${API_BASE}/imageProducts/`;
        const defaultProductImage = "/imageProducts/default-laptop.jpg";

        // Helper function để lấy URL ảnh từ backend
        function getBackendImageUrl(fileName) {
            if (!fileName || typeof fileName !== "string" || !fileName.trim()) {
                return defaultProductImage;
            }
            return backendImageBase + encodeURIComponent(fileName.trim());
        }

        // Lấy customerId từ session
        function getCustomerId() {
            try {
                const isLoggedIn = sessionStorage.getItem('isLoggedIn');
                const customer = sessionStorage.getItem('customer');
                if (!isLoggedIn || !customer) {
                    window.location.replace('/User/Login');
                    return null;
                }
                const parsed = JSON.parse(customer);
                return parsed.customerId || parsed.CustomerId || null;
            } catch (err) {
                console.error('Cannot get customerId:', err);
                window.location.replace('/User/Login');
                return null;
            }
        }

        const currentCustomerId = getCustomerId();
        if (!currentCustomerId) {
            window.location.replace('/User/Login');
        }

        // Helper functions
        function formatCurrency(value) {
            return (value ?? 0).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
        }

        function showAlert(type, message) {
            const alertHtml = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
            $('body').prepend(alertHtml);
            setTimeout(() => $('.alert').fadeOut(), 5000);
        }

        let provinces = [];
        const wardsCache = new Map();

        // Load địa chỉ
        async function loadProvinces() {
            if (provinces.length) return provinces;
            try {
                const response = await fetch(`${ADDRESS_API_BASE}/provinces`, { credentials: 'same-origin' });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                const list = Array.isArray(data) ? data : [];
                provinces = list.map(item => ({
                    code: String(item.code || item.id || '').trim(),
                    name: String(item.name || '').trim()
                })).filter(p => p.code && p.name);

                const $province = $('#checkoutProvince');
                if ($province.length) {
                    $province.empty().append('<option value="">-- Chọn tỉnh/thành phố --</option>');
                    provinces.forEach(p => $province.append(new Option(p.name, p.code)));
                }
                return provinces;
            } catch (err) {
                console.error('loadProvinces error:', err);
                return [];
            }
        }

        async function loadWardsByProvince(provinceCode) {
            const $ward = $('#checkoutWard');
            if (!$ward.length) return;
            $ward.prop('disabled', true).html('<option value="">-- Đang tải... --</option>');
            
            if (!provinceCode) {
                $ward.html('<option value="">-- Chọn xã/phường --</option>');
                return;
            }

            if (wardsCache.has(provinceCode)) {
                populateWards(wardsCache.get(provinceCode));
                return;
            }

            try {
                const response = await fetch(`${ADDRESS_API_BASE}/wards/${provinceCode}`, { credentials: 'same-origin' });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                const list = Array.isArray(data) ? data : [];
                const wards = list.map(w => ({
                    code: String(w.code || w.id || '').trim(),
                    name: String(w.name || '').trim()
                })).filter(w => w.code && w.name);
                wardsCache.set(provinceCode, wards);
                populateWards(wards);
            } catch (err) {
                console.error('loadWards error:', err);
                $ward.html('<option value="">-- Không thể tải xã/phường --</option>');
            }
        }

        function populateWards(wards) {
            const $ward = $('#checkoutWard');
            if (!$ward.length) return;
            $ward.empty().append('<option value="">-- Chọn xã/phường --</option>');
            wards.forEach(w => $ward.append(new Option(w.name, w.code)));
            $ward.prop('disabled', false);
        }

        // Load giỏ hàng
        async function loadCart() {
            if (!currentCustomerId) return;

            try {
                const response = await fetch(`${CART_API_BASE}/${currentCustomerId}`, { credentials: 'same-origin' });
                if (!response.ok) throw new Error('Không thể tải giỏ hàng');
                const data = await response.json();
                renderCartItems(data.items || []);
                updateTotals(data.totalAmount || 0);
            } catch (err) {
                console.error('loadCart error:', err);
                $('#checkoutCartBody').html('<tr><td colspan="5" class="text-center text-danger">Không thể tải giỏ hàng</td></tr>');
            }
        }

        function renderCartItems(items) {
            const $body = $('#checkoutCartBody');
            if (!items || items.length === 0) {
                $body.html('<tr><td colspan="5" class="text-center text-muted">Giỏ hàng trống</td></tr>');
                return;
            }

            const rows = items.map(item => {
                const imageUrl = getBackendImageUrl(item.productImage);
                const productNameDisplay = item.productModel 
                    ? `${item.productName || 'N/A'} ${item.productModel}` 
                    : (item.productName || 'N/A');
                return `
                    <tr>
                        <th scope="row">
                            <div class="d-flex align-items-center mt-2">
                                <img src="${imageUrl}" class="img-fluid" style="width: 90px; height: 90px; object-fit: cover;" alt="${item.productName}" onerror="this.src='${defaultProductImage}'">
                            </div>
                        </th>
                        <td class="py-5">${productNameDisplay}</td>
                        <td class="py-5 number-text">${formatCurrency(item.price)}</td>
                        <td class="py-5">${item.quantity}</td>
                        <td class="py-5 number-text">${formatCurrency(item.subtotal)}</td>
                    </tr>`;
            });

            $body.html(rows.join(''));
        }

        function updateTotals(subtotal) {
            const deliveryFee = 30000; // Phí giao hàng mặc định
            const total = subtotal + deliveryFee;
            
            $('.subtotal-amount').text(formatCurrency(subtotal));
            $('.delivery-fee-amount').text(formatCurrency(deliveryFee));
            $('.total-amount').text(formatCurrency(total));
        }

        // Load thông tin khách hàng
        async function loadCustomerInfo() {
            if (!currentCustomerId) return;

            try {
                const response = await fetch(`${API_BASE}/api/CustomerAccount/${currentCustomerId}`, { credentials: 'same-origin' });
                if (!response.ok) return;
                const customer = await response.json();
                
                // Điền thông tin vào form
                const fullName = customer.customerName || customer.CustomerName || '';
                if (fullName) {
                    const nameParts = fullName.split(' ');
                    if (nameParts.length > 1) {
                        $('#checkoutLastName').val(nameParts[0]);
                        $('#checkoutFirstName').val(nameParts.slice(1).join(' '));
                    } else {
                        $('#checkoutFirstName').val(fullName);
                    }
                }
                $('#checkoutPhone').val(customer.phoneNumber || customer.PhoneNumber || '');
                $('#checkoutEmail').val(customer.email || customer.Email || '');
                
                // Điền địa chỉ
                const address = customer.address || customer.Address || '';
                if (address) {
                    $('#checkoutAddress').val(address);
                }
            } catch (err) {
                console.error('loadCustomerInfo error:', err);
            }
        }

        // Hiển thị lỗi validation dưới từng ô
        function showFieldError(fieldId, message) {
            const $field = $(fieldId);
            const errorId = fieldId.substring(1) + '-error';
            const $error = $('#' + errorId);
            if ($error.length) {
                $error.remove();
            }
            if (message) {
                $field.after(`<div class="text-danger small mt-1" id="${errorId}">${message}</div>`);
                $field.addClass('is-invalid');
            } else {
                $field.removeClass('is-invalid');
            }
        }

        // Hiển thị lỗi cho phương thức thanh toán
        function showPaymentMethodError(message) {
            const errorId = 'payment-method-error';
            const $error = $('#' + errorId);
            if ($error.length) {
                $error.remove();
            }
            if (message) {
                $('.form-check').last().after(`<div class="text-danger small mt-1" id="${errorId}">${message}</div>`);
            }
        }

        // Xóa tất cả lỗi validation
        function clearAllErrors() {
            $('.is-invalid').removeClass('is-invalid');
            $('[id$="-error"]').remove();
            showPaymentMethodError('');
        }

        // Xử lý submit form
        async function handleCheckout(e) {
            e.preventDefault();
            
            // Xóa tất cả lỗi cũ
            clearAllErrors();
            
            const lastName = $('#checkoutLastName').val()?.toString().trim();
            const firstName = $('#checkoutFirstName').val()?.toString().trim();
            const fullName = (lastName + ' ' + firstName).trim();
            const phone = $('#checkoutPhone').val()?.toString().trim();
            const email = $('#checkoutEmail').val()?.toString().trim();
            const detailAddress = $('#checkoutAddress').val()?.toString().trim();
            const province = $('#checkoutProvince').val();
            const ward = $('#checkoutWard').val();
            const paymentMethod = $('input[name="PaymentMethod"]:checked').val();
            const note = $('#checkoutNote').val()?.toString().trim();

            let hasError = false;

            // Validate từng trường
            if (!lastName) {
                showFieldError('#checkoutLastName', 'Vui lòng nhập họ');
                hasError = true;
            }
            
            if (!firstName) {
                showFieldError('#checkoutFirstName', 'Vui lòng nhập tên');
                hasError = true;
            }

            if (!phone) {
                showFieldError('#checkoutPhone', 'Vui lòng nhập số điện thoại');
                hasError = true;
            } else if (!new RegExp('^\\d{9,15}$').test(phone)) {
                showFieldError('#checkoutPhone', 'Số điện thoại không hợp lệ (9-15 chữ số)');
                hasError = true;
            }

            if (!email) {
                showFieldError('#checkoutEmail', 'Vui lòng nhập email');
                hasError = true;
            } else {
                const atSymbol = String.fromCharCode(64);
                const atIndex = email.indexOf(atSymbol);
                const dotIndex = email.lastIndexOf('.');
                if (atIndex <= 0 || dotIndex <= atIndex + 1 || dotIndex >= email.length - 1) {
                    showFieldError('#checkoutEmail', 'Email không hợp lệ');
                    hasError = true;
                }
            }

            if (!detailAddress) {
                showFieldError('#checkoutAddress', 'Vui lòng nhập địa chỉ chi tiết');
                hasError = true;
            }

            if (!province) {
                showFieldError('#checkoutProvince', 'Vui lòng chọn tỉnh/thành phố');
                hasError = true;
            }

            if (!ward) {
                showFieldError('#checkoutWard', 'Vui lòng chọn xã/phường');
                hasError = true;
            }

            if (!paymentMethod) {
                showPaymentMethodError('Vui lòng chọn phương thức thanh toán');
                hasError = true;
            } else {
                showPaymentMethodError('');
            }

            if (hasError) {
                return;
            }

            const provinceName = $('#checkoutProvince option:selected').text();
            const wardName = $('#checkoutWard option:selected').text();

            // Ghép địa chỉ
            let deliveryAddress = detailAddress;
            if (wardName && !wardName.startsWith('--')) {
                deliveryAddress = deliveryAddress ? `${deliveryAddress}, ${wardName}` : wardName;
            }
            if (provinceName && !provinceName.startsWith('--')) {
                deliveryAddress = deliveryAddress ? `${deliveryAddress}, ${provinceName}` : provinceName;
            }

            const btn = $('#btnPlaceOrder');
            const original = btn.html();
            btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Đang xử lý...');

            try {
                const response = await fetch(`${CHECKOUT_API_BASE}/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customerId: currentCustomerId,
                        fullName: fullName,
                        phone: phone,
                        email: email,
                        deliveryAddress: deliveryAddress,
                        paymentMethod: paymentMethod,
                        deliveryFee: 30000,
                        note: note
                    })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data?.message || 'Không thể đặt hàng');
                
                alert('Đặt hàng thành công!');
                setTimeout(() => {
                    window.location.href = '/User/Account#tab-your-orders';
                }, 500);
            } catch (err) {
                console.error('handleCheckout error:', err);
                showAlert('danger', err.message || 'Không thể đặt hàng');
            } finally {
                btn.prop('disabled', false).html(original);
            }
        }

        // Initialize
        $(document).ready(function () {
            loadProvinces();
            loadCart();
            loadCustomerInfo();

            // Xóa lỗi khi người dùng nhập
            $('#checkoutLastName, #checkoutFirstName').on('input', function() {
                showFieldError('#' + this.id, '');
            });
            
            $('#checkoutPhone').on('input', function() {
                showFieldError('#checkoutPhone', '');
            });
            
            $('#checkoutEmail').on('input', function() {
                showFieldError('#checkoutEmail', '');
            });
            
            $('#checkoutAddress').on('input', function() {
                showFieldError('#checkoutAddress', '');
            });
            
            $('#checkoutProvince').on('change', function () {
                loadWardsByProvince(this.value);
                showFieldError('#checkoutProvince', '');
            });
            
            $('#checkoutWard').on('change', function() {
                showFieldError('#checkoutWard', '');
            });
            
            $('input[name="PaymentMethod"]').on('change', function() {
                showPaymentMethodError('');
            });


            $('#btnPlaceOrder').on('click', handleCheckout);
        });
    })(jQuery);
</script>
}

        <!-- Checkout Page Start -->
        <div class="container-fluid py-5">
            <div class="container py-5">
                <h1 class="mb-4">Thông tin thanh toán</h1>
                <form action="#">
                    <div class="row g-5">
                        <div class="col-md-12 col-lg-6 col-xl-6">
                            <div class="row">
                                <div class="col-md-12 col-lg-6">
                                    <div class="form-item w-100">
                                        <label class="form-label my-3">Họ <sup>*</sup></label>
                                        <input type="text" id="checkoutLastName" class="form-control" required>
                                    </div>
                                </div>
                                <div class="col-md-12 col-lg-6">
                                    <div class="form-item w-100">
                                        <label class="form-label my-3">Tên <sup>*</sup></label>
                                        <input type="text" id="checkoutFirstName" class="form-control" required>
                                    </div>
                                </div>
                            </div>
                            <div class="form-item">
                                <label class="form-label my-3">Địa chỉ giao hàng <sup>*</sup></label>
                                <input type="text" id="checkoutAddress" class="form-control" placeholder="Số nhà, tên đường" required>
                            </div>
                            <div class="row">
                                <div class="col-md-12 col-lg-6">
                                    <div class="form-item w-100">
                                        <label class="form-label my-3">Xã/ Phường <sup>*</sup></label>
                                        <select id="checkoutWard" class="form-control" required>
                                            <option value="">-- Chọn xã/phường --</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-12 col-lg-6">
                                    <div class="form-item w-100">
                                        <label class="form-label my-3">Tỉnh/ Thành phố <sup>*</sup></label>
                                        <select id="checkoutProvince" class="form-control" required>
                                            <option value="">-- Chọn tỉnh/thành phố --</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="form-item">
                                <label class="form-label my-3">Số điện thoại<sup>*</sup></label>
                                <input type="tel" id="checkoutPhone" class="form-control" required>
                            </div>
                            <div class="form-item">
                                <label class="form-label my-3">Địa chỉ email<sup>*</sup></label>
                                <input type="email" id="checkoutEmail" class="form-control" required>
                            </div>
                            <div class="form-item">
                                <label class="form-label my-3"></label>
                                <textarea id="checkoutNote" class="form-control" spellcheck="false" cols="30" rows="9" placeholder="Ghi chú đơn hàng (Tùy chọn)"></textarea>
                            </div>
                        </div>
                        <div class="col-md-12 col-lg-6 col-xl-6">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th scope="col">Sản phẩm</th>
                                            <th scope="col">Tên</th>
                                            <th scope="col">Giá</th>
                                            <th scope="col">Số lượng</th>
                                            <th scope="col">Thành tiền</th>
                                        </tr>
                                    </thead>
                                    <tbody id="checkoutCartBody">
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">Đang tải giỏ hàng...</td>
                                        </tr>
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <th scope="row"></th>
                                            <td class="py-0">
                                                <p class="mb-0 text-dark py-3">Tạm tính</p>
                                            </td>
                                            <td class="py-0"></td>
                                            <td class="py-0"></td>
                                            <td class="py-0">
                                                <div class="py-3">
                                                    <p class="mb-0 text-dark subtotal-amount" style="font-size: larger;">0 ₫</p>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th scope="row"></th>
                                            <td class="py-0">
                                                <p class="mb-0 text-dark py-3">Vận chuyển</p>
                                            </td>
                                            <td class="py-0"></td>
                                            <td class="py-0"></td>
                                            <td class="py-0">
                                                <div class="py-3">
                                                    <p class="mb-0 text-dark delivery-fee-amount" style="font-size: larger;">30,000 ₫</p>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th scope="row"></th>
                                            <td class="py-0">
                                                <p class="mb-0 text-dark text-uppercase py-3">TỔNG</p>
                                            </td>
                                            <td class="py-0"></td>
                                            <td class="py-0"></td>
                                            <td class="py-0">
                                                <div class="py-3">
                                                    <p class="mb-0 text-dark total-amount" style="font-size: larger;">0 ₫</p>
                                                </div>
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            <div class="row g-4 text-start py-3" style="margin-left: 15%;">
                                <p class="text-dark fw-bold mb-3" style="font-size: x-large;"><b>Chọn phương thức thanh toán</b></p>

                                <div class="col-12" style="margin-top: 0%; margin-left: 8%;">
                                    <div class="form-check my-2">
                                        <input type="radio" class="form-check-input bg-primary border-0" id="Payment-Transfer" name="PaymentMethod" value="Transfer">
                                        <label class="form-check-label" for="Payment-Transfer">Chuyển khoản ngân hàng</label>
                                    </div>

                                    <div class="form-check my-2">
                                        <input type="radio" class="form-check-input bg-primary border-0" id="Payment-COD" name="PaymentMethod" value="COD">
                                        <label class="form-check-label" for="Payment-COD">Thanh toán khi nhận hàng</label>
                                    </div>
                                    <div id="payment-method-error"></div>
                                </div>
                            </div>

                            <div class="row g-4 text-center align-items-center justify-content-center pt-4">
                                <button type="button" id="btnPlaceOrder" class="btn border-secondary py-3 px-4 text-uppercase w-100 text-primary">Đặt hàng</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <!-- Checkout Page End -->