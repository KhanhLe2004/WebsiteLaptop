@{
    ViewData["Title"] = "Quên mật khẩu";
    Layout = "~/Views/Shared/_LayoutForgetPassword.cshtml";
}
<div class="container-fluid auth-split px-0">
    <div class="row g-0">
      <!-- LEFT: ảnh / trang trí -->
      <div class="col-12 col-lg-6 auth-left">
        <!-- optional left content (slogan, logo) -->
        <img src="../LaptopFe/img/login.png" alt="Fruitables Logo" style="width:100%; height:auto;">
      </div>

      <!-- RIGHT: form -->
      <div class="col-12 col-lg-6 d-flex align-items-center justify-content-center py-5">
        <div class="auth-card">

          <div class="text-center mb-3">
            <div class="avatar-circle">
              <i class="bi bi-key" style="font-size:22px; color:var(--primary-dark)"></i>
            </div>

            <h1 class="h-welcome">Quên mật khẩu</h1>
            <div class="sub-muted">Nhập email đã đăng ký — chúng tôi sẽ gửi liên kết đặt lại</div>
          </div>

          <form id="forgotForm" novalidate>
            <div class="mb-3">
              <label class="form-label small">Email</label>
              <input id="email" type="email" class="form-control" placeholder="email@vd.com" required>
              <div id="emailErr" class="text-danger small mt-1" style="display:none;">Vui lòng nhập email hợp lệ</div>
            </div>

            <div class="d-grid mb-2">
              <button type="submit" class="btn btn-primary-accent">Gửi liên kết đặt lại</button>
            </div>

            <div class="text-center">
              <a href="@Url.Action("Login","User")" style="color:var(--primary); text-decoration:none;">Quay lại Đăng nhập</a>
            </div>

            <!-- Khu vực thông báo kết quả (mô phỏng) -->
            <div id="successBox" class="alert alert-success mt-3 d-none" role="alert">
              Liên kết đặt lại mật khẩu đã được gửi tới email của bạn.
            </div>
            <div id="forgotError" class="alert alert-danger mt-3 d-none" role="alert"></div>
          </form>

        </div>
      </div>
    </div>
  </div>

@section Scripts {
    <script type="text/javascript">
    (function() {

    // Get default API base URL
    function getDefaultApiBase() {
        if (window.AUTH_API_BASE && window.AUTH_API_BASE.trim()) {
            return window.AUTH_API_BASE.trim();
        }
        if (window.location && window.location.origin) {
            var origin = window.location.origin;
            if (origin.indexOf('localhost') === -1) {
                return origin;
            }
        }
        return 'http://localhost:5068';
    }

    var AUTH_API_BASE = getDefaultApiBase();
    var ENDPOINTS = {
        forgot: AUTH_API_BASE + '/api/FogetPasssword'
    };

        var emailRegex = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;


    function setAlert(element, type, message) {
        if (!element) {
            console.warn('setAlert: element is null');
            return;
        }
        element.textContent = message || '';
        element.className = 'alert alert-' + type;
        element.classList.remove('d-none');
        element.style.display = 'block';
    }

    function clearAlert(element) {
        if (!element) return;
        element.classList.add('d-none');
        element.textContent = '';
    }

    function parseJsonResponse(response) {
        return new Promise(function(resolve, reject) {
            var contentType = response.headers.get('content-type') || '';
            if (contentType.indexOf('application/json') !== -1) {
                response.json().then(function(data) {
                    resolve(data);
                }).catch(function(err) {
                    reject(new Error('Dữ liệu JSON không hợp lệ'));
                });
            } else {
                response.text().then(function(text) {
                    if (!text) {
                        resolve({});
                    } else {
                        try {
                            resolve(JSON.parse(text));
                        } catch (e) {
                            resolve({ message: text });
                        }
                    }
                });
            }
        });
    }

    function disableButton(button, loadingText) {
        if (!button) return function() { };
        var original = button.innerHTML;
        button.disabled = true;
        button.innerHTML = loadingText;
        return function() {
            button.disabled = false;
            button.innerHTML = original;
        };
    }

    // ========== FORGOT PASSWORD ==========
    var forgotForm = document.getElementById('forgotForm');
    if (forgotForm) {
        var emailInput = document.getElementById('email');
        var emailErr = document.getElementById('emailErr');
        var successBox = document.getElementById('successBox');
        var forgotError = document.getElementById('forgotError');

        forgotForm.addEventListener('submit', function(e) {
            e.preventDefault();
            if (emailErr) {
                emailErr.classList.add('d-none');
                emailErr.style.display = 'none';
            }
            if (emailInput) {
                emailInput.classList.remove('is-invalid');
            }
            clearAlert(successBox);
            clearAlert(forgotError);

            var email = emailInput ? emailInput.value.trim() : '';
            if (!emailRegex.test(email)) {
                if (emailInput) emailInput.classList.add('is-invalid');
                if (emailErr) {
                    emailErr.textContent = 'Vui lòng nhập email hợp lệ';
                    emailErr.style.display = 'block';
                }
                return;
            }

            var submitBtn = forgotForm.querySelector('button[type="submit"]');
            var restoreBtn = disableButton(submitBtn, '<span class="spinner-border spinner-border-sm me-2"></span>Đang gửi...');

            fetch(ENDPOINTS.forgot, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email })
            })
            .then(function(response) {
                return parseJsonResponse(response).then(function(data) {
                    return { ok: response.ok, status: response.status, data: data };
                });
            })
            .then(function(result) {
                var data = result.data;
                
                // Kiểm tra nếu có lỗi (status 404, 400, 500, etc.)
                if (!result.ok || (data && data.error)) {
                    var errorMsg = data && data.message ? data.message : (data && data.error ? data.error : 'Không thể gửi yêu cầu');
                    throw new Error(errorMsg);
                }

                // Thành công
                if (successBox) {
                    setAlert(successBox, 'success', data && data.message ? data.message : 'Mật khẩu mới đã được gửi đến email của bạn. Vui lòng kiểm tra hộp thư.');
                }
                forgotForm.reset();
            })
            .catch(function(error) {
                console.error('Forgot password error:', error);
                if (forgotError) {
                    setAlert(forgotError, 'danger', error.message || 'Không thể xử lý yêu cầu');
                }
            })
            .finally(function() {
                restoreBtn();
            });
        });
    }
    })();
    </script>
}