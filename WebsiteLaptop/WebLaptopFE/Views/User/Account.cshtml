@{
    ViewData["Title"] = "Thông tin tài khoản";
    Layout = "~/Views/Shared/_LayoutAccount.cshtml";
}
<!-- Kiểm tra đăng nhập ngay đầu trang (không cần jQuery) -->
<script>
    (function() {
        'use strict';
        try {
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');
            const customer = sessionStorage.getItem('customer');
            if (!isLoggedIn || isLoggedIn !== 'true' || !customer) {
                window.location.replace('/User/Login');
            }
        } catch (err) {
            console.error('Session storage check failed:', err);
            window.location.replace('/User/Login');
        }
    })();
</script>

<div class="pt-5"></div>
<div class="container py-5">
    <div class="row g-4">
      <!-- Sidebar tài khoản -->
      <aside class="col-lg-3">
        <div class="card shadow-sm account-sidebar">
          <div class="card-body text-center">
            <div class="avatar-preview mx-auto mb-3">
              <img id="avatarImg" src="../LaptopFe/img/avatar.jpg" alt="avatar" class="rounded-circle" style="width:96px;height:96px;object-fit:cover; border:3px solid rgba(129,196,8,0.12);">
            </div>
            <h5 id="userName">Tên khách hàng</h5>
            <p class="text-muted small mb-3">username</p>
            <button class="btn btn-outline-secondary btn-sm w-100 mb-2" id="btnUploadAvatar"><i class="fas fa-camera"></i> Thay ảnh</button>
            <input id="avatarInput" type="file" accept="image/*" style="display:none">

            <hr>

            <nav class="nav flex-column account-menu">
              <a href="#tab-profile" class="nav-link active" data-bs-toggle="tab"><i class="fas fa-user-edit me-2"></i> Thông tin cá nhân</a>
              <a href="#tab-your-orders" class="nav-link position-relative" data-bs-toggle="tab">
                <i class="fas fa-shopping-cart me-2 position-relative">
                  <span id="orderCountBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-circle bg-warning text-dark" style="display: none; font-size: 0.65rem; padding: 2px 5px; min-width: 18px; height: 18px; line-height: 1.2; font-weight: 600;">0</span>
                </i>
                Đơn hàng của bạn
              </a>
              <a href="#tab-history" class="nav-link" data-bs-toggle="tab"><i class="fas fa-box-open me-2"></i> Lịch sử mua hàng</a>
              <a href="#" class="nav-link text-danger" id="btnLogout"><i class="fas fa-sign-out-alt me-2"></i> Đăng xuất</a>
            </nav>
          </div>
        </div>
      </aside>

      <main class="col-lg-9">
        <div class="card shadow-sm">
          <div class="card-body tab-content">
            <div id="accountAlert" class="alert d-none" role="alert"></div>

            <!-- Thông tin cá nhân -->
            <div class="tab-pane fade show active" id="tab-profile">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">Thông tin cá nhân</h4>
                <button id="toggleEditProfile" class="btn btn-outline-secondary btn-sm">Chỉnh sửa</button>
              </div>
              <form id="profileForm">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label small">Họ và tên</label>
                    <input type="text" name="fullname" class="form-control" disabled>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label small">Ngày sinh</label>
                    <div class="d-flex">
                      <select id="birthDay" class="form-select me-1" disabled></select>
                      <select id="birthMonth" class="form-select me-1" disabled></select>
                      <select id="birthYear" class="form-select" disabled></select>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label small">Email</label>
                    <input type="email" name="email" class="form-control" disabled>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label small">Số điện thoại</label>
                    <input type="text" name="phone" class="form-control" disabled>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label small">Tỉnh / Thành phố</label>
                    <div class="autocomplete-wrapper position-relative">
                      <input type="text" id="province" class="form-control" autocomplete="off" disabled>
                      <input type="hidden" id="provinceValue" value="">
                      <div id="provinceDropdown" class="autocomplete-dropdown"></div>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label small">Xã / Phường</label>
                    <div class="autocomplete-wrapper position-relative">
                      <input type="text" id="ward" class="form-control" autocomplete="off" disabled>
                      <input type="hidden" id="wardValue" value="">
                      <div id="wardDropdown" class="autocomplete-dropdown"></div>
                    </div>
                  </div>

                  <div class="col-12">
                    <label class="form-label small">Địa chỉ chi tiết</label>
                    <input type="text" id="detailAddress" class="form-control" disabled>
                  </div>

                  <div class="col-12 text-end">
                    <button type="submit" class="btn btn-primary" disabled>Lưu thay đổi</button>
                  </div>
                </div>
              </form>

              <div id="changePasswordSection">
                <hr class="my-4">

                <h5>Đổi mật khẩu</h5>
                <div id="passwordAlert" class="alert d-none" role="alert"></div>
                <form id="passwordForm" class="row g-3 mt-2">
                  <div class="col-md-6">
                    <label class="form-label small">Mật khẩu hiện tại</label>
                    <input type="password" name="current" class="form-control" required>
                  </div>
                  <div class="col-md-6"></div>
                  <div class="col-md-6">
                    <label class="form-label small">Mật khẩu mới</label>
                    <input type="password" name="new" class="form-control" required>
                    <small class="text-muted">Tối thiểu 6 ký tự, gồm chữ và số</small>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label small">Xác nhận mật khẩu mới</label>
                    <input type="password" name="confirm" class="form-control" required>
                  </div>
                  <div class="col-12 text-end">
                    <button type="submit" class="btn btn-success">Cập nhật mật khẩu</button>
                  </div>
                </form>
              </div>
            </div>

            <!-- Đơn hàng của bạn -->
            <div class="tab-pane fade" id="tab-your-orders">
              <h4>Đơn hàng của bạn</h4>
              <div class="table-responsive mt-3">
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th class="text-center">Mã đơn hàng</th>
                      <th class="text-center">Sản phẩm</th>
                      <th class="text-center">Ngày đặt</th>
                      <th class="text-center">Trạng thái</th>
                      <th class="text-center">Tổng</th>
                      <th class="text-center">Hành động</th>
                    </tr>
                  </thead>
                  <tbody id="yourOrdersBody">
                    <tr>
                      <td colspan="6" class="text-center text-muted">Đang tải dữ liệu...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Lịch sử mua hàng (chỉ 'hoàn thành') -->
            <div class="tab-pane fade" id="tab-history">
              <h4>Lịch sử mua hàng</h4>
              <div class="table-responsive mt-3">
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th class="text-center">Mã đơn hàng</th>
                      <th class="text-center">Sản phẩm</th>
                      <th class="text-center">Thời gian</th>
                      <th class="text-center">Trạng thái</th>
                      <th class="text-center">Tổng</th>
                      <th class="text-center">Hành động</th>
                    </tr>
                  </thead>
                  <tbody id="orderHistoryBody">
                    <tr>
                      <td colspan="6" class="text-center text-muted">Đang tải dữ liệu...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Modal (tĩnh) -->
  <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Chi tiết đơn hàng</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="orderDetailContent"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        </div>
      </div>
    </div>
  </div>

@section Scripts {
<style>
    /* Order product image styling */
    .order-product-image {
        width: 70px;
        height: 70px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .order-product-image:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.12);
    }
    
    /* Order product name styling */
    .order-product-name {
        font-size: 0.95rem;
        color: #333;
        line-height: 1.4;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    /* Order products list styling */
    .order-products-list {
        max-width: 100%;
    }
    
    .order-products-list .order-product-image {
        width: 60px;
        height: 60px;
    }
    
    /* Table cell styling for product column */
    #yourOrdersBody td {
        vertical-align: middle;
        padding: 12px 8px;
    }
    
    /* Center align all cells except product column */
    #yourOrdersBody td:not(:nth-child(2)) {
        text-align: center;
    }
    
    /* Ensure consistent spacing */
    #yourOrdersBody tr {
        border-bottom: 1px solid #f0f0f0;
    }
    
    #yourOrdersBody tr:hover {
        background-color: #f8f9fa;
    }
    
    /* Status badge spacing */
    #yourOrdersBody .badge {
        font-size: 0.85rem;
        padding: 6px 10px;
    }
    
    /* Action buttons styling */
    #yourOrdersBody .btn {
        white-space: nowrap;
        font-size: 0.875rem;
        min-width: 100px;
    }
    
    /* Action column styling */
    #yourOrdersBody td:last-child {
        text-align: center;
    }
    
    /* Action buttons container */
    #yourOrdersBody .d-flex.flex-column {
        align-items: center;
        justify-content: center;
    }
    
    /* Table header center alignment */
    #yourOrdersBody thead th {
        text-align: center;
        vertical-align: middle;
    }
    
    /* Center align for specific columns */
    #yourOrdersBody td.text-center {
        text-align: center;
        vertical-align: middle;
    }
    
    /* Order products list styling */
    .order-products-list {
        max-width: 100%;
    }
    
    .order-products-list .order-product-image {
        width: 60px;
        height: 60px;
    }
    
    /* Toggle button styling */
    .toggle-products-btn {
        font-size: 0.85rem;
        text-decoration: none;
        transition: all 0.2s ease;
        border: none;
        background: none;
        color: #0d6efd;
        cursor: pointer;
        padding: 4px 0;
    }
    
    .toggle-products-btn:hover {
        text-decoration: underline;
        color: #0a58ca;
    }
    
    .toggle-products-btn i {
        transition: transform 0.3s ease;
        display: inline-block;
    }
    
    /* Hidden products animation */
    .order-products-hidden {
        animation: fadeIn 0.3s ease;
    }
    
     @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Responsive adjustments */
     @@media (max-width: 768px) {
        .order-product-image {
            width: 60px;
            height: 60px;
        }
        
        .order-product-name {
            font-size: 0.85rem;
        }
        
        #yourOrdersBody .btn {
            min-width: 80px;
            font-size: 0.8rem;
            padding: 4px 8px;
        }
    }
</style>
<script>
    (function ($) {
        'use strict';
        
        // Cấu hình API
        const getDefaultApiBase = () => {
            if (window.CUSTOMER_API_BASE && window.CUSTOMER_API_BASE.trim()) {
                return window.CUSTOMER_API_BASE.trim();
            }
            if (window.location && window.location.origin) {
                const origin = window.location.origin;
                if (!origin.includes('localhost')) {
                    return origin;
                }
            }
            return 'http://localhost:5068';
        };

        const API_BASE = getDefaultApiBase();
        const CUSTOMER_API_BASE = `${API_BASE}/api/CustomerAccount`;
        const ADDRESS_API_BASE = window.ADDRESS_API_BASE || `${API_BASE}/api/Address`;

        // Lấy customerId từ session
        function resolveSessionCustomerId() {
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');
            const raw = sessionStorage.getItem('customer');
            if (isLoggedIn !== 'true' || !raw) return null;
            try {
                const parsed = JSON.parse(raw);
                return parsed.customerId || parsed.CustomerId || null;
            } catch (err) {
                console.error('Cannot parse customer info', err);
                return null;
            }
        }

        const currentCustomerId = resolveSessionCustomerId();
        if (!currentCustomerId) {
            window.location.replace('/User/Login');
            return;
        }

        // Biến global
        let provinces = [];
        const wardsCache = new Map();
        const $accountAlert = $('#accountAlert');
        const $passwordAlert = $('#passwordAlert');

        // Helper functions - Toast notification với nền trắng
        function showAlert(type, message) {
            // Tạo toast notification ở góc trên bên phải
            const toastId = 'toast-' + Date.now();
            const iconMap = {
                'success': '<i class="fa fa-check-circle me-2"></i>',
                'danger': '<i class="fa fa-times-circle me-2"></i>',
                'warning': '<i class="fa fa-exclamation-triangle me-2"></i>',
                'info': '<i class="fa fa-info-circle me-2"></i>'
            };
            const icon = iconMap[type] || '';
            
            const toastHtml = `
                <div id="${toastId}" class="toast-notification toast-${type}" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header bg-${type === 'danger' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'} text-white">
                        ${icon}
                        <strong class="me-auto">Thông báo</strong>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;
            
            // Tạo container nếu chưa có
            if ($('#toast-container').length === 0) {
                $('body').append('<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>');
            }
            
            $('#toast-container').append(toastHtml);
            
            // Khởi tạo và hiển thị toast
            const toastElement = document.getElementById(toastId);
            if (toastElement) {
                const toast = new bootstrap.Toast(toastElement, {
                    autohide: true,
                    delay: 4000
                });
                toast.show();
                
                // Xóa toast khỏi DOM sau khi ẩn
                toastElement.addEventListener('hidden.bs.toast', function() {
                    $(this).remove();
                });
            }
        }

        function clearAlert() {
            // Không cần làm gì vì toast tự động ẩn
        }

        function showPasswordAlert(type, message) {
            // Sử dụng cùng toast notification
            showAlert(type, message);
        }

        function clearPasswordAlert() {
            // Không cần làm gì vì toast tự động ẩn
        }

        // Date of birth helpers
        function loadBirthDropdowns() {
            const $day = $('#birthDay');
            const $month = $('#birthMonth');
            const $year = $('#birthYear');
            if (!$day.length || !$month.length || !$year.length) return;

            $day.empty().append('<option value="">Ngày</option>');
            $month.empty().append('<option value="">Tháng</option>');
            $year.empty().append('<option value="">Năm</option>');

            for (let d = 1; d <= 31; d++) $day.append(new Option(d, d));
            for (let m = 1; m <= 12; m++) $month.append(new Option(m, m));

            const currentYear = new Date().getFullYear();
            for (let y = currentYear; y >= 1900; y--) $year.append(new Option(y, y));
        }

        function setDateOfBirth(value) {
            if (!value) {
                $('#birthDay, #birthMonth, #birthYear').val('');
                return;
            }
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return;
            $('#birthDay').val(date.getDate());
            $('#birthMonth').val(date.getMonth() + 1);
            $('#birthYear').val(date.getFullYear());
        }

        function collectDateOfBirth() {
            const day = $('#birthDay').val();
            const month = $('#birthMonth').val();
            const year = $('#birthYear').val();
            if (!day || !month || !year) return null;
            return `${year.toString().padStart(4, '0')}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        }

        // Address helpers
        async function loadProvinces(force = false) {
            if (provinces.length && !force) {
                initializeProvinceAutocomplete();
                return provinces;
            }
            try {
                console.log('Loading provinces from:', `${ADDRESS_API_BASE}/provinces`);
                const response = await fetch(`${ADDRESS_API_BASE}/provinces`, { 
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Province API error:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('Provinces data received:', data);
                
                const list = Array.isArray(data) ? data : [];
                provinces = list.map(item => ({
                    code: String(item.code || item.provinceCode || item.id || '').trim(),
                    name: String(item.name || item.provinceName || '').trim()
                })).filter(p => p.code && p.name);

                console.log('Processed provinces:', provinces.length);
                initializeProvinceAutocomplete();
                return provinces;
            } catch (err) {
                console.error('loadProvinces error:', err);
                showAlert('danger', 'Không thể tải danh sách tỉnh/thành phố. Vui lòng thử lại sau.');
                return [];
            }
        }

        // Load wards trực tiếp từ province code (sau sáp nhập, chỉ còn 2 cấp)
        async function loadWardsByProvince(provinceCode, preserveWardValue = false) {
            const $ward = $('#ward');
            if (!$ward.length) return;
            
            // Lưu giá trị hiện tại nếu cần preserve
            const currentWardName = preserveWardValue ? $ward.val() : '';
            const currentWardCode = preserveWardValue ? $('#wardValue').val() : '';
            
            $ward.prop('disabled', true).attr('placeholder', 'Đang tải...');
            if (!preserveWardValue) {
                $ward.val('');
                $('#wardValue').val('');
            }
            
            if (!provinceCode) {
                $ward.prop('disabled', true).val('').attr('placeholder', 'Tìm kiếm xã/phường...');
                $('#wardValue').val('');
                return;
            }

            // Kiểm tra cache
            if (wardsCache.has(provinceCode)) {
                initializeWardAutocomplete(wardsCache.get(provinceCode));
                // Khôi phục giá trị nếu cần
                if (preserveWardValue && currentWardName) {
                    $ward.val(currentWardName);
                    $('#wardValue').val(currentWardCode);
                }
                return;
            }

            try {
                console.log('Loading wards for province:', provinceCode);
                const response = await fetch(`${ADDRESS_API_BASE}/wards/${provinceCode}`, { 
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Ward API error:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('Wards data received:', data);
                
                const list = Array.isArray(data) ? data : [];
                const wards = list.map(w => ({
                    code: String(w.code || w.id || '').trim(),
                    name: String(w.name || w.wardName || '').trim()
                })).filter(w => w.code && w.name);
                
                console.log('Processed wards:', wards.length);
                wardsCache.set(provinceCode, wards);
                initializeWardAutocomplete(wards);
                // Khôi phục giá trị nếu cần
                if (preserveWardValue && currentWardName) {
                    $ward.val(currentWardName);
                    $('#wardValue').val(currentWardCode);
                }
            } catch (err) {
                console.error('loadWards error:', err);
                $ward.prop('disabled', true).val('').attr('placeholder', 'Không thể tải xã/phường');
            }
        }

        // Khởi tạo autocomplete cho tỉnh/thành
        function initializeProvinceAutocomplete() {
            const provinceInput = $('#province');
            const provinceValue = $('#provinceValue');
            const dropdown = $('#provinceDropdown');
            let selectedIndex = -1;
            let filteredProvinces = [];

            function showDropdown(provincesList) {
                if (!provincesList || provincesList.length === 0) {
                    dropdown.html('<div class="autocomplete-item" style="color: #6c757d; cursor: default;">Không tìm thấy tỉnh/thành</div>').show();
                    selectedIndex = -1;
                    return;
                }

                let html = '';
                provincesList.forEach((province, index) => {
                    const provinceName = province.name || province.code;
                    const provinceNameEscaped = (provinceName || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    html += `<div class="autocomplete-item" data-index="${index}" data-province-code="${province.code}" data-province-name="${provinceNameEscaped}">${provinceName}</div>`;
                });
                dropdown.html(html).show();
                selectedIndex = -1;
            }

            function updateSelectedItem() {
                $('#provinceDropdown .autocomplete-item').removeClass('selected');
                if (selectedIndex >= 0 && selectedIndex < filteredProvinces.length) {
                    $('#provinceDropdown .autocomplete-item').eq(selectedIndex).addClass('selected');
                }
            }

            // Xử lý khi gõ
            provinceInput.off('input.province').on('input.province', function() {
                const searchTerm = $(this).val().toLowerCase().trim();
                
                if (searchTerm === '') {
                    dropdown.hide();
                    provinceValue.val('');
                    $('#ward').prop('disabled', true).val('').attr('placeholder', 'Tìm kiếm xã/phường...');
                    $('#wardValue').val('');
                    return;
                }

                filteredProvinces = provinces.filter(p => {
                    const provinceName = (p.name || p.code || '').toLowerCase();
                    return provinceName.includes(searchTerm);
                });

                showDropdown(filteredProvinces);
            });

            // Xử lý khi click vào item
            $(document).off('click.province-item').on('click.province-item', '#provinceDropdown .autocomplete-item', function() {
                const provinceCode = $(this).data('province-code');
                const provinceName = $(this).data('province-name');
                
                if (provinceCode && provinceName) {
                    provinceInput.val(provinceName);
                    provinceValue.val(provinceCode);
                    dropdown.hide();
                    loadWardsByProvince(provinceCode);
                }
            });

            // Xử lý phím tắt
            provinceInput.off('keydown.province').on('keydown.province', function(e) {
                if (dropdown.is(':visible') && filteredProvinces.length > 0) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        selectedIndex = Math.min(selectedIndex + 1, filteredProvinces.length - 1);
                        updateSelectedItem();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        selectedIndex = Math.max(selectedIndex - 1, -1);
                        updateSelectedItem();
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (selectedIndex >= 0 && selectedIndex < filteredProvinces.length) {
                            const province = filteredProvinces[selectedIndex];
                            provinceInput.val(province.name || province.code);
                            provinceValue.val(province.code);
                            dropdown.hide();
                            loadWardsByProvince(province.code);
                        }
                    } else if (e.key === 'Escape') {
                        dropdown.hide();
                        selectedIndex = -1;
                    }
                }
            });

            // Ẩn dropdown khi click ra ngoài
            $(document).off('click.province-close').on('click.province-close', function(e) {
                if (!$(e.target).closest('#province').closest('.autocomplete-wrapper').length) {
                    dropdown.hide();
                    selectedIndex = -1;
                }
            });

            // Xử lý khi focus vào input
            provinceInput.off('focus.province').on('focus.province', function() {
                const val = $(this).val().trim();
                if (val) {
                    $(this).trigger('input.province');
                } else {
                    if (provinces.length > 0) {
                        filteredProvinces = provinces;
                        showDropdown(filteredProvinces);
                    }
                }
            });
        }

        // Khởi tạo autocomplete cho phường/xã
        function initializeWardAutocomplete(wardsList) {
            const wardInput = $('#ward');
            const wardValue = $('#wardValue');
            const dropdown = $('#wardDropdown');
            let selectedIndex = -1;
            let filteredWards = [];

            if (!wardsList || wardsList.length === 0) {
                wardInput.prop('disabled', true).val('').attr('placeholder', 'Không có dữ liệu');
                return;
            }

            wardInput.prop('disabled', false).attr('placeholder', 'Tìm kiếm xã/phường...');

            function showDropdown(wards) {
                if (!wards || wards.length === 0) {
                    dropdown.html('<div class="autocomplete-item" style="color: #6c757d; cursor: default;">Không tìm thấy xã/phường</div>').show();
                    selectedIndex = -1;
                    return;
                }

                let html = '';
                wards.forEach((ward, index) => {
                    const wardName = ward.name || ward.code;
                    const wardNameEscaped = (wardName || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    html += `<div class="autocomplete-item" data-index="${index}" data-ward-code="${ward.code}" data-ward-name="${wardNameEscaped}">${wardName}</div>`;
                });
                dropdown.html(html).show();
                selectedIndex = -1;
            }

            function updateSelectedItem() {
                $('#wardDropdown .autocomplete-item').removeClass('selected');
                if (selectedIndex >= 0 && selectedIndex < filteredWards.length) {
                    $('#wardDropdown .autocomplete-item').eq(selectedIndex).addClass('selected');
                }
            }

            // Xử lý khi gõ
            wardInput.off('input.ward').on('input.ward', function() {
                const searchTerm = $(this).val().toLowerCase().trim();
                
                if (searchTerm === '') {
                    dropdown.hide();
                    wardValue.val('');
                    return;
                }

                filteredWards = wardsList.filter(w => {
                    const wardName = (w.name || w.code || '').toLowerCase();
                    return wardName.includes(searchTerm);
                });

                showDropdown(filteredWards);
            });

            // Xử lý khi click vào item
            $(document).off('click.ward-item').on('click.ward-item', '#wardDropdown .autocomplete-item', function() {
                const wardCode = $(this).data('ward-code');
                const wardName = $(this).data('ward-name');
                
                if (wardCode && wardName) {
                    wardInput.val(wardName);
                    wardValue.val(wardCode);
                    dropdown.hide();
                }
            });

            // Xử lý phím tắt
            wardInput.off('keydown.ward').on('keydown.ward', function(e) {
                if (dropdown.is(':visible') && filteredWards.length > 0) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        selectedIndex = Math.min(selectedIndex + 1, filteredWards.length - 1);
                        updateSelectedItem();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        selectedIndex = Math.max(selectedIndex - 1, -1);
                        updateSelectedItem();
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (selectedIndex >= 0 && selectedIndex < filteredWards.length) {
                            const ward = filteredWards[selectedIndex];
                            wardInput.val(ward.name || ward.code);
                            wardValue.val(ward.code);
                            dropdown.hide();
                        }
                    } else if (e.key === 'Escape') {
                        dropdown.hide();
                        selectedIndex = -1;
                    }
                }
            });

            // Ẩn dropdown khi click ra ngoài
            $(document).off('click.ward-close').on('click.ward-close', function(e) {
                if (!$(e.target).closest('#ward').closest('.autocomplete-wrapper').length) {
                    dropdown.hide();
                    selectedIndex = -1;
                }
            });

            // Xử lý khi focus vào input
            wardInput.off('focus.ward').on('focus.ward', function() {
                const val = $(this).val().trim();
                if (val) {
                    $(this).trigger('input.ward');
                } else {
                    if (wardsList.length > 0) {
                        filteredWards = wardsList;
                        showDropdown(filteredWards);
                    }
                }
            });
        }

        // Customer profile functions
        async function loadCustomerData() {
            if (!currentCustomerId) {
                showAlert('danger', 'Không tìm thấy thông tin khách hàng. Vui lòng đăng nhập lại.');
                return;
            }
            try {
                // Đảm bảo provinces đã được load trước
                await loadProvinces();
                
                const url = `${CUSTOMER_API_BASE}/${currentCustomerId}`;
                const response = await fetch(url, { credentials: 'same-origin' });
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage = 'Không thể tải thông tin khách hàng';
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }
                const data = await response.json();
                await populateProfileForm(data);
            } catch (err) {
                console.error('loadCustomerData error:', err);
                showAlert('danger', err.message || 'Không thể tải thông tin khách hàng');
            }
        }

        // Parse địa chỉ từ chuỗi đầy đủ
        function parseAddress(fullAddress) {
            if (!fullAddress || typeof fullAddress !== 'string') {
                return { detailAddress: '', provinceName: '', wardName: '' };
            }

            const parts = fullAddress.split(',').map(p => p.trim()).filter(p => p);
            if (parts.length === 0) {
                return { detailAddress: fullAddress, provinceName: '', wardName: '' };
            }

            let detailAddress = '';
            let wardName = '';
            let provinceName = '';

            // Phần cuối thường là tỉnh/thành phố
            if (parts.length >= 1) {
                provinceName = parts[parts.length - 1];
            }
            // Phần giữa thường là phường/xã
            if (parts.length >= 2) {
                wardName = parts[parts.length - 2];
            }
            
            // Kiểm tra xem phần đầu có phải là địa chỉ chi tiết thực sự không
            // Nếu chỉ có 2 phần và phần đầu có vẻ là tên phường/xã thì không lấy làm địa chỉ chi tiết
            if (parts.length >= 3) {
                detailAddress = parts.slice(0, parts.length - 2).join(', ');
            } else if (parts.length === 2) {
                const firstPart = parts[0].toLowerCase();
                // Kiểm tra xem phần đầu có phải là tên phường/xã không
                if (firstPart.includes('phường') || firstPart.includes('xã') || 
                    firstPart.includes('thị trấn') || firstPart.includes('thị xã') ||
                    firstPart.includes('ward') || firstPart.includes('commune')) {
                    // Nếu là tên phường/xã thì không lấy làm địa chỉ chi tiết
                    detailAddress = '';
                } else {
                    // Nếu không phải tên phường/xã thì có thể là địa chỉ chi tiết
                    detailAddress = parts[0];
                }
            } else if (parts.length === 1) {
                const singlePart = parts[0].toLowerCase();
                // Nếu chỉ có 1 phần và có vẻ là tên tỉnh/phường thì không lấy làm địa chỉ chi tiết
                if (singlePart.includes('phường') || singlePart.includes('xã') || 
                    singlePart.includes('thành phố') || singlePart.includes('tỉnh') ||
                    singlePart.includes('thị trấn') || singlePart.includes('thị xã')) {
                    detailAddress = '';
                } else {
                    detailAddress = parts[0];
                }
            }

            console.log('Parse address result:', {
                fullAddress,
                parts,
                detailAddress,
                wardName,
                provinceName
            });

            return {
                detailAddress: detailAddress,
                provinceName: provinceName,
                wardName: wardName
            };
        }

        // Tìm province code từ tên
        function findProvinceCode(provinceName) {
            if (!provinceName || provinces.length === 0) return '';
            const matchedProvince = provinces.find(p => 
                p.name.toLowerCase().includes(provinceName.toLowerCase()) ||
                provinceName.toLowerCase().includes(p.name.toLowerCase())
            );
            return matchedProvince ? matchedProvince.code : '';
        }

        // Tìm ward code từ tên (sau khi wards đã được load)
        function findWardCode(wardName, provinceCode) {
            if (!wardName || !provinceCode || !wardsCache.has(provinceCode)) return '';
            const wards = wardsCache.get(provinceCode);
            const matchedWard = wards.find(w =>
                w.name.toLowerCase().includes(wardName.toLowerCase()) ||
                wardName.toLowerCase().includes(w.name.toLowerCase())
            );
            return matchedWard ? matchedWard.code : '';
        }

        async function populateProfileForm(customer) {
            $('input[name=fullname]').val(customer?.customerName || customer?.CustomerName || '');
            $('input[name=email]').val(customer?.email || customer?.Email || '');
            $('input[name=phone]').val(customer?.phoneNumber || customer?.PhoneNumber || '');
            setDateOfBirth(customer?.dateOfBirth || customer?.DateOfBirth);

            // Kiểm tra loại đăng nhập để ẩn/hiện phần đổi mật khẩu
            const isOAuthLogin = customer?.isOAuthLogin || customer?.IsOAuthLogin || false;
            
            if (isOAuthLogin) {
                // Ẩn phần đổi mật khẩu nếu đăng nhập bằng Google/Facebook
                $('#changePasswordSection').hide();
                console.log('OAuth login detected, hiding password change section');
            } else {
                // Hiện phần đổi mật khẩu nếu đăng nhập bằng email/password
                $('#changePasswordSection').show();
                console.log('Regular login detected, showing password change section');
            }

            // Xử lý avatar - lấy từ imageCustomers nếu có
            const defaultAvatar = '../LaptopFe/img/avatar.jpg';
            const avatarFileName = customer?.avatar || customer?.Avatar;
            console.log('Avatar from customer data:', avatarFileName);
            
            const $avatarImg = $('#avatarImg');
            $avatarImg.off('error'); // Xóa event handler cũ nếu có
            
            // Hàm thử load ảnh với nhiều đường dẫn khác nhau
            function tryLoadAvatar(paths, index = 0) {
                if (index >= paths.length) {
                    console.log('All avatar paths failed, using default');
                    $avatarImg.attr('src', defaultAvatar);
                    return;
                }
                
                const currentPath = paths[index];
                console.log(`Trying avatar path ${index + 1}/${paths.length}:`, currentPath);
                
                const img = new Image();
                img.onload = function() {
                    console.log('Avatar loaded successfully from:', currentPath);
                    $avatarImg.attr('src', currentPath);
                };
                img.onerror = function() {
                    console.log('Avatar load failed from:', currentPath);
                    tryLoadAvatar(paths, index + 1);
                };
                img.src = currentPath;
            }
            
            // Tạo danh sách các đường dẫn để thử
            const avatarPaths = [];
            
            if (avatarFileName && avatarFileName.trim()) {
                // Nếu avatar là tên file (không có đường dẫn)
                if (!avatarFileName.includes('/') && !avatarFileName.includes('\\') && !avatarFileName.startsWith('http')) {
                    // Thử các đường dẫn khác nhau theo thứ tự ưu tiên
                    avatarPaths.push(`/imageCustomers/${avatarFileName}`); // Tuyệt đối từ root (wwwroot)
                    avatarPaths.push(`../imageCustomers/${avatarFileName}`); // Tương đối
                    // Nếu có API_BASE và khác với origin hiện tại, thử từ BE
                    if (API_BASE && window.location && !API_BASE.includes(window.location.origin)) {
                        avatarPaths.push(`${API_BASE.replace('/api/CustomerAccount', '')}/imageCustomers/${avatarFileName}`);
                    }
                } else if (avatarFileName.startsWith('http')) {
                    // URL đầy đủ
                    avatarPaths.push(avatarFileName);
                } else {
                    // Đường dẫn tương đối hoặc đầy đủ
                    avatarPaths.push(avatarFileName);
                }
            }
            
            // Luôn thêm default avatar vào cuối
            avatarPaths.push(defaultAvatar);
            
            // Thử load ảnh
            tryLoadAvatar(avatarPaths);
            $('#userName').text(customer?.customerName || customer?.CustomerName || 'Tên khách hàng');
            $('.text-muted.small').first().text(customer?.username || customer?.Username || 'username');

            // Parse và điền địa chỉ
            const fullAddress = customer?.address || customer?.Address || '';
            if (fullAddress) {
                const parsed = parseAddress(fullAddress);
                $('#detailAddress').val(parsed.detailAddress);
                
                if (parsed.provinceName) {
                    const provinceCode = findProvinceCode(parsed.provinceName);
                    if (provinceCode) {
                        const province = provinces.find(p => p.code === provinceCode);
                        if (province) {
                            $('#province').val(province.name);
                            $('#provinceValue').val(provinceCode);
                        }
                        // Load wards cho province này
                        await loadWardsByProvince(provinceCode);
                        // Sau khi load xong, tìm và set ward code
                        if (parsed.wardName) {
                            const wardCode = findWardCode(parsed.wardName, provinceCode);
                            if (wardCode) {
                                const wards = wardsCache.get(provinceCode);
                                const ward = wards?.find(w => w.code === wardCode);
                                if (ward) {
                                    $('#ward').val(ward.name);
                                    $('#wardValue').val(wardCode);
                                }
                            } else {
                                // Nếu không tìm thấy code, vẫn hiển thị tên
                                $('#ward').val(parsed.wardName);
                            }
                        }
                    } else {
                        // Nếu không tìm thấy code, vẫn hiển thị tên
                        $('#province').val(parsed.provinceName);
                    }
                }
            } else {
                $('#detailAddress').val('');
            }

            disableProfileForm();
        }

        function disableProfileForm() {
            $('#profileForm input, #profileForm select, #profileForm button[type=submit]').prop('disabled', true);
            $('#toggleEditProfile').text('Chỉnh sửa');
        }

        function enableProfileForm() {
            $('#profileForm input, #profileForm select, #profileForm button[type=submit]').prop('disabled', false);
            $('#toggleEditProfile').text('Hủy');
        }

        function collectProfilePayload() {
            const fullName = $('input[name=fullname]').val()?.toString().trim();
            const email = $('input[name=email]').val()?.toString().trim();
            const phone = $('input[name=phone]').val()?.toString().trim();
            const detailAddress = $('#detailAddress').val()?.toString().trim();
            
            // Lấy tên hiển thị từ input (không phải hidden value)
            const provinceName = $('#province').val()?.toString().trim();
            const wardName = $('#ward').val()?.toString().trim();

            // Tạo địa chỉ đầy đủ từ các phần
            // Chỉ tạo địa chỉ khi có ít nhất một trong các thành phần
            let address = null;
            
            // Nếu có địa chỉ chi tiết, tỉnh, hoặc phường thì tạo địa chỉ
            if ((detailAddress && detailAddress !== '') || 
                (provinceName && provinceName !== '') || 
                (wardName && wardName !== '')) {
                
                let addressParts = [];
                
                // Thêm địa chỉ chi tiết trước (nếu có)
                if (detailAddress && detailAddress !== '') {
                    addressParts.push(detailAddress);
                }
                
                // Thêm phường/xã (nếu có)
                if (wardName && wardName !== '') {
                    addressParts.push(wardName);
                }
                
                // Thêm tỉnh/thành phố (nếu có)
                if (provinceName && provinceName !== '') {
                    addressParts.push(provinceName);
                }
                
                // Chỉ tạo địa chỉ nếu có ít nhất 1 phần
                if (addressParts.length > 0) {
                    address = addressParts.join(', ');
                }
            }

            console.log('Collected address parts:', {
                detailAddress,
                wardName,
                provinceName,
                finalAddress: address
            });

            return {
                customerName: fullName,
                email,
                phoneNumber: phone,
                address,
                dateOfBirthString: collectDateOfBirth()
            };
        }

        async function handleProfileSubmit(e) {
            e.preventDefault();
            clearAlert();

            const payload = collectProfilePayload();
            // Không bắt buộc các trường - chỉ lưu những gì đã nhập

            const btn = $('#profileForm button[type=submit]');
            const original = btn.html();
            btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Đang lưu...');

            try {
                const response = await fetch(`${CUSTOMER_API_BASE}/${currentCustomerId}/profile`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data?.message || 'Không thể cập nhật thông tin');
                showAlert('success', data.message || 'Cập nhật thông tin thành công');
                disableProfileForm();
                loadCustomerData();
            } catch (err) {
                console.error(err);
                showAlert('danger', err.message || 'Không thể cập nhật thông tin');
            } finally {
                btn.prop('disabled', false).html(original);
            }
        }

        async function handlePasswordSubmit(e) {
            e.preventDefault();
            clearPasswordAlert();

            const current = $('input[name=current]').val()?.toString().trim();
            const newPwd = $('input[name=new]').val()?.toString().trim();
            const confirm = $('input[name=confirm]').val()?.toString().trim();

            if (!current || !newPwd || !confirm) {
                showPasswordAlert('danger', 'Vui lòng nhập đầy đủ thông tin mật khẩu');
                return;
            }
            if (newPwd !== confirm) {
                showPasswordAlert('danger', 'Mật khẩu mới và xác nhận không khớp');
                return;
            }
            if (newPwd.length < 6 || !/[A-Za-z]/.test(newPwd) || !/\d/.test(newPwd)) {
                showPasswordAlert('danger', 'Mật khẩu mới phải tối thiểu 6 ký tự và gồm cả chữ và số');
                return;
            }

            const btn = $('#passwordForm button[type=submit]');
            const original = btn.html();
            btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Đang cập nhật...');

            try {
                const response = await fetch(`${CUSTOMER_API_BASE}/${currentCustomerId}/password`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        currentPassword: current,
                        newPassword: newPwd,
                        confirmPassword: confirm
                    })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data?.message || 'Không thể đổi mật khẩu');
                showPasswordAlert('success', data.message || 'Đổi mật khẩu thành công');
                $('#passwordForm')[0].reset();
            } catch (err) {
                console.error(err);
                showPasswordAlert('danger', err.message || 'Không thể đổi mật khẩu');
            } finally {
                btn.prop('disabled', false).html(original);
            }
        }

        function handleToggleEdit() {
            const isEditing = $('#profileForm input:enabled').length > 0;
            if (isEditing) {
                disableProfileForm();
                loadCustomerData();
            } else {
                enableProfileForm();
                loadProvinces();
                $('#ward').prop('disabled', true);
            }
        }

        function handleLogout(e) {
            e.preventDefault();
            sessionStorage.removeItem('customer');
            sessionStorage.removeItem('isLoggedIn');
            // Xóa danh sách so sánh khi đăng xuất
            sessionStorage.removeItem('compareProducts');
            sessionStorage.removeItem('compareSelectedConfigs');
            // Cập nhật badge so sánh nếu có hàm
            if (typeof window.updateCompareBadge === 'function') {
                window.updateCompareBadge();
            }
            window.location.replace('/User/Login');
        }

        /* ------------ Orders helpers ------------ */
        function formatCurrency(value) {
            return (value ?? 0).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
        }

        function formatDate(value) {
            if (!value) return '';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return '';
            // Hiển thị cả ngày và giờ
            return date.toLocaleString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function buildStatusBadge(status) {
            if (!status) {
                return '<span class="badge bg-secondary text-white">Chưa xác định</span>';
            }
            
            // Giữ nguyên status từ database
            const statusText = status.toString().trim();
            const text = statusText.toLowerCase();
            console.log('Building status badge for:', statusText, '-> normalized:', text);
            
            // Xác định màu badge dựa trên status (so sánh với text đã lowercase)
            let badgeClass = 'bg-secondary text-white'; // Mặc định
            let inlineStyle = ''; // Style inline nếu cần
            
            // Kiểm tra "Đã hủy" trước tiên vì đây là trạng thái quan trọng cần hiển thị màu đỏ
            if (statusText.includes('Đã hủy')) {
                badgeClass = 'bg-danger text-white';
            } else if (statusText.includes('Chờ xử lý')) {
                badgeClass = 'bg-warning text-white';
            } else if (statusText.includes('Đang xử lý')) {
                badgeClass = 'bg-info text-white';
            } else if (statusText.includes('Chờ vận chuyển')) {
                badgeClass = 'text-white';
                inlineStyle = 'style="background-color: #e91e63;"';
            } else if (statusText.includes('Đang vận chuyển')) {
                badgeClass = 'bg-dark text-white';
            } else if (statusText.includes('Hoàn thành')) {
                badgeClass = 'bg-success text-white';
            }
            
            // Hiển thị đúng status từ database với màu badge tương ứng
            return `<span class="badge ${badgeClass}" ${inlineStyle}>${statusText}</span>`;
        }

        /* ------------ Orders ------------ */
        function renderLoadingState(selector) {
            const $body = $(selector);
            if (!$body.length) return;
            const isOrdersTab = selector === '#yourOrdersBody';
            const isHistoryTab = selector === '#orderHistoryBody';
            const colspan = (isOrdersTab || isHistoryTab) ? 6 : 5;
            $body.html(`<tr><td colspan="${colspan}" class="text-center text-muted">Đang tải dữ liệu...</td></tr>`);
        }

        // Helper function để lấy URL hình ảnh sản phẩm
        function getProductImageUrl(avatar) {
            if (!avatar || !avatar.trim()) {
                return '/imageProducts/default-laptop.jpg';
            }
            const apiBase = getDefaultApiBase();
            return `${apiBase}/imageProducts/${encodeURIComponent(avatar.trim())}`;
        }

        // Toggle hiển thị sản phẩm trong đơn hàng
        window.toggleOrderProducts = function(toggleId, totalProducts, maxVisible) {
            const hiddenDiv = document.getElementById(toggleId);
            const toggleBtn = document.querySelector(`[data-toggle-id="${toggleId}"]`);
            
            if (!hiddenDiv || !toggleBtn) {
                console.error('Cannot find toggle elements:', toggleId);
                return;
            }
            
            // Kiểm tra trạng thái hiện tại: nếu display là 'none' hoặc rỗng thì đang thu gọn
            const isExpanded = hiddenDiv.style.display !== 'none' && hiddenDiv.style.display !== '';
            
            if (isExpanded) {
                // Đang mở rộng -> Thu gọn lại (mũi tên chỉ lên khi đang mở)
                hiddenDiv.style.display = 'none';
                toggleBtn.innerHTML = `<i class="fa fa-chevron-down me-1"></i>Xem thêm ${totalProducts - maxVisible} sản phẩm`;
                toggleBtn.classList.remove('expanded');
            } else {
                // Đang thu gọn -> Mở rộng (mũi tên chỉ xuống khi đang thu)
                hiddenDiv.style.display = 'block';
                toggleBtn.innerHTML = `<i class="fa fa-chevron-up me-1"></i>Thu gọn`;
                toggleBtn.classList.add('expanded');
            }
        };

        function renderOrders(selector, orders, emptyMessage) {
            const $body = $(selector);
            if (!$body.length) return;
            const isOrdersTab = selector === '#yourOrdersBody';
            const isHistoryTab = selector === '#orderHistoryBody';
            const colspan = (isOrdersTab || isHistoryTab) ? 6 : 5;
            
            if (!orders || !orders.length) {
                $body.html(`<tr><td colspan="${colspan}" class="text-center text-muted">${emptyMessage}</td></tr>`);
                return;
            }

            const rows = orders.map(order => {
                const orderId = order.saleInvoiceId || order.SaleInvoiceId || '';
                const statusValue = order.status || order.Status || '';
                const statusText = statusValue.toString().trim().toLowerCase();
                
                // Xác định thời gian hiển thị dựa trên tab và trạng thái
                let displayDate;
                if (isHistoryTab) {
                    // Tab "Lịch sử mua hàng"
                    if (statusText.includes('Hoàn thành')) {
                        // Đơn hàng "Hoàn thành" → hiển thị TimeShip
                        displayDate = order.timeShip || order.TimeShip;
                    } else if (statusText.includes('Đã hủy')) {
                        // Đơn hàng "Đã hủy" → hiển thị TimeCreate (đã được cập nhật thành thời gian hủy)
                        displayDate = order.timeCreate || order.TimeCreate;
                    } else {
                        // Các trạng thái khác → hiển thị TimeCreate
                        displayDate = order.timeCreate || order.TimeCreate;
                    }
                } else {
                    // Tab "Đơn hàng của tôi"
                    if (statusText.includes('Đã hủy')) {
                        // Đơn hàng "Đã hủy" → hiển thị TimeCreate (đã được cập nhật thành thời gian hủy)
                        displayDate = order.timeCreate || order.TimeCreate;
                    } else {
                        // Các trạng thái khác → hiển thị TimeCreate (thời gian tạo đơn hàng)
                        displayDate = order.timeCreate || order.TimeCreate;
                    }
                }
                const date = formatDate(displayDate);
                const statusBadge = buildStatusBadge(statusValue);
                const total = formatCurrency(order.totalAmount || order.TotalAmount);
                const payload = {
                    saleInvoiceId: orderId,
                    date,
                    status: statusValue,
                    deliveryAddress: order.deliveryAddress || order.DeliveryAddress,
                    paymentMethod: order.paymentMethod || order.PaymentMethod,
                    deliveryFee: order.deliveryFee || order.DeliveryFee,
                    totalAmount: order.totalAmount || order.TotalAmount
                };

                // Lấy thông tin tất cả sản phẩm trong đơn hàng
                const products = order.products || order.Products || [];
                let productCell = '';
                
                if (products && products.length > 0) {
                    const maxVisibleProducts = 1; // Số sản phẩm hiển thị mặc định
                    const hasMoreProducts = products.length > maxVisibleProducts;
                    const visibleProducts = hasMoreProducts ? products.slice(0, maxVisibleProducts) : products;
                    const hiddenProductsCount = products.length - maxVisibleProducts;
                    
                    // Tạo unique ID cho toggle button
                    const toggleId = `toggle-products-${orderId}`;
                    
                    // Hiển thị sản phẩm
                    const renderProduct = (product, index, isLast) => {
                        const productName = product.productName || product.ProductName || 'N/A';
                        const productModel = product.productModel || product.ProductModel || '';
                        const specifications = product.specifications || product.Specifications || '';
                        const avatar = product.avatar || product.Avatar || '';
                        const quantity = product.quantity || product.Quantity || 1;
                        const productImageUrl = getProductImageUrl(avatar);
                        
                        // Tạo tên hiển thị: productName | productModel
                        let productDisplayName = productName;
                        if (productModel) {
                            productDisplayName = `${productName} | ${productModel}`;
                        }
                        
                        // Thêm số lượng nếu > 1
                        const quantityDisplay = quantity > 1 ? `<span class="badge bg-secondary ms-2">x${quantity}</span>` : '';
                        
                        // Thêm cấu hình nếu có
                        let configDisplay = '';
                        if (specifications && specifications.trim()) {
                            const formattedSpecs = specifications.trim();
                            configDisplay = `<div class="text-muted small mt-1" style="font-size: 0.85rem; line-height: 1.4;">${formattedSpecs}</div>`;
                        }
                        
                        const marginBottom = !isLast ? 'mb-3' : '';
                        
                        return `
                            <div class="d-flex align-items-start ${marginBottom} order-product-item">
                                <img src="${productImageUrl}" 
                                     alt="${productName}" 
                                     class="order-product-image me-3 flex-shrink-0" 
                                     onerror="this.onerror=null; this.src='/imageProducts/default-laptop.jpg';">
                                <div class="flex-grow-1 min-w-0">
                                    <div class="order-product-name fw-semibold mb-1 d-flex align-items-center">
                                        ${productDisplayName}
                                        ${quantityDisplay}
                                    </div>
                                    ${configDisplay}
                                </div>
                            </div>
                        `;
                    };
                    
                    // Sản phẩm hiển thị mặc định
                    const visibleProductsHtml = visibleProducts.map((product, index) => 
                        renderProduct(product, index, index === visibleProducts.length - 1 && !hasMoreProducts)
                    ).join('');
                    
                    // Sản phẩm ẩn (nếu có)
                    const hiddenProductsHtml = hasMoreProducts 
                        ? products.slice(maxVisibleProducts).map((product, index) => 
                            renderProduct(product, maxVisibleProducts + index, index === products.length - maxVisibleProducts - 1)
                          ).join('')
                        : '';
                    
                    // Nút toggle
                    const toggleButton = hasMoreProducts 
                        ? `<button type="button" class="btn btn-sm btn-link p-0 mt-2 text-primary toggle-products-btn" 
                                   data-toggle-id="${toggleId}" 
                                   data-order-id="${orderId}"
                                   onclick="window.toggleOrderProducts('${toggleId}', ${products.length}, ${maxVisibleProducts})">
                                <i class="fa fa-chevron-down me-1"></i>Xem thêm ${hiddenProductsCount} sản phẩm
                            </button>`
                        : '';
                    
                    productCell = `
                        <div class="order-products-list">
                            <div class="order-products-visible">${visibleProductsHtml}</div>
                            <div class="order-products-hidden" id="${toggleId}" style="display: none;">${hiddenProductsHtml}</div>
                            ${toggleButton}
                        </div>
                    `;
                } else {
                    // Fallback: kiểm tra firstProduct nếu API chưa cập nhật
                    const firstProduct = order.firstProduct || order.FirstProduct || null;
                    if (firstProduct) {
                        const productName = firstProduct.productName || firstProduct.ProductName || 'N/A';
                        const productModel = firstProduct.productModel || firstProduct.ProductModel || '';
                        const specifications = firstProduct.specifications || firstProduct.Specifications || '';
                        const avatar = firstProduct.avatar || firstProduct.Avatar || '';
                        const productImageUrl = getProductImageUrl(avatar);
                        
                        let productDisplayName = productName;
                        if (productModel) {
                            productDisplayName = `${productName} | ${productModel}`;
                        }
                        
                        let configDisplay = '';
                        if (specifications && specifications.trim()) {
                            const formattedSpecs = specifications.trim();
                            configDisplay = `<div class="text-muted small mt-1" style="font-size: 0.85rem; line-height: 1.4;">${formattedSpecs}</div>`;
                        }
                        
                        productCell = `
                            <div class="d-flex align-items-start">
                                <img src="${productImageUrl}" 
                                     alt="${productName}" 
                                     class="order-product-image me-3 flex-shrink-0" 
                                     onerror="this.onerror=null; this.src='/imageProducts/default-laptop.jpg';">
                                <div class="flex-grow-1 min-w-0">
                                    <div class="order-product-name fw-semibold mb-1">${productDisplayName}</div>
                                    ${configDisplay}
                                </div>
                            </div>
                        `;
                    } else {
                        productCell = '<span class="text-muted">N/A</span>';
                    }
                }

                // Chỉ hiển thị nút "Hủy đơn hàng" khi trạng thái là "Chờ xử lý"
                const canCancel = statusText.includes('chờ xử lý');
                const cancelButton = canCancel 
                    ? `<button class="btn btn-sm btn-outline-danger cancel-order" data-order-id="${orderId}">Hủy đơn hàng</button>`
                    : '';

                // Nếu là bảng đơn hàng (yourOrdersBody) hoặc lịch sử (orderHistoryBody), hiển thị cột sản phẩm
                if (isOrdersTab || isHistoryTab) {
                    return `
                        <tr data-order-json='${JSON.stringify(payload)}'>
                            <td class="text-center align-middle">#${orderId}</td>
                            <td class="align-middle">${productCell}</td>
                            <td class="text-center align-middle">${date}</td>
                            <td class="text-center align-middle">${statusBadge}</td>
                            <td class="text-center align-middle">${total}</td>
                            <td class="text-center align-middle">
                                <div class="d-flex flex-column gap-2 align-items-center justify-content-center">
                                    <button class="btn btn-sm btn-outline-primary view-order" data-order-id="${orderId}">Chi tiết</button>
                                    ${isOrdersTab ? cancelButton : ''}
                                </div>
                            </td>
                        </tr>`;
                } else {
                    // Fallback cho các bảng khác (nếu có)
                    return `
                        <tr data-order-json='${JSON.stringify(payload)}'>
                            <td>#${orderId}</td>
                            <td>${date}</td>
                            <td>${statusBadge}</td>
                            <td>${total}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary view-order" data-order-id="${orderId}">Chi tiết</button>
                            </td>
                        </tr>`;
                }
            });

            $body.html(rows.join(''));
        }

        // Hàm cập nhật số lượng đơn hàng trong menu sidebar
        function updateOrderCountBadge(orderCount) {
            const badge = document.getElementById('orderCountBadge');
            if (badge) {
                if (orderCount > 0) {
                    badge.textContent = orderCount;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        async function loadCustomerOrders() {
            if (!currentCustomerId) {
                console.warn('loadCustomerOrders: currentCustomerId is not available');
                return;
            }
            renderLoadingState('#yourOrdersBody');
            try {
                const response = await fetch(`${CUSTOMER_API_BASE}/${currentCustomerId}/orders`, { credentials: 'same-origin' });
                if (!response.ok) throw new Error('Không thể tải đơn hàng');
                const orders = await response.json();
                const orderCount = Array.isArray(orders) ? orders.length : 0;
                
                // Cập nhật badge số lượng đơn hàng trong menu
                updateOrderCountBadge(orderCount);
                
                renderOrders('#yourOrdersBody', orders, 'Chưa có đơn hàng nào');
                
                // Trigger event để cập nhật số lượng đơn hàng trong header
                $(document).trigger('orderUpdated');
                if (typeof window.updateOrderCount === 'function') {
                    window.updateOrderCount();
                }
                document.dispatchEvent(new Event('orderUpdated'));
            } catch (err) {
                console.error('loadCustomerOrders error:', err);
                renderOrders('#yourOrdersBody', [], 'Không thể tải đơn hàng');
                // Cập nhật badge về 0 khi có lỗi
                updateOrderCountBadge(0);
                
                // Vẫn trigger event để cập nhật (có thể không có đơn hàng)
                $(document).trigger('orderUpdated');
                if (typeof window.updateOrderCount === 'function') {
                    window.updateOrderCount();
                }
                document.dispatchEvent(new Event('orderUpdated'));
            }
        }

        async function loadCustomerHistory() {
            if (!currentCustomerId) {
                return;
            }
            renderLoadingState('#orderHistoryBody');
            try {
                const response = await fetch(`${CUSTOMER_API_BASE}/${currentCustomerId}/history`, { credentials: 'same-origin' });
                if (!response.ok) throw new Error('Không thể tải lịch sử mua hàng');
                const orders = await response.json();
                renderOrders('#orderHistoryBody', orders, 'Chưa có lịch sử mua hàng');
            } catch (err) {
                renderOrders('#orderHistoryBody', [], 'Không thể tải lịch sử');
            }
        }

        /* ------------ Order detail modal ------------ */
        function ensureOrderModal() {
            if (document.getElementById('orderDetailModal')) return;
            const modalHtml = `
                <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Chi tiết đơn hàng</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div id="orderDetailContent">Đang tải...</div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function buildOrderDetailHtml(order) {
            if (!order) return '<p class="text-muted text-center">Không có dữ liệu</p>';
            const items = Array.isArray(order.items)
                ? order.items
                : Array.isArray(order.Items)
                    ? order.Items
                    : [];

            const rows = items.length
                ? items.map(item => {
                    const productName = item.ProductName || item.productName || 'N/A';
                    const productModel = item.ProductModel || item.productModel || '';
                    const specifications = item.Specifications || item.specifications || '';
                    
                    // Tạo tên hiển thị: productName | productModel
                    let productDisplayName = productName;
                    if (productModel) {
                        productDisplayName = `${productName} | ${productModel}`;
                    }
                    
                    // Thêm cấu hình nếu có
                    let configDisplay = '';
                    if (specifications && specifications.trim()) {
                        configDisplay = `<div class="text-muted small mt-1" style="font-size: 0.85rem;">${specifications.trim()}</div>`;
                    }
                    
                    return `
                        <tr>
                            <td>
                                <div class="fw-semibold">${productDisplayName}</div>
                                ${configDisplay}
                            </td>
                            <td>${item.Quantity || item.quantity || 0}</td>
                            <td>${formatCurrency(item.UnitPrice || item.unitPrice)}</td>
                            <td>${formatCurrency(item.Subtotal || item.subtotal)}</td>
                        </tr>`;
                }).join('')
                : '<tr><td colspan="4" class="text-center text-muted">Không có sản phẩm</td></tr>';

            return `
                <div class="mb-3">
                    <p><strong>Mã đơn:</strong> ${order.SaleInvoiceId || order.saleInvoiceId}</p>
                    <p><strong>Trạng thái:</strong> ${buildStatusBadge(order.Status || order.status)}</p>
                    <p><strong>Thời gian:</strong> ${formatDate(order.TimeCreate || order.timeCreate)}</p>
                    <p><strong>Địa chỉ giao:</strong> ${order.DeliveryAddress || order.deliveryAddress || 'Chưa cập nhật'}</p>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Sản phẩm</th>
                                <th>Số lượng</th>
                                <th>Đơn giá</th>
                                <th>Tạm tính</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-end">
                    <div class="text-end">
                        <p class="mb-1"><strong>Phí giao hàng:</strong> +${formatCurrency(order.DeliveryFee || order.deliveryFee)}</p>
                         <p class="mb-1 text-success"><strong>Khuyến mại:</strong> -${formatCurrency(order.Discount || order.discount)}</p>
                        <p class="mb-0"><strong>Tổng cộng:</strong> ${formatCurrency(order.TotalAmount || order.totalAmount)}</p>
                    </div>
                </div>`;
        }

        async function handleViewOrder(e) {
            e.preventDefault();
            const orderId = $(this).data('order-id');
            if (!orderId) return;
            ensureOrderModal();
            const modalEl = document.getElementById('orderDetailModal');
            const contentEl = document.getElementById('orderDetailContent');
            if (!modalEl || !contentEl) return;
            contentEl.innerHTML = '<div class="text-center text-muted py-3">Đang tải...</div>';

            try {
                const response = await fetch(`${CUSTOMER_API_BASE}/order/${orderId}`, { credentials: 'same-origin' });
                if (!response.ok) throw new Error('Không thể tải chi tiết đơn hàng');
                const order = await response.json();
                contentEl.innerHTML = buildOrderDetailHtml(order);
            } catch (err) {
                console.error('handleViewOrder error:', err);
                contentEl.innerHTML = `<div class="text-danger">${err.message || 'Có lỗi xảy ra'}</div>`;
            }

            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        }

        async function handleCancelOrder(e) {
            e.preventDefault();
            const orderId = $(this).data('order-id');
            if (!orderId) {
                showNotificationToast('Mã đơn hàng không hợp lệ', 'danger');
                return;
            }

            const $btn = $(this);
            
            // Hiển thị toast xác nhận thay vì confirm dialog
            showConfirmationToast(
                `Bạn có chắc chắn muốn hủy đơn hàng #${orderId} không?<br><small class="text-muted">Hành động này không thể hoàn tác.</small>`,
                async () => {
                    // Callback khi xác nhận hủy
                    const originalText = $btn.html();
                    $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Đang xử lý...');

                    try {
                        const response = await fetch(`${CUSTOMER_API_BASE}/order/${orderId}/cancel`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'same-origin'
                        });

                        const responseText = await response.text();
                        let data = null;
                        if (responseText) {
                            try {
                                data = JSON.parse(responseText);
                            } catch (parseError) {
                                console.error('Failed to parse response:', responseText);
                            }
                        }

                        if (!response.ok) {
                            const errorMessage = data?.message || responseText || `Lỗi ${response.status}: ${response.statusText}`;
                            throw new Error(errorMessage);
                        }

                        // Hiển thị thông báo thành công bằng toast
                        showNotificationToast(data?.message || `Hủy đơn hàng #${orderId} thành công`, 'success');
                        
                        // Reload danh sách đơn hàng (sẽ tự động cập nhật badge)
                        setTimeout(() => {
                            loadCustomerOrders();
                        }, 1000);
                    } catch (err) {
                        showNotificationToast(err.message || 'Không thể hủy đơn hàng. Vui lòng thử lại sau.', 'danger');
                    } finally {
                        $btn.prop('disabled', false).html(originalText);
                    }
                },
                () => {
                    // Callback khi hủy bỏ (không làm gì)
                    console.log('Hủy bỏ thao tác hủy đơn hàng');
                }
            );
        }

        // Kiểm tra URL parameters và hiển thị thông báo thành công
        function checkSuccessMessage() {
            const urlParams = new URLSearchParams(window.location.search);
            const success = urlParams.get('success');
            const message = urlParams.get('message');
            const orderId = urlParams.get('orderId');
            
            if (success === 'true') {
                let successMessage = 'Thao tác thành công!';
                if (message) {
                    successMessage = decodeURIComponent(message);
                }
                if (orderId) {
                    successMessage += ` Mã đơn hàng: #${orderId}`;
                }
                
                // Hiển thị toast notification ở góc trên bên phải
                showSuccessToast(successMessage);
                
                // Xóa parameters khỏi URL sau khi hiển thị
                const newUrl = window.location.pathname + window.location.hash;
                window.history.replaceState({}, document.title, newUrl);
            }
        }

        // Hàm hiển thị toast notification ở góc trên bên phải
        function showSuccessToast(message) {
            const toastId = 'success-toast-' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="toast-notification success-toast" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header bg-success text-white">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong class="me-auto">Thông báo</strong>
                        <button type="button" class="btn-close btn-close-white" onclick="closeToast('${toastId}')" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;
            
            // Tạo container nếu chưa có
            if ($('#success-toast-container').length === 0) {
                $('body').append('<div id="success-toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>');
            }
            
            $('#success-toast-container').append(toastHtml);
            
            // Hiển thị toast với animation
            const $toast = $(`#${toastId}`);
            $toast.addClass('show');
            
            // Tự động ẩn sau 5 giây
            setTimeout(() => {
                closeToast(toastId);
            }, 5000);
        }

        // Hàm đóng toast
        function closeToast(toastId) {
            const $toast = $(`#${toastId}`);
            $toast.removeClass('show').addClass('hide');
            setTimeout(() => {
                $toast.remove();
            }, 300);
        }

        // Hàm hiển thị toast xác nhận (confirmation)
        function showConfirmationToast(message, onConfirm, onCancel) {
            const toastId = 'confirm-toast-' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="toast-notification confirm-toast" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header bg-warning text-dark">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong class="me-auto">Xác nhận</strong>
                        <button type="button" class="btn-close confirm-close-btn" data-toast-id="${toastId}" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">
                        <p class="mb-3">${message}</p>
                        <div class="d-flex gap-2 justify-content-end">
                            <button type="button" class="btn btn-sm btn-secondary confirm-cancel-btn" data-toast-id="${toastId}">Hủy bỏ</button>
                            <button type="button" class="btn btn-sm btn-danger confirm-ok-btn" data-toast-id="${toastId}">Xác nhận</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Tạo overlay và container nếu chưa có
            if ($('#confirm-overlay').length === 0) {
                $('body').append('<div id="confirm-overlay" class="confirm-overlay position-fixed top-0 start-0 w-100 h-100" style="z-index: 10000; background: rgba(0,0,0,0.5); display: none;"></div>');
            }
            if ($('#confirm-toast-container').length === 0) {
                $('body').append('<div id="confirm-toast-container" class="toast-container position-fixed top-50 start-50 translate-middle" style="z-index: 10001;"></div>');
            }
            
            // Hiển thị overlay
            $('#confirm-overlay').fadeIn(200);
            
            $('#confirm-toast-container').append(toastHtml);
            
            // Hiển thị toast với animation
            const $toast = $(`#${toastId}`);
            setTimeout(() => {
                $toast.addClass('show');
            }, 10);
            
            // Lưu callback functions
            window[`confirmCallback_${toastId}`] = onConfirm;
            window[`cancelCallback_${toastId}`] = onCancel;
            
            // Thêm event listeners cho các nút
            $toast.find('.confirm-ok-btn').on('click', function() {
                closeConfirmToast(toastId, true);
            });
            
            $toast.find('.confirm-cancel-btn, .confirm-close-btn').on('click', function() {
                closeConfirmToast(toastId, false);
            });
        }

        // Hàm đóng toast xác nhận
        function closeConfirmToast(toastId, confirmed) {
            const $toast = $(`#${toastId}`);
            $toast.removeClass('show').addClass('hide');
            
            // Ẩn overlay
            $('#confirm-overlay').fadeOut(200);
            
            setTimeout(() => {
                $toast.remove();
                
                // Gọi callback tương ứng
                if (confirmed && window[`confirmCallback_${toastId}`]) {
                    window[`confirmCallback_${toastId}`]();
                } else if (!confirmed && window[`cancelCallback_${toastId}`]) {
                    window[`cancelCallback_${toastId}`]();
                }
                
                // Cleanup callbacks
                delete window[`confirmCallback_${toastId}`];
                delete window[`cancelCallback_${toastId}`];
            }, 300);
        }

        // Hàm hiển thị toast thông báo thành công (có thể dùng chung)
        function showNotificationToast(message, type = 'success') {
            const toastId = `${type}-toast-` + Date.now();
            const iconMap = {
                'success': 'fas fa-check-circle',
                'danger': 'fas fa-times-circle',
                'warning': 'fas fa-exclamation-triangle',
                'info': 'fas fa-info-circle'
            };
            const bgMap = {
                'success': 'bg-success',
                'danger': 'bg-danger', 
                'warning': 'bg-warning',
                'info': 'bg-info'
            };
            
            const toastHtml = `
                <div id="${toastId}" class="toast-notification ${type}-toast" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header ${bgMap[type]} text-white">
                        <i class="${iconMap[type]} me-2"></i>
                        <strong class="me-auto">Thông báo</strong>
                        <button type="button" class="btn-close btn-close-white" onclick="closeToast('${toastId}')" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;
            
            // Tạo container nếu chưa có
            if ($('#notification-toast-container').length === 0) {
                $('body').append('<div id="notification-toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>');
            }
            
            $('#notification-toast-container').append(toastHtml);
            
            // Hiển thị toast với animation
            const $toast = $(`#${toastId}`);
            $toast.addClass('show');
            
            // Tự động ẩn sau 4 giây
            setTimeout(() => {
                closeToast(toastId);
            }, 4000);
        }

        // Initialize - Đảm bảo jQuery đã sẵn sàng
        $(document).ready(function () {
            console.log('Account page initialized');
            
            // Kiểm tra lại đăng nhập
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');
            const customer = sessionStorage.getItem('customer');
            if (!isLoggedIn || isLoggedIn !== 'true' || !customer) {
                window.location.replace('/User/Login');
                return;
            }
            
            if (!currentCustomerId) {
                console.error('currentCustomerId is null');
                showAlert('danger', 'Không tìm thấy thông tin khách hàng. Vui lòng đăng nhập lại.');
                setTimeout(function() {
                    window.location.replace('/User/Login');
                }, 2000);
                return;
            }
            
            // Kiểm tra thông báo thành công từ URL
            checkSuccessMessage();
            
            loadBirthDropdowns();
            clearAlert();
            loadCustomerData();
            loadCustomerOrders();
            loadCustomerHistory();
            
            // Xử lý URL parameter để chuyển đến tab cụ thể
            const urlParams = new URLSearchParams(window.location.search);
            const tabParam = urlParams.get('tab');
            if (tabParam === 'orders') {
                // Chuyển đến tab "Đơn hàng của bạn"
                setTimeout(function() {
                    const ordersTab = document.querySelector('a[href="#tab-your-orders"]');
                    if (ordersTab) {
                        // Kích hoạt tab
                        const tab = new bootstrap.Tab(ordersTab);
                        tab.show();
                        
                        // Cuộn đến tab với hiệu ứng
                        ordersTab.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        
                        // Thêm hiệu ứng highlight tạm thời
                        ordersTab.style.backgroundColor = '#fff3cd';
                        ordersTab.style.transition = 'background-color 0.3s ease';
                        setTimeout(function() {
                            ordersTab.style.backgroundColor = '';
                        }, 2000);
                        
                        // Xóa parameter khỏi URL để tránh reload lại tab
                        const newUrl = window.location.pathname;
                        window.history.replaceState({}, document.title, newUrl);
                        
                        console.log('Đã chuyển đến tab Đơn hàng của bạn từ header');
                    }
                }, 1000); // Đợi 1 giây để đảm bảo tất cả đã load xong
            }
            
            // Trigger event để cập nhật số lượng đơn hàng trong header sau khi load
            setTimeout(function() {
                $(document).trigger('orderUpdated');
                if (typeof window.updateOrderCount === 'function') {
                    window.updateOrderCount();
                }
                document.dispatchEvent(new Event('orderUpdated'));
            }, 500);

            $('#toggleEditProfile').on('click', handleToggleEdit);
            $('#profileForm').on('submit', handleProfileSubmit);
            $('#passwordForm').on('submit', handlePasswordSubmit);
            $('#btnLogout').on('click', handleLogout);
            $(document).on('click', '.view-order', handleViewOrder);
            $(document).on('click', '.cancel-order', handleCancelOrder);
            
            // Xử lý sự kiện chuyển tab để load lại dữ liệu
            $('a[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
                const targetTab = $(e.target).attr('href');
                
                // Nếu chuyển sang tab "Đơn hàng của bạn", load lại dữ liệu
                if (targetTab === '#tab-your-orders') {
                    loadCustomerOrders();
                }
                // Nếu chuyển sang tab "Lịch sử mua hàng", load lại dữ liệu
                else if (targetTab === '#tab-history') {
                    loadCustomerHistory();
                }
            });
            
            // Xử lý upload avatar
            $('#btnUploadAvatar').on('click', function() {
                $('#avatarInput').click();
            });
            
            $('#avatarInput').on('change', async function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // Kiểm tra loại file
                if (!file.type.startsWith('image/')) {
                    showToast('danger', 'Chỉ chấp nhận file ảnh');
                    $(this).val('');
                    return;
                }
                
                // Kiểm tra kích thước (10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showToast('danger', 'Kích thước file không được vượt quá 10MB');
                    $(this).val('');
                    return;
                }
                
                // Hiển thị preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    $('#avatarImg').attr('src', e.target.result);
                };
                reader.readAsDataURL(file);
                
                // Upload lên server
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    const apiBase = window.CUSTOMER_API_BASE || 'http://localhost:5068/api/CustomerAccount';
                    const response = await fetch(`${apiBase}/${currentCustomerId}/avatar`, {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin'
                    });
                    
                    const responseText = await response.text();
                    let data = {};
                    if (responseText && responseText.trim()) {
                        try {
                            data = JSON.parse(responseText);
                        } catch (parseErr) {
                            console.error('JSON parse error:', parseErr);
                        }
                    }
                    
                    if (response.ok) {
                        showToast('success', data.message || 'Cập nhật avatar thành công');
                        // Cập nhật lại avatar trong sessionStorage nếu có
                        if (data.avatar) {
                            const customer = JSON.parse(sessionStorage.getItem('customer') || '{}');
                            customer.avatar = data.avatar;
                            customer.Avatar = data.avatar;
                            sessionStorage.setItem('customer', JSON.stringify(customer));
                        }
                        // Reload customer info để cập nhật avatar
                        await loadCustomerData();
                    } else {
                        showToast('danger', data.message || 'Không thể cập nhật avatar');
                        // Khôi phục avatar cũ
                        await loadCustomerData();
                    }
                } catch (err) {
                    console.error('Upload avatar error:', err);
                    showToast('danger', 'Lỗi khi upload avatar');
                    // Khôi phục avatar cũ
                    await loadCustomerInfo();
                } finally {
                    $(this).val('');
                }
            });
        });
    })(jQuery);
</script>
<style>
    /* Autocomplete styling */
    .autocomplete-wrapper {
        width: 100%;
        display: block;
        position: relative;
    }

    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid #d2d6da;
        border-radius: 0.375rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        margin-top: 2px;
        display: none;
    }

    .autocomplete-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
        border-bottom: 1px solid #f0f0f0;
    }

    .autocomplete-item:last-child {
        border-bottom: none;
    }

    .autocomplete-item:hover,
    .autocomplete-item.selected {
        background-color: #f8f9fa;
        color: #0d6efd;
    }

    .autocomplete-item:first-child {
        border-top-left-radius: 0.375rem;
        border-top-right-radius: 0.375rem;
    }

    .autocomplete-item:last-child {
        border-bottom-left-radius: 0.375rem;
        border-bottom-right-radius: 0.375rem;
    }
    
    /* Badge số lượng đơn hàng trong menu */
    #orderCountBadge {
        font-weight: 600;
        min-width: 18px;
        height: 18px;
        line-height: 1.2;
        padding: 2px 5px !important;
        display: flex;
        align-items: center;
        justify-content: center;
        top: -8px !important;
        left: 8px !important;
        transform: translate(0, 0) !important;
    }
    
    .account-menu .nav-link {
        position: relative;
    }
    
    .account-menu .nav-link i.fa-shopping-cart {
        position: relative;
    }

    /* Success Toast Notification Styles */
    .toast-container {
        z-index: 9999;
        pointer-events: none;
    }
    
    .toast-container .toast-notification {
        pointer-events: auto;
    }
    
    #confirm-toast-container {
        z-index: 10001 !important;
        pointer-events: none;
    }
    
    #confirm-toast-container .confirm-toast {
        pointer-events: auto;
    }
    
    .success-toast {
        min-width: 350px;
        max-width: 450px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        margin-bottom: 15px;
        border: none;
        border-radius: 8px;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease-in-out;
    }
    
    .success-toast.show {
        opacity: 1;
        transform: translateX(0);
    }
    
    .success-toast.hide {
        opacity: 0;
        transform: translateX(100%);
    }
    
    .success-toast .toast-header {
        background: linear-gradient(135deg, #28a745, #20c997);
        border-bottom: none;
        border-radius: 8px 8px 0 0;
        font-weight: 600;
        padding: 12px 16px;
    }
    
    .success-toast .toast-body {
        padding: 16px;
        font-size: 14px;
        line-height: 1.5;
        background: #fff;
        border-radius: 0 0 8px 8px;
    }
    
    /* Toast Notification Styles với nền trắng */
    .toast-notification {
        min-width: 300px;
        max-width: 400px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 10px;
        background-color: #ffffff;
    }
    
    .toast-notification .toast-header {
        font-weight: 600;
    }
    
    .toast-notification .toast-body {
        padding: 0.75rem;
        background-color: #ffffff;
    }
    
    .toast-success .toast-header {
        background-color: #28a745 !important;
    }
    
    .toast-danger .toast-header {
        background-color: #dc3545 !important;
    }
    
    .toast-warning .toast-header {
        background-color: #ffc107 !important;
        color: #000 !important;
    }
    
    .toast-info .toast-header {
        background-color: #17a2b8 !important;
    }
    
    .success-toast .btn-close {
        font-size: 12px;
        opacity: 0.8;
    }
    
    .success-toast .btn-close:hover {
        opacity: 1;
    }

    /* Confirmation Toast Styles */
    .confirm-toast {
        min-width: 400px;
        max-width: 500px;
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
        border: none;
        border-radius: 12px;
        opacity: 0;
        transform: scale(0.8);
        transition: all 0.3s ease-in-out;
        pointer-events: auto;
        position: relative;
        z-index: 10002;
    }
    
    .confirm-toast.show {
        opacity: 1;
        transform: scale(1);
    }
    
    .confirm-toast.hide {
        opacity: 0;
        transform: scale(0.8);
    }
    
    .confirm-toast .toast-header {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
        border-bottom: none;
        border-radius: 12px 12px 0 0;
        font-weight: 600;
        padding: 16px 20px;
    }
    
    .confirm-toast .toast-body {
        padding: 20px;
        background: #fff;
        border-radius: 0 0 12px 12px;
    }
    
    .confirm-toast .toast-body p {
        margin-bottom: 16px;
        line-height: 1.5;
    }

    /* General Toast Notification Styles */
    .danger-toast, .warning-toast, .info-toast {
        min-width: 350px;
        max-width: 450px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        margin-bottom: 15px;
        border: none;
        border-radius: 8px;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease-in-out;
    }
    
    .danger-toast.show, .warning-toast.show, .info-toast.show {
        opacity: 1;
        transform: translateX(0);
    }
    
    .danger-toast.hide, .warning-toast.hide, .info-toast.hide {
        opacity: 0;
        transform: translateX(100%);
    }
    
    .danger-toast .toast-header {
        background: linear-gradient(135deg, #dc3545, #c82333);
    }
    
    .warning-toast .toast-header {
        background: linear-gradient(135deg, #ffc107, #e0a800);
        color: #000 !important;
    }
    
    .info-toast .toast-header {
        background: linear-gradient(135deg, #17a2b8, #138496);
    }
</style>
}