@{
    ViewData["Title"] = "Thông tin tài khoản";
    Layout = "~/Views/Shared/_LayoutAccount.cshtml";
}
<!-- Kiểm tra đăng nhập ngay đầu trang (không cần jQuery) -->
<script>
    (function() {
        'use strict';
        try {
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');
            const customer = sessionStorage.getItem('customer');
            if (!isLoggedIn || isLoggedIn !== 'true' || !customer) {
                window.location.replace('/User/Login');
            }
        } catch (err) {
            console.error('Session storage check failed:', err);
            window.location.replace('/User/Login');
        }
    })();
</script>

<div class="pt-5"></div>
<div class="container py-5">
    <div class="row g-4">
      <!-- Sidebar tài khoản -->
      <aside class="col-lg-3">
        <div class="card shadow-sm account-sidebar">
          <div class="card-body text-center">
            <div class="avatar-preview mx-auto mb-3">
              <img id="avatarImg" src="../LaptopFe/img/avatar.jpg" alt="avatar" class="rounded-circle" style="width:96px;height:96px;object-fit:cover; border:3px solid rgba(129,196,8,0.12);">
            </div>
            <h5 id="userName">Tên khách hàng</h5>
            <p class="text-muted small mb-3">username</p>
            <button class="btn btn-outline-secondary btn-sm w-100 mb-2" id="btnUploadAvatar"><i class="fas fa-camera"></i> Thay ảnh</button>
            <input id="avatarInput" type="file" accept="image/*" style="display:none">

            <hr>

            <nav class="nav flex-column account-menu">
              <a href="#tab-profile" class="nav-link active" data-bs-toggle="tab"><i class="fas fa-user-edit me-2"></i> Thông tin cá nhân</a>
              <a href="#tab-your-orders" class="nav-link" data-bs-toggle="tab"><i class="fas fa-shopping-cart me-2"></i> Đơn hàng của bạn</a>
              <a href="#tab-history" class="nav-link" data-bs-toggle="tab"><i class="fas fa-box-open me-2"></i> Lịch sử mua hàng</a>
              <a href="#" class="nav-link text-danger" id="btnLogout"><i class="fas fa-sign-out-alt me-2"></i> Đăng xuất</a>
            </nav>
          </div>
        </div>
      </aside>

      <main class="col-lg-9">
        <div class="card shadow-sm">
          <div class="card-body tab-content">
            <div id="accountAlert" class="alert d-none" role="alert"></div>

            <!-- Thông tin cá nhân -->
            <div class="tab-pane fade show active" id="tab-profile">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">Thông tin cá nhân</h4>
                <button id="toggleEditProfile" class="btn btn-outline-secondary btn-sm">Chỉnh sửa</button>
              </div>
              <form id="profileForm">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label small">Họ và tên</label>
                    <input type="text" name="fullname" class="form-control" placeholder="Nguyễn Văn A" disabled required>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label small">Ngày sinh</label>
                    <div class="d-flex">
                      <select id="birthDay" class="form-select me-1" disabled required></select>
                      <select id="birthMonth" class="form-select me-1" disabled required></select>
                      <select id="birthYear" class="form-select" disabled required></select>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label small">Email</label>
                    <input type="email" name="email" class="form-control" placeholder="email@example.com" disabled required>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label small">Số điện thoại</label>
                    <input type="text" name="phone" class="form-control" placeholder="0987654321" disabled required>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label small">Tỉnh / Thành phố</label>
                    <div class="autocomplete-wrapper position-relative">
                      <input type="text" id="province" class="form-control" autocomplete="off" placeholder="Tìm kiếm tỉnh/thành phố..." disabled required>
                      <input type="hidden" id="provinceValue" value="">
                      <div id="provinceDropdown" class="autocomplete-dropdown"></div>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label small">Xã / Phường</label>
                    <div class="autocomplete-wrapper position-relative">
                      <input type="text" id="ward" class="form-control" autocomplete="off" placeholder="Tìm kiếm xã/phường..." disabled required>
                      <input type="hidden" id="wardValue" value="">
                      <div id="wardDropdown" class="autocomplete-dropdown"></div>
                    </div>
                  </div>

                  <div class="col-12">
                    <label class="form-label small">Địa chỉ chi tiết</label>
                    <input type="text" id="detailAddress" class="form-control" placeholder="Số nhà, đường..." disabled required>
                  </div>

                  <div class="col-12 text-end">
                    <button type="submit" class="btn btn-primary" disabled>Lưu thay đổi</button>
                  </div>
                </div>
              </form>

              <hr class="my-4">

              <h5>Đổi mật khẩu</h5>
              <div id="passwordAlert" class="alert d-none" role="alert"></div>
              <form id="passwordForm" class="row g-3 mt-2">
                <div class="col-md-6">
                  <label class="form-label small">Mật khẩu hiện tại</label>
                  <input type="password" name="current" class="form-control" placeholder="Nhập mật khẩu hiện tại" required>
                </div>
                <div class="col-md-6"></div>
                <div class="col-md-6">
                  <label class="form-label small">Mật khẩu mới</label>
                  <input type="password" name="new" class="form-control" placeholder="Nhập mật khẩu mới" required>
                  <small class="text-muted">Tối thiểu 6 ký tự, gồm chữ và số</small>
                </div>
                <div class="col-md-6">
                  <label class="form-label small">Xác nhận mật khẩu mới</label>
                  <input type="password" name="confirm" class="form-control" placeholder="Nhập lại mật khẩu mới" required>
                </div>
                <div class="col-12 text-end">
                  <button type="submit" class="btn btn-success">Cập nhật mật khẩu</button>
                </div>
              </form>
            </div>

            <!-- Đơn hàng của bạn -->
            <div class="tab-pane fade" id="tab-your-orders">
              <h4>Đơn hàng của bạn</h4>
              <div class="table-responsive mt-3">
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Mã đơn hàng</th>
                      <th>Ngày đặt</th>
                      <th>Trạng thái</th>
                      <th>Tổng</th>
                      <th>Hành động</th>
                    </tr>
                  </thead>
                  <tbody id="yourOrdersBody">
                    <tr>
                      <td colspan="5" class="text-center text-muted">Đang tải dữ liệu...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Lịch sử mua hàng (chỉ 'hoàn thành') -->
            <div class="tab-pane fade" id="tab-history">
              <h4>Lịch sử mua hàng</h4>
              <div class="table-responsive mt-3">
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Mã đơn</th>
                      <th>Ngày</th>
                      <th>Trạng thái</th>
                      <th>Tổng tiền</th>
                      <th>Hành động</th>
                    </tr>
                  </thead>
                  <tbody id="orderHistoryBody">
                    <tr>
                      <td colspan="5" class="text-center text-muted">Đang tải dữ liệu...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Modal (tĩnh) -->
  <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Chi tiết đơn hàng</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="orderDetailContent"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        </div>
      </div>
    </div>
  </div>

@section Scripts {
<script>
    (function ($) {
        'use strict';
        
        // Cấu hình API
        const getDefaultApiBase = () => {
            if (window.CUSTOMER_API_BASE && window.CUSTOMER_API_BASE.trim()) {
                return window.CUSTOMER_API_BASE.trim();
            }
            if (window.location && window.location.origin) {
                const origin = window.location.origin;
                if (!origin.includes('localhost')) {
                    return origin;
                }
            }
            return 'http://localhost:5068';
        };

        const API_BASE = getDefaultApiBase();
        const CUSTOMER_API_BASE = `${API_BASE}/api/CustomerAccount`;
        const ADDRESS_API_BASE = window.ADDRESS_API_BASE || `${API_BASE}/api/Address`;

        // Lấy customerId từ session
        function resolveSessionCustomerId() {
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');
            const raw = sessionStorage.getItem('customer');
            if (isLoggedIn !== 'true' || !raw) return null;
            try {
                const parsed = JSON.parse(raw);
                return parsed.customerId || parsed.CustomerId || null;
            } catch (err) {
                console.error('Cannot parse customer info', err);
                return null;
            }
        }

        const currentCustomerId = resolveSessionCustomerId();
        if (!currentCustomerId) {
            window.location.replace('/User/Login');
            return;
        }

        // Biến global
        let provinces = [];
        const wardsCache = new Map();
        const $accountAlert = $('#accountAlert');
        const $passwordAlert = $('#passwordAlert');

        // Helper functions
        function showAlert(type, message) {
            if (!$accountAlert.length) return;
            $accountAlert
                .removeClass('d-none alert-success alert-danger alert-warning alert-info')
                .addClass(`alert-${type}`)
                .text(message);
        }

        function clearAlert() {
            if (!$accountAlert.length) return;
            $accountAlert.addClass('d-none').text('');
        }

        function showPasswordAlert(type, message) {
            if (!$passwordAlert.length) return;
            $passwordAlert
                .removeClass('d-none alert-success alert-danger alert-warning alert-info')
                .addClass(`alert-${type}`)
                .text(message);
        }

        function clearPasswordAlert() {
            if (!$passwordAlert.length) return;
            $passwordAlert.addClass('d-none').text('');
        }

        // Date of birth helpers
        function loadBirthDropdowns() {
            const $day = $('#birthDay');
            const $month = $('#birthMonth');
            const $year = $('#birthYear');
            if (!$day.length || !$month.length || !$year.length) return;

            $day.empty().append('<option value="">Ngày</option>');
            $month.empty().append('<option value="">Tháng</option>');
            $year.empty().append('<option value="">Năm</option>');

            for (let d = 1; d <= 31; d++) $day.append(new Option(d, d));
            for (let m = 1; m <= 12; m++) $month.append(new Option(m, m));

            const currentYear = new Date().getFullYear();
            for (let y = currentYear; y >= 1900; y--) $year.append(new Option(y, y));
        }

        function setDateOfBirth(value) {
            if (!value) {
                $('#birthDay, #birthMonth, #birthYear').val('');
                return;
            }
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return;
            $('#birthDay').val(date.getDate());
            $('#birthMonth').val(date.getMonth() + 1);
            $('#birthYear').val(date.getFullYear());
        }

        function collectDateOfBirth() {
            const day = $('#birthDay').val();
            const month = $('#birthMonth').val();
            const year = $('#birthYear').val();
            if (!day || !month || !year) return null;
            return `${year.toString().padStart(4, '0')}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        }

        // Address helpers
        async function loadProvinces(force = false) {
            if (provinces.length && !force) {
                initializeProvinceAutocomplete();
                return provinces;
            }
            try {
                console.log('Loading provinces from:', `${ADDRESS_API_BASE}/provinces`);
                const response = await fetch(`${ADDRESS_API_BASE}/provinces`, { 
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Province API error:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('Provinces data received:', data);
                
                const list = Array.isArray(data) ? data : [];
                provinces = list.map(item => ({
                    code: String(item.code || item.provinceCode || item.id || '').trim(),
                    name: String(item.name || item.provinceName || '').trim()
                })).filter(p => p.code && p.name);

                console.log('Processed provinces:', provinces.length);
                initializeProvinceAutocomplete();
                return provinces;
            } catch (err) {
                console.error('loadProvinces error:', err);
                showAlert('danger', 'Không thể tải danh sách tỉnh/thành phố. Vui lòng thử lại sau.');
                return [];
            }
        }

        // Load wards trực tiếp từ province code (sau sáp nhập, chỉ còn 2 cấp)
        async function loadWardsByProvince(provinceCode) {
            const $ward = $('#ward');
            if (!$ward.length) return;
            $ward.prop('disabled', true).val('').attr('placeholder', 'Đang tải...');
            $('#wardValue').val('');
            
            if (!provinceCode) {
                $ward.prop('disabled', true).val('').attr('placeholder', 'Tìm kiếm xã/phường...');
                return;
            }

            // Kiểm tra cache
            if (wardsCache.has(provinceCode)) {
                initializeWardAutocomplete(wardsCache.get(provinceCode));
                return;
            }

            try {
                console.log('Loading wards for province:', provinceCode);
                const response = await fetch(`${ADDRESS_API_BASE}/wards/${provinceCode}`, { 
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Ward API error:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('Wards data received:', data);
                
                const list = Array.isArray(data) ? data : [];
                const wards = list.map(w => ({
                    code: String(w.code || w.id || '').trim(),
                    name: String(w.name || w.wardName || '').trim()
                })).filter(w => w.code && w.name);
                
                console.log('Processed wards:', wards.length);
                wardsCache.set(provinceCode, wards);
                initializeWardAutocomplete(wards);
            } catch (err) {
                console.error('loadWards error:', err);
                $ward.prop('disabled', true).val('').attr('placeholder', 'Không thể tải xã/phường');
            }
        }

        // Khởi tạo autocomplete cho tỉnh/thành
        function initializeProvinceAutocomplete() {
            const provinceInput = $('#province');
            const provinceValue = $('#provinceValue');
            const dropdown = $('#provinceDropdown');
            let selectedIndex = -1;
            let filteredProvinces = [];

            function showDropdown(provincesList) {
                if (!provincesList || provincesList.length === 0) {
                    dropdown.html('<div class="autocomplete-item" style="color: #6c757d; cursor: default;">Không tìm thấy tỉnh/thành</div>').show();
                    selectedIndex = -1;
                    return;
                }

                let html = '';
                provincesList.forEach((province, index) => {
                    const provinceName = province.name || province.code;
                    const provinceNameEscaped = (provinceName || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    html += `<div class="autocomplete-item" data-index="${index}" data-province-code="${province.code}" data-province-name="${provinceNameEscaped}">${provinceName}</div>`;
                });
                dropdown.html(html).show();
                selectedIndex = -1;
            }

            function updateSelectedItem() {
                $('#provinceDropdown .autocomplete-item').removeClass('selected');
                if (selectedIndex >= 0 && selectedIndex < filteredProvinces.length) {
                    $('#provinceDropdown .autocomplete-item').eq(selectedIndex).addClass('selected');
                }
            }

            // Xử lý khi gõ
            provinceInput.off('input.province').on('input.province', function() {
                const searchTerm = $(this).val().toLowerCase().trim();
                
                if (searchTerm === '') {
                    dropdown.hide();
                    provinceValue.val('');
                    $('#ward').prop('disabled', true).val('').attr('placeholder', 'Tìm kiếm xã/phường...');
                    $('#wardValue').val('');
                    return;
                }

                filteredProvinces = provinces.filter(p => {
                    const provinceName = (p.name || p.code || '').toLowerCase();
                    return provinceName.includes(searchTerm);
                });

                showDropdown(filteredProvinces);
            });

            // Xử lý khi click vào item
            $(document).off('click.province-item').on('click.province-item', '#provinceDropdown .autocomplete-item', function() {
                const provinceCode = $(this).data('province-code');
                const provinceName = $(this).data('province-name');
                
                if (provinceCode && provinceName) {
                    provinceInput.val(provinceName);
                    provinceValue.val(provinceCode);
                    dropdown.hide();
                    loadWardsByProvince(provinceCode);
                }
            });

            // Xử lý phím tắt
            provinceInput.off('keydown.province').on('keydown.province', function(e) {
                if (dropdown.is(':visible') && filteredProvinces.length > 0) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        selectedIndex = Math.min(selectedIndex + 1, filteredProvinces.length - 1);
                        updateSelectedItem();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        selectedIndex = Math.max(selectedIndex - 1, -1);
                        updateSelectedItem();
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (selectedIndex >= 0 && selectedIndex < filteredProvinces.length) {
                            const province = filteredProvinces[selectedIndex];
                            provinceInput.val(province.name || province.code);
                            provinceValue.val(province.code);
                            dropdown.hide();
                            loadWardsByProvince(province.code);
                        }
                    } else if (e.key === 'Escape') {
                        dropdown.hide();
                        selectedIndex = -1;
                    }
                }
            });

            // Ẩn dropdown khi click ra ngoài
            $(document).off('click.province-close').on('click.province-close', function(e) {
                if (!$(e.target).closest('#province').closest('.autocomplete-wrapper').length) {
                    dropdown.hide();
                    selectedIndex = -1;
                }
            });

            // Xử lý khi focus vào input
            provinceInput.off('focus.province').on('focus.province', function() {
                const val = $(this).val().trim();
                if (val) {
                    $(this).trigger('input.province');
                } else {
                    if (provinces.length > 0) {
                        filteredProvinces = provinces;
                        showDropdown(filteredProvinces);
                    }
                }
            });
        }

        // Khởi tạo autocomplete cho phường/xã
        function initializeWardAutocomplete(wardsList) {
            const wardInput = $('#ward');
            const wardValue = $('#wardValue');
            const dropdown = $('#wardDropdown');
            let selectedIndex = -1;
            let filteredWards = [];

            if (!wardsList || wardsList.length === 0) {
                wardInput.prop('disabled', true).val('').attr('placeholder', 'Không có dữ liệu');
                return;
            }

            wardInput.prop('disabled', false).attr('placeholder', 'Tìm kiếm xã/phường...');

            function showDropdown(wards) {
                if (!wards || wards.length === 0) {
                    dropdown.html('<div class="autocomplete-item" style="color: #6c757d; cursor: default;">Không tìm thấy xã/phường</div>').show();
                    selectedIndex = -1;
                    return;
                }

                let html = '';
                wards.forEach((ward, index) => {
                    const wardName = ward.name || ward.code;
                    const wardNameEscaped = (wardName || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    html += `<div class="autocomplete-item" data-index="${index}" data-ward-code="${ward.code}" data-ward-name="${wardNameEscaped}">${wardName}</div>`;
                });
                dropdown.html(html).show();
                selectedIndex = -1;
            }

            function updateSelectedItem() {
                $('#wardDropdown .autocomplete-item').removeClass('selected');
                if (selectedIndex >= 0 && selectedIndex < filteredWards.length) {
                    $('#wardDropdown .autocomplete-item').eq(selectedIndex).addClass('selected');
                }
            }

            // Xử lý khi gõ
            wardInput.off('input.ward').on('input.ward', function() {
                const searchTerm = $(this).val().toLowerCase().trim();
                
                if (searchTerm === '') {
                    dropdown.hide();
                    wardValue.val('');
                    return;
                }

                filteredWards = wardsList.filter(w => {
                    const wardName = (w.name || w.code || '').toLowerCase();
                    return wardName.includes(searchTerm);
                });

                showDropdown(filteredWards);
            });

            // Xử lý khi click vào item
            $(document).off('click.ward-item').on('click.ward-item', '#wardDropdown .autocomplete-item', function() {
                const wardCode = $(this).data('ward-code');
                const wardName = $(this).data('ward-name');
                
                if (wardCode && wardName) {
                    wardInput.val(wardName);
                    wardValue.val(wardCode);
                    dropdown.hide();
                }
            });

            // Xử lý phím tắt
            wardInput.off('keydown.ward').on('keydown.ward', function(e) {
                if (dropdown.is(':visible') && filteredWards.length > 0) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        selectedIndex = Math.min(selectedIndex + 1, filteredWards.length - 1);
                        updateSelectedItem();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        selectedIndex = Math.max(selectedIndex - 1, -1);
                        updateSelectedItem();
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (selectedIndex >= 0 && selectedIndex < filteredWards.length) {
                            const ward = filteredWards[selectedIndex];
                            wardInput.val(ward.name || ward.code);
                            wardValue.val(ward.code);
                            dropdown.hide();
                        }
                    } else if (e.key === 'Escape') {
                        dropdown.hide();
                        selectedIndex = -1;
                    }
                }
            });

            // Ẩn dropdown khi click ra ngoài
            $(document).off('click.ward-close').on('click.ward-close', function(e) {
                if (!$(e.target).closest('#ward').closest('.autocomplete-wrapper').length) {
                    dropdown.hide();
                    selectedIndex = -1;
                }
            });

            // Xử lý khi focus vào input
            wardInput.off('focus.ward').on('focus.ward', function() {
                const val = $(this).val().trim();
                if (val) {
                    $(this).trigger('input.ward');
                } else {
                    if (wardsList.length > 0) {
                        filteredWards = wardsList;
                        showDropdown(filteredWards);
                    }
                }
            });
        }

        // Customer profile functions
        async function loadCustomerData() {
            if (!currentCustomerId) {
                showAlert('danger', 'Không tìm thấy thông tin khách hàng. Vui lòng đăng nhập lại.');
                return;
            }
            try {
                // Đảm bảo provinces đã được load trước
                await loadProvinces();
                
                const url = `${CUSTOMER_API_BASE}/${currentCustomerId}`;
                const response = await fetch(url, { credentials: 'same-origin' });
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage = 'Không thể tải thông tin khách hàng';
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }
                const data = await response.json();
                await populateProfileForm(data);
            } catch (err) {
                console.error('loadCustomerData error:', err);
                showAlert('danger', err.message || 'Không thể tải thông tin khách hàng');
            }
        }

        // Parse địa chỉ từ chuỗi đầy đủ
        function parseAddress(fullAddress) {
            if (!fullAddress || typeof fullAddress !== 'string') {
                return { detailAddress: '', provinceName: '', wardName: '' };
            }

            const parts = fullAddress.split(',').map(p => p.trim()).filter(p => p);
            if (parts.length === 0) {
                return { detailAddress: fullAddress, provinceName: '', wardName: '' };
            }

            let detailAddress = '';
            let wardName = '';
            let provinceName = '';

            // Phần cuối thường là tỉnh/thành phố
            if (parts.length >= 1) {
                provinceName = parts[parts.length - 1];
            }
            // Phần giữa thường là phường/xã
            if (parts.length >= 2) {
                wardName = parts[parts.length - 2];
            }
            // Phần đầu là địa chỉ chi tiết
            if (parts.length >= 3) {
                detailAddress = parts.slice(0, parts.length - 2).join(', ');
            } else if (parts.length === 2) {
                detailAddress = parts[0];
            } else {
                detailAddress = parts[0];
            }

            return {
                detailAddress: detailAddress,
                provinceName: provinceName,
                wardName: wardName
            };
        }

        // Tìm province code từ tên
        function findProvinceCode(provinceName) {
            if (!provinceName || provinces.length === 0) return '';
            const matchedProvince = provinces.find(p => 
                p.name.toLowerCase().includes(provinceName.toLowerCase()) ||
                provinceName.toLowerCase().includes(p.name.toLowerCase())
            );
            return matchedProvince ? matchedProvince.code : '';
        }

        // Tìm ward code từ tên (sau khi wards đã được load)
        function findWardCode(wardName, provinceCode) {
            if (!wardName || !provinceCode || !wardsCache.has(provinceCode)) return '';
            const wards = wardsCache.get(provinceCode);
            const matchedWard = wards.find(w =>
                w.name.toLowerCase().includes(wardName.toLowerCase()) ||
                wardName.toLowerCase().includes(w.name.toLowerCase())
            );
            return matchedWard ? matchedWard.code : '';
        }

        async function populateProfileForm(customer) {
            $('input[name=fullname]').val(customer?.customerName || customer?.CustomerName || '');
            $('input[name=email]').val(customer?.email || customer?.Email || '');
            $('input[name=phone]').val(customer?.phoneNumber || customer?.PhoneNumber || '');
            setDateOfBirth(customer?.dateOfBirth || customer?.DateOfBirth);

            const avatar = customer?.avatar || customer?.Avatar || '../LaptopFe/img/avatar.jpg';
            $('#avatarImg').attr('src', avatar).on('error', function() {
                $(this).attr('src', '../LaptopFe/img/avatar.jpg');
            });
            $('#userName').text(customer?.customerName || customer?.CustomerName || 'Tên khách hàng');
            $('.text-muted.small').first().text(customer?.username || customer?.Username || 'username');

            // Parse và điền địa chỉ
            const fullAddress = customer?.address || customer?.Address || '';
            if (fullAddress) {
                const parsed = parseAddress(fullAddress);
                $('#detailAddress').val(parsed.detailAddress);
                
                if (parsed.provinceName) {
                    const provinceCode = findProvinceCode(parsed.provinceName);
                    if (provinceCode) {
                        const province = provinces.find(p => p.code === provinceCode);
                        if (province) {
                            $('#province').val(province.name);
                            $('#provinceValue').val(provinceCode);
                        }
                        // Load wards cho province này
                        await loadWardsByProvince(provinceCode);
                        // Sau khi load xong, tìm và set ward code
                        if (parsed.wardName) {
                            const wardCode = findWardCode(parsed.wardName, provinceCode);
                            if (wardCode) {
                                const wards = wardsCache.get(provinceCode);
                                const ward = wards?.find(w => w.code === wardCode);
                                if (ward) {
                                    $('#ward').val(ward.name);
                                    $('#wardValue').val(wardCode);
                                }
                            }
                        }
                    } else {
                        // Nếu không tìm thấy code, vẫn hiển thị tên
                        $('#province').val(parsed.provinceName);
                    }
                }
            } else {
                $('#detailAddress').val('');
            }

            disableProfileForm();
        }

        function disableProfileForm() {
            $('#profileForm input, #profileForm select, #profileForm button[type=submit]').prop('disabled', true);
            $('#toggleEditProfile').text('Chỉnh sửa');
        }

        function enableProfileForm() {
            $('#profileForm input, #profileForm select, #profileForm button[type=submit]').prop('disabled', false);
            $('#toggleEditProfile').text('Hủy');
        }

        function collectProfilePayload() {
            const fullName = $('input[name=fullname]').val()?.toString().trim();
            const email = $('input[name=email]').val()?.toString().trim();
            const phone = $('input[name=phone]').val()?.toString().trim();
            const detailAddress = $('#detailAddress').val()?.toString().trim();
            const provinceName = $('#province').val()?.toString().trim();
            const wardName = $('#ward').val()?.toString().trim();

            let address = detailAddress || '';
            if (wardName && wardName !== '') {
                address = address ? `${address}, ${wardName}` : wardName;
            }
            if (provinceName && provinceName !== '') {
                address = address ? `${address}, ${provinceName}` : provinceName;
            }

            return {
                customerName: fullName,
                email,
                phoneNumber: phone,
                address,
                dateOfBirthString: collectDateOfBirth()
            };
        }

        async function handleProfileSubmit(e) {
            e.preventDefault();
            clearAlert();

            const payload = collectProfilePayload();
            if (!payload.customerName || !payload.email || !payload.phoneNumber) {
                showAlert('danger', 'Vui lòng nhập đầy đủ thông tin bắt buộc.');
                return;
            }

            const btn = $('#profileForm button[type=submit]');
            const original = btn.html();
            btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Đang lưu...');

            try {
                const response = await fetch(`${CUSTOMER_API_BASE}/${currentCustomerId}/profile`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data?.message || 'Không thể cập nhật thông tin');
                showAlert('success', data.message || 'Cập nhật thông tin thành công');
                disableProfileForm();
                loadCustomerData();
            } catch (err) {
                console.error(err);
                showAlert('danger', err.message || 'Không thể cập nhật thông tin');
            } finally {
                btn.prop('disabled', false).html(original);
            }
        }

        async function handlePasswordSubmit(e) {
            e.preventDefault();
            clearPasswordAlert();

            const current = $('input[name=current]').val()?.toString().trim();
            const newPwd = $('input[name=new]').val()?.toString().trim();
            const confirm = $('input[name=confirm]').val()?.toString().trim();

            if (!current || !newPwd || !confirm) {
                showPasswordAlert('danger', 'Vui lòng nhập đầy đủ thông tin mật khẩu');
                return;
            }
            if (newPwd !== confirm) {
                showPasswordAlert('danger', 'Mật khẩu mới và xác nhận không khớp');
                return;
            }
            if (newPwd.length < 6 || !/[A-Za-z]/.test(newPwd) || !/\d/.test(newPwd)) {
                showPasswordAlert('danger', 'Mật khẩu mới phải tối thiểu 6 ký tự và gồm cả chữ và số');
                return;
            }

            const btn = $('#passwordForm button[type=submit]');
            const original = btn.html();
            btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Đang cập nhật...');

            try {
                const response = await fetch(`${CUSTOMER_API_BASE}/${currentCustomerId}/password`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        currentPassword: current,
                        newPassword: newPwd,
                        confirmPassword: confirm
                    })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data?.message || 'Không thể đổi mật khẩu');
                showPasswordAlert('success', data.message || 'Đổi mật khẩu thành công');
                $('#passwordForm')[0].reset();
            } catch (err) {
                console.error(err);
                showPasswordAlert('danger', err.message || 'Không thể đổi mật khẩu');
            } finally {
                btn.prop('disabled', false).html(original);
            }
        }

        function handleToggleEdit() {
            const isEditing = $('#profileForm input:enabled').length > 0;
            if (isEditing) {
                disableProfileForm();
                loadCustomerData();
            } else {
                enableProfileForm();
                loadProvinces();
                $('#ward').prop('disabled', true);
            }
        }

        function handleLogout(e) {
            e.preventDefault();
            sessionStorage.removeItem('customer');
            sessionStorage.removeItem('isLoggedIn');
            window.location.replace('/User/Login');
        }

        /* ------------ Orders helpers ------------ */
        function formatCurrency(value) {
            return (value ?? 0).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
        }

        function formatDate(value) {
            if (!value) return '';
            const date = new Date(value);
            return Number.isNaN(date.getTime()) ? '' : date.toLocaleDateString('vi-VN');
        }

        function buildStatusBadge(status) {
            if (!status) {
                return '<span class="badge bg-secondary">Chưa xác định</span>';
            }
            
            const text = status.toString().trim().toLowerCase();
            console.log('Building status badge for:', status, '-> normalized:', text);
            
            // Kiểm tra các trạng thái phổ biến
            if (text.includes('đang xử lý') || text.includes('processing') || text.includes('pending') || text.includes('chờ xử lý')) {
                return '<span class="badge bg-warning text-dark">Đang xử lý</span>';
            }
            if (text.includes('đã gửi') || text.includes('shipped') || text.includes('đang giao') || text.includes('delivering')) {
                return '<span class="badge bg-info text-dark">Đã gửi</span>';
            }
            if (text.includes('hoàn thành') || text.includes('completed') || text.includes('done') || text.includes('finished')) {
                return '<span class="badge bg-success text-white">Hoàn thành</span>';
            }
            if (text.includes('đã hủy') || text.includes('canceled') || text.includes('cancelled') || text.includes('hủy')) {
                return '<span class="badge bg-danger text-white">Đã hủy</span>';
            }
            if (text.includes('chờ thanh toán') || text.includes('pending payment') || text.includes('waiting payment')) {
                return '<span class="badge bg-warning text-dark">Chờ thanh toán</span>';
            }
            if (text.includes('đã xác nhận') || text.includes('confirmed')) {
                return '<span class="badge bg-primary text-white">Đã xác nhận</span>';
            }
            
            // Nếu không khớp, trả về trạng thái gốc với badge secondary
            return `<span class="badge bg-secondary">${status}</span>`;
        }

        /* ------------ Orders ------------ */
        function renderLoadingState(selector) {
            const $body = $(selector);
            if (!$body.length) return;
            $body.html('<tr><td colspan="5" class="text-center text-muted">Đang tải dữ liệu...</td></tr>');
        }

        function renderOrders(selector, orders, emptyMessage) {
            const $body = $(selector);
            if (!$body.length) return;
            if (!orders || !orders.length) {
                $body.html(`<tr><td colspan="5" class="text-center text-muted">${emptyMessage}</td></tr>`);
                return;
            }

            const rows = orders.map(order => {
                const orderId = order.saleInvoiceId || order.SaleInvoiceId || '';
                const date = formatDate(order.timeCreate || order.TimeCreate);
                const statusValue = order.status || order.Status || '';
                console.log('Order status for', orderId, ':', statusValue);
                const statusBadge = buildStatusBadge(statusValue);
                const total = formatCurrency(order.totalAmount || order.TotalAmount);
                const payload = {
                    saleInvoiceId: orderId,
                    date,
                    status: statusValue,
                    deliveryAddress: order.deliveryAddress || order.DeliveryAddress,
                    paymentMethod: order.paymentMethod || order.PaymentMethod,
                    deliveryFee: order.deliveryFee || order.DeliveryFee,
                    totalAmount: order.totalAmount || order.TotalAmount
                };

                return `
                    <tr data-order-json='${JSON.stringify(payload)}'>
                        <td>#${orderId}</td>
                        <td>${date}</td>
                        <td>${statusBadge}</td>
                        <td>${total}</td>
                        <td><button class="btn btn-sm btn-outline-primary view-order" data-order-id="${orderId}">Chi tiết</button></td>
                    </tr>`;
            });

            $body.html(rows.join(''));
        }

        async function loadCustomerOrders() {
            if (!currentCustomerId) {
                console.warn('loadCustomerOrders: currentCustomerId is not available');
                return;
            }
            renderLoadingState('#yourOrdersBody');
            try {
                const response = await fetch(`${CUSTOMER_API_BASE}/${currentCustomerId}/orders`, { credentials: 'same-origin' });
                if (!response.ok) throw new Error('Không thể tải đơn hàng');
                const orders = await response.json();
                renderOrders('#yourOrdersBody', orders, 'Chưa có đơn hàng nào');
            } catch (err) {
                console.error('loadCustomerOrders error:', err);
                renderOrders('#yourOrdersBody', [], 'Không thể tải đơn hàng');
            }
        }

        async function loadCustomerHistory() {
            if (!currentCustomerId) {
                console.warn('loadCustomerHistory: currentCustomerId is not available');
                return;
            }
            renderLoadingState('#orderHistoryBody');
            try {
                const response = await fetch(`${CUSTOMER_API_BASE}/${currentCustomerId}/history`, { credentials: 'same-origin' });
                if (!response.ok) throw new Error('Không thể tải lịch sử mua hàng');
                const orders = await response.json();
                renderOrders('#orderHistoryBody', orders, 'Chưa có lịch sử mua hàng');
            } catch (err) {
                console.error('loadCustomerHistory error:', err);
                renderOrders('#orderHistoryBody', [], 'Không thể tải lịch sử');
            }
        }

        /* ------------ Order detail modal ------------ */
        function ensureOrderModal() {
            if (document.getElementById('orderDetailModal')) return;
            const modalHtml = `
                <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Chi tiết đơn hàng</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div id="orderDetailContent">Đang tải...</div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function buildOrderDetailHtml(order) {
            if (!order) return '<p class="text-muted text-center">Không có dữ liệu</p>';
            const items = Array.isArray(order.items)
                ? order.items
                : Array.isArray(order.Items)
                    ? order.Items
                    : [];

            const rows = items.length
                ? items.map(item => `
                    <tr>
                        <td>${item.ProductName || item.productName || 'N/A'}</td>
                        <td>${item.Quantity || item.quantity || 0}</td>
                        <td>${formatCurrency(item.UnitPrice || item.unitPrice)}</td>
                        <td>${formatCurrency(item.Subtotal || item.subtotal)}</td>
                    </tr>`).join('')
                : '<tr><td colspan="4" class="text-center text-muted">Không có sản phẩm</td></tr>';

            return `
                <div class="mb-3">
                    <p><strong>Mã đơn:</strong> ${order.SaleInvoiceId || order.saleInvoiceId}</p>
                    <p><strong>Trạng thái:</strong> ${buildStatusBadge(order.Status || order.status)}</p>
                    <p><strong>Thời gian:</strong> ${formatDate(order.TimeCreate || order.timeCreate)}</p>
                    <p><strong>Địa chỉ giao:</strong> ${order.DeliveryAddress || order.deliveryAddress || 'Chưa cập nhật'}</p>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Sản phẩm</th>
                                <th>Số lượng</th>
                                <th>Đơn giá</th>
                                <th>Tạm tính</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-end">
                    <div class="text-end">
                        <p class="mb-1"><strong>Phí giao hàng:</strong> ${formatCurrency(order.DeliveryFee || order.deliveryFee)}</p>
                        <p class="mb-0"><strong>Tổng cộng:</strong> ${formatCurrency(order.TotalAmount || order.totalAmount)}</p>
                    </div>
                </div>`;
        }

        async function handleViewOrder(e) {
            e.preventDefault();
            const orderId = $(this).data('order-id');
            if (!orderId) return;
            ensureOrderModal();
            const modalEl = document.getElementById('orderDetailModal');
            const contentEl = document.getElementById('orderDetailContent');
            if (!modalEl || !contentEl) return;
            contentEl.innerHTML = '<div class="text-center text-muted py-3">Đang tải...</div>';

            try {
                const response = await fetch(`${CUSTOMER_API_BASE}/order/${orderId}`, { credentials: 'same-origin' });
                if (!response.ok) throw new Error('Không thể tải chi tiết đơn hàng');
                const order = await response.json();
                contentEl.innerHTML = buildOrderDetailHtml(order);
            } catch (err) {
                console.error('handleViewOrder error:', err);
                contentEl.innerHTML = `<div class="text-danger">${err.message || 'Có lỗi xảy ra'}</div>`;
            }

            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        }

        // Initialize - Đảm bảo jQuery đã sẵn sàng
        $(document).ready(function () {
            console.log('Account page initialized');
            
            // Kiểm tra lại đăng nhập
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');
            const customer = sessionStorage.getItem('customer');
            if (!isLoggedIn || isLoggedIn !== 'true' || !customer) {
                window.location.replace('/User/Login');
                return;
            }
            
            if (!currentCustomerId) {
                console.error('currentCustomerId is null');
                showAlert('danger', 'Không tìm thấy thông tin khách hàng. Vui lòng đăng nhập lại.');
                setTimeout(function() {
                    window.location.replace('/User/Login');
                }, 2000);
                return;
            }
            
            loadBirthDropdowns();
            clearAlert();
            loadCustomerData();
            loadCustomerOrders();
            loadCustomerHistory();

            $('#toggleEditProfile').on('click', handleToggleEdit);
            $('#profileForm').on('submit', handleProfileSubmit);
            $('#passwordForm').on('submit', handlePasswordSubmit);
            $('#btnLogout').on('click', handleLogout);
            $(document).on('click', '.view-order', handleViewOrder);
        });
    })(jQuery);
</script>
<style>
    /* Autocomplete styling */
    .autocomplete-wrapper {
        width: 100%;
        display: block;
        position: relative;
    }

    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid #d2d6da;
        border-radius: 0.375rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        margin-top: 2px;
        display: none;
    }

    .autocomplete-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
        border-bottom: 1px solid #f0f0f0;
    }

    .autocomplete-item:last-child {
        border-bottom: none;
    }

    .autocomplete-item:hover,
    .autocomplete-item.selected {
        background-color: #f8f9fa;
        color: #0d6efd;
    }

    .autocomplete-item:first-child {
        border-top-left-radius: 0.375rem;
        border-top-right-radius: 0.375rem;
    }

    .autocomplete-item:last-child {
        border-bottom-left-radius: 0.375rem;
        border-bottom-right-radius: 0.375rem;
    }
</style>
}