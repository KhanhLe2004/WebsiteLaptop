@startuml

hide footbox
skinparam defaultFontName Helvetica
skinparam defaultFontSize 12
skinparam maxMessageSize 500
skinparam ParticipantPadding 100

skinparam backgroundColor white
skinparam shadowing false
skinparam ActorBackgroundColor transparent
skinparam ParticipantBackgroundColor transparent
skinparam SequenceGroupBackgroundColor transparent
skinparam SequenceBoxBackgroundColor transparent
skinparam NoteBackgroundColor transparent

skinparam SequenceActivationBorderColor black
skinparam ActorBorderColor black
skinparam ParticipantBorderColor black
skinparam ArrowColor black
skinparam roundcorner 0

actor "Khách hàng" as CUSTOMER
participant "Frontend (User Web)" as FE
participant "ProductReviewAPIController" as API
database "Database" as DB

' Kiểm tra có thể đánh giá
CUSTOMER -> FE : Xem trang sản phẩm
FE -> API : GET /api/ProductReviewAPI/check-purchase/{customerId}/{productId}
API -> API : Validate customerId, productId not empty
API -> DB : SELECT saleInvoices WHERE CustomerId AND Status IN ("Hoàn thành", "Đã giao")
API -> DB : JOIN SaleInvoiceDetails WHERE ProductId
API -> API : Check hasPurchased = Any()
API --> FE : 200 OK + (hasPurchased)
FE --> CUSTOMER : Hiển thị nút "Đánh giá" (nếu hasPurchased=true)

' Tạo đánh giá
CUSTOMER -> FE : Nhập Rate (1-5) + ContentDetail\nNhấn "Gửi đánh giá"
FE -> API : POST /api/ProductReviewAPI/create
API -> API : Validate request not null
API -> API : Validate CustomerId, ProductId, Rate (1-5), ContentDetail not empty
alt Validation không hợp lệ
  API --> FE : 400 Bad Request + error message
  FE --> CUSTOMER : "Vui lòng kiểm tra lại thông tin"
else Validation hợp lệ
  API -> DB : SELECT customer WHERE CustomerId AND Active=true
  alt Customer không tồn tại hoặc không active
    API --> FE : 404 Not Found ("Không tìm thấy thông tin khách hàng")
    FE --> CUSTOMER : "Vui lòng đăng nhập lại"
  else Customer tồn tại
    API -> DB : SELECT product WHERE ProductId AND Active=true
    alt Product không tồn tại hoặc không active
      API --> FE : 404 Not Found ("Không tìm thấy sản phẩm")
      FE --> CUSTOMER : "Sản phẩm không tồn tại"
    else Product tồn tại
      API -> DB : SELECT saleInvoices WHERE CustomerId AND Status IN ("Hoàn thành", "Đã giao")
      API -> DB : JOIN SaleInvoiceDetails WHERE ProductId
      API -> API : Check hasPurchased = Any()
      alt Chưa mua sản phẩm
        API --> FE : 400 Bad Request ("Bạn chỉ có thể đánh giá sản phẩm đã mua")
        FE --> CUSTOMER : "Bạn chưa mua sản phẩm này"
      else Đã mua sản phẩm
        API -> API : GenerateProductReviewId() (format PRV001, PRV002...)
        API -> DB : SELECT productReviews ORDER BY ProductReviewId DESC (get lastId)
        API -> API : Calculate nextId = "PRV{number+1:D3}"
        API -> DB : INSERT ProductReviews (ProductReviewId, CustomerId, ProductId, Rate, ContentDetail, Time=Now)
        API -> DB : SaveChanges
        API -> DB : SELECT productReview WHERE ProductReviewId (Include Customer)
        DB --> API : createdReview
        API --> FE : 200 OK + (message, review with Customer info)
        FE --> CUSTOMER : "Đánh giá đã được gửi thành công!"\nReload reviews
      end
    end
  end
end

FE --> CUSTOMER : Hiển thị đánh giá mới

@enduml

