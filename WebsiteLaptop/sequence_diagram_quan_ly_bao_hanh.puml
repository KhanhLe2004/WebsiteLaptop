@startuml

hide footbox
skinparam defaultFontName Helvetica
skinparam defaultFontSize 12
skinparam maxMessageSize 500
skinparam ParticipantPadding 100

skinparam backgroundColor white
skinparam shadowing false
skinparam ActorBackgroundColor transparent
skinparam ParticipantBackgroundColor transparent
skinparam SequenceGroupBackgroundColor transparent
skinparam SequenceBoxBackgroundColor transparent
skinparam NoteBackgroundColor transparent

skinparam SequenceActivationBorderColor black
skinparam ActorBorderColor black
skinparam ParticipantBorderColor black
skinparam ArrowColor black
skinparam roundcorner 0

actor "Chủ cửa hàng" as OWNER
participant "Frontend (Admin Web)" as FE
participant "ManageWarrantyAPIController" as API
database "Database" as DB

' 1) Mở màn quản lý
OWNER -> FE : Chọn "Quản lý bảo hành"
FE -> API : GET /api/admin/warranties
API -> DB : SELECT warranties (Include Customer, Employee, Serial, filter, pagination)
DB --> API : warrantyList
API --> FE : 200 OK + list
FE --> OWNER : Hiển thị danh sách

' 2) Thao tác: Thêm / Sửa
alt Thêm bảo hành
  OWNER -> FE : Nhập thông tin\nNhấn "Lưu"
  FE -> API : POST /api/admin/warranties
  API -> API : Validate + GenerateWarrantyId()
  alt Hợp lệ
    alt Type = "Bảo hành"
      API -> API : Validate CustomerId + SerialId required
      API -> API : Set TotalAmount = 0
    else Type = "Sửa chữa"
      alt Không có CustomerId + có CustomerName
        API -> API : GenerateCustomerId()
        API -> DB : INSERT Customers (new customer)
        API -> API : Set customerId = newCustomerId
      end
      API -> API : Set SerialId = null
    end
    API -> DB : INSERT Warranties
    API -> API : LogHistory("Thêm bảo hành")
    API --> FE : 201 Created + WarrantyDTO
    FE --> OWNER : Thông báo "Thành công"\nReload
  else Không hợp lệ
    API --> FE : 400 + errors
    FE --> OWNER : "Vui lòng nhập lại"
  end

else Cập nhật bảo hành
  OWNER -> FE : Chọn bảo hành\nSửa\nNhấn "Lưu"
  FE -> API : PUT /api/admin/warranties/{id}
  API -> DB : SELECT warranty WHERE id
  API -> API : Validate
  alt Hợp lệ
    alt Status = "Hoàn thành" hoặc "Đã hủy"
      API --> FE : 400 Bad Request (không cho sửa)
      FE --> OWNER : "Không thể chỉnh sửa"
    else Status khác
      alt Type = "Bảo hành"
        API -> API : Set TotalAmount = 0
      else Type = "Sửa chữa"
        alt Không có CustomerId + có CustomerName
          API -> API : GenerateCustomerId()
          API -> DB : INSERT Customers (new customer)
          API -> API : Set customerId = newCustomerId
        end
        API -> API : Set SerialId = null
      end
      API -> DB : UPDATE Warranties
      API -> API : LogHistory("Cập nhật bảo hành")
      API --> FE : 200 OK
      FE --> OWNER : "Thành công"\nReload
    end
  else Không hợp lệ
    API --> FE : 400 + errors
    FE --> OWNER : "Vui lòng nhập lại"
  end
end

FE --> OWNER : Hiển thị danh sách

@enduml

